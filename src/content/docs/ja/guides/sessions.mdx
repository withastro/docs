---
title: ã‚»ãƒƒã‚·ãƒ§ãƒ³
description: ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒšãƒ¼ã‚¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“ã§ãƒ‡ãƒ¼ã‚¿ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã®æ–¹æ³•ã€‚
i18nReady: true
---

import Since from '~/components/Since.astro';
import ReadMore from '~/components/ReadMore.astro';

<p>
<Since v="5.7.0" />
</p>

ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã€[ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒšãƒ¼ã‚¸](/ja/guides/on-demand-rendering/)ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“ã§ãƒ‡ãƒ¼ã‚¿ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã®æ–¹æ³•ã§ã™ã€‚

[`cookies`](/ja/guides/on-demand-rendering/#cookies)ã¨ã¯ç•°ãªã‚Šã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã‚µãƒ¼ãƒãƒ¼ã§ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã€ã‚ˆã‚Šå¤§ããªãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã¾ãŸã€ã‚µã‚¤ã‚ºåˆ¶é™ã‚„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®å•é¡Œã‚‚æ°—ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã€ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ã‚«ãƒ¼ãƒˆã€ãƒ•ã‚©ãƒ¼ãƒ ã®çŠ¶æ…‹ãªã©ã‚’ä¿å­˜ã™ã‚‹ã®ã«ä¾¿åˆ©ã§ã™ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®JavaScriptã‚’ä½¿ã‚ãªã„ã§æ©Ÿèƒ½ã—ã¾ã™ã€‚

```astro title="src/components/CartButton.astro" {3}
---
export const prerender = false; // 'server'å‡ºåŠ›ã®å ´åˆã¯ä¸è¦
const cart = await Astro.session?.get('cart');
---

<a href="/checkout">ğŸ›’ {cart?.length ?? 0} ç‚¹</a>
```

## ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®è¨­å®š

ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ã«ã¯ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ãŒå¿…è¦ã§ã™ã€‚[Node](/ja/guides/integrations-guide/node/#sessions)ãƒ»[Cloudflare](/ja/guides/integrations-guide/cloudflare/#sessions)ãƒ»[Netlify](/ja/guides/integrations-guide/netlify/#sessions) ã®å„ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã‚’è‡ªå‹•çš„ã«è¨­å®šã—ã¾ã™ã€‚ã—ã‹ã—ã€ãã®ä»–ã®ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã§ã¯ [ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã‚’æ‰‹å‹•ã§æŒ‡å®š](/ja/reference/configuration-reference/#sessiondriver)ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```js title="astro.config.mjs" ins={4}
  {
    adapter: vercel(),
    session: {
      driver: "redis",
    },
  }
```

<ReadMore>
  ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã®è¨­å®šæ–¹æ³•ã‚„ãã®ä»–ã®è¨­å®šé …ç›®ã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€[sessionè¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³](/ja/reference/configuration-reference/#session-options)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
</ReadMore>

## ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’æ“ä½œã™ã‚‹

[`session`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ](/ja/reference/api-reference/#session) ã‚’ä½¿ã†ã¨ã€ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹ï¼ˆä¾‹ï¼šã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ã‚«ãƒ¼ãƒˆã¸ã®å•†å“ã®è¿½åŠ ï¼‰ã‚„ã‚»ãƒƒã‚·ãƒ§ãƒ³IDï¼ˆä¾‹ï¼šãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ID Cookieã‚’å‰Šé™¤ï¼‰ã‚’æ“ä½œã§ãã¾ã™ã€‚ã“ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯Astroã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŠã‚ˆã³ãƒšãƒ¼ã‚¸ã§ã¯`Astro.session`ã¨ã—ã¦ã€APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒ»ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãƒ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯`context.session`ã¨ã—ã¦åˆ©ç”¨ã§ãã¾ã™ã€‚

ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯åˆå›åˆ©ç”¨æ™‚ã«è‡ªå‹•ç”Ÿæˆã•ã‚Œã€[`session.regenerate()`](/ja/reference/api-reference/#regenerate)ã§ã„ã¤ã§ã‚‚å†ç”Ÿæˆã§ãã€[`session.destroy()`](/ja/reference/api-reference/#destroy)ã§ç ´æ£„ã§ãã¾ã™ã€‚

ã»ã¨ã‚“ã©ã®å ´åˆã¯ã€[`session.get()`](/ja/reference/api-reference/#get)ã¨[`session.set()`](/ja/reference/api-reference/#set)ã®2ã¤ã ã‘ã§ååˆ†ã§ã™ã€‚

<ReadMore>
  è©³ã—ãã¯ [Sessions APIãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](/ja/reference/api-reference/#session)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
</ReadMore>

### Astroã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ãƒšãƒ¼ã‚¸

`.astro`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚„ãƒšãƒ¼ã‚¸ã§ã¯ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«`Astro`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆçµŒç”±ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚ãŸã¨ãˆã°ã€ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ã‚«ãƒ¼ãƒˆå†…ã®å•†å“æ•°ã‚’è¡¨ç¤ºã™ã‚‹ä¾‹ã§ã™ã€‚

```astro title="src/components/CartButton.astro" "Astro.session"
---
export const prerender = false; // 'server'å‡ºåŠ›ã®å ´åˆã¯ä¸è¦
const cart = await Astro.session?.get('cart');
---

<a href="/checkout">ğŸ›’ {cart?.length ?? 0} ç‚¹</a>
```

### APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã¯ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯`context`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸Šã§åˆ©ç”¨ã§ãã¾ã™ã€‚ãŸã¨ãˆã°ã€ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ã‚«ãƒ¼ãƒˆã«å•†å“ã‚’è¿½åŠ ã™ã‚‹ä¾‹ã§ã™ã€‚

```ts title="src/pages/api/addToCart.ts" "context.session"
export async function POST(context: APIContext) {
  const cart = await context.session?.get('cart') || [];
  const data = await context.request.json<{ item: string }>();
  if (!data?.item) {
    return new Response('Item is required', { status: 400 });
  }
  cart.push(data.item);
  await context.session?.set('cart', cart);
  return Response.json(cart);
}
```

### ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å†…ã§ã‚‚ã€`context`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸Šã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚ãŸã¨ãˆã°ã€ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ã‚«ãƒ¼ãƒˆã«å•†å“ã‚’è¿½åŠ ã™ã‚‹ä¾‹ã§ã™ã€‚

```ts title="src/actions/addToCart.ts" "context.session"
import { defineAction } from 'astro:actions';
import { z } from 'astro:schema';

export const server = {
  addToCart: defineAction({
    input: z.object({ productId: z.string() }),
    handler: async (input, context) => {
      const cart = await context.session?.get('cart');
      cart.push(input.productId);
      await context.session?.set('cart', cart);
      return cart;
    },
  }),
};
```

### ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢

:::caution
ã‚¨ãƒƒã‚¸ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§ã¯ã€ç¾åœ¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
:::

ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢å†…ã§ã¯ã€`context`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸Šã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚ãŸã¨ãˆã°ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«æœ€çµ‚è¨ªå•ã—ãŸæ™‚åˆ»ã‚’ä¿å­˜ã™ã‚‹ä¾‹ã§ã™ã€‚

```ts title="src/middleware.ts" "context.session"
import { defineMiddleware } from 'astro:middleware';

export const onRequest = defineMiddleware(async (context, next) => {
  context.session?.set('lastVisit', new Date());
  return next();
});
```

## ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®å‹

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã«å‹ã¯ãªãã€ä»»æ„ã®ã‚­ãƒ¼ã«å¥½ããªãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã§ãã¾ã™ã€‚å€¤ã®ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã‚„ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã«ã¯ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§ã‚‚ä½¿ã‚ã‚Œã¦ã„ã‚‹ [devalue](https://github.com/Rich-Harris/devalue) ãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ãã®ãŸã‚ã€æ–‡å­—åˆ—ãƒ»æ•°å€¤ãƒ»`Date`ãƒ»`Map`ãƒ»`Set`ãƒ»`URL`ãƒ»é…åˆ—ãƒ»ãƒ—ãƒ¬ãƒ¼ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãªã©ã€åŒã˜å‹ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚

å¿…è¦ã«å¿œã˜ã¦ã€`src/env.d.ts`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€`App.SessionData`å‹ã‚’å®£è¨€ã™ã‚‹ã“ã¨ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã«TypeScriptã®å‹ã‚’ä»˜ã‘ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```ts title="src/env.d.ts"
declare namespace App {
  interface SessionData {
    user: {
      id: string;
      name: string;
    };
    cart: string[];
  }
}
```

ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ä¸Šã§å‹ãƒã‚§ãƒƒã‚¯ã¨è£œå®Œã‚’å—ã‘ãªãŒã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

```ts title="src/components/CartButton.astro"
---
const cart = await Astro.session?.get('cart');
// const cart: string[] | undefined

const something = await Astro.session?.get('something');
// const something: any

Astro.session?.set('user', { id: 1, name: 'Houston' });
// Error: Argument of type '{ id: number; name: string }' is not assignable to parameter of type '{ id: string; name: string; }'.
---
```

:::caution
ã“ã‚Œã¯å‹ãƒã‚§ãƒƒã‚¯å°‚ç”¨ã§ã‚ã‚Šã€å®Ÿè¡Œæ™‚ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å‹•ä½œã«ã¯å½±éŸ¿ã—ã¾ã›ã‚“ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«æ—¢ã«ãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã§å‹ã‚’å¤‰æ›´ã™ã‚‹ã¨ã€å®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
:::