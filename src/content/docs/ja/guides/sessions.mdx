---
title: ã‚»ãƒƒã‚·ãƒ§ãƒ³
description: ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ãƒšãƒ¼ã‚¸é–“ã§ãƒ‡ãƒ¼ã‚¿ã‚’å…±æœ‰ã™ã‚‹ã€‚
i18nReady: true
---

import Since from '~/components/Since.astro';
import ReadMore from '~/components/ReadMore.astro';

<p>
<Since v="5.7.0" />
</p>

ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã€[ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ãƒšãƒ¼ã‚¸](/ja/guides/on-demand-rendering/)é–“ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã¾ãŸã„ã§ãƒ‡ãƒ¼ã‚¿ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã—ã¾ã™ã€‚

[`cookies`](/ja/guides/on-demand-rendering/#ã‚¯ãƒƒã‚­ãƒ¼)ã¨ã¯ç•°ãªã‚Šã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ã•ã‚Œã‚‹ãŸã‚ã€ã‚µã‚¤ã‚ºåˆ¶é™ã‚„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®å•é¡Œã‚’æ°—ã«ã™ã‚‹ã“ã¨ãªãå¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã§ãã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã€ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ã‚«ãƒ¼ãƒˆã€ãƒ•ã‚©ãƒ¼ãƒ ã®çŠ¶æ…‹ãªã©ã®ä¿å­˜ã«ä¾¿åˆ©ã§ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã®JavaScriptãªã—ã§å‹•ä½œã—ã¾ã™ã€‚

```astro title="src/components/CartButton.astro" {3}
---
export const prerender = false; // 'server' outputã§ã¯ä¸è¦
const cart = await Astro.session?.get('cart');
---

<a href="/checkout">ğŸ›’ {cart?.length ?? 0} items</a>
```

## ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®è¨­å®š

ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½¿ã†ã«ã¯ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ãŒå¿…è¦ã§ã™ã€‚[Node](/ja/guides/integrations-guide/node/#ã‚»ãƒƒã‚·ãƒ§ãƒ³)ã€[Cloudflare](/ja/guides/integrations-guide/cloudflare/#sessions)ã€[Netlify](/ja/guides/integrations-guide/netlify/#ã‚»ãƒƒã‚·ãƒ§ãƒ³)ã®ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã‚’è‡ªå‹•çš„ã«è¨­å®šã—ã¾ã™ãŒã€ãã®ä»–ã®ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã§ã¯ç¾åœ¨[ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã‚’æ‰‹å‹•ã§æŒ‡å®š](/ja/reference/configuration-reference/#sessiondriver)ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```js title="astro.config.mjs" ins={4}
  {
    adapter: vercel(),
    session: {
      driver: "redis",
    },
  }
```

<ReadMore>
  ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã®è¨­å®šã‚„ãã®ä»–ã®è¨­å®šå¯èƒ½ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€[`session`è¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³](/ja/reference/configuration-reference/#session-options)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
</ReadMore>


## ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®æ“ä½œ

[`session`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ](/ja/reference/api-reference/#session)ã‚’ä½¿ç”¨ã™ã‚Œã°ã€ä¿å­˜ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹ã®æ“ä½œï¼ˆä¾‹: ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ã‚«ãƒ¼ãƒˆã¸ã®ã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ ï¼‰ã‚„ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã®æ“ä½œï¼ˆä¾‹: ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚¯ãƒƒã‚­ãƒ¼ã®å‰Šé™¤ï¼‰ãŒå¯èƒ½ã§ã™ã€‚ã“ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã€Astroã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚„ãƒšãƒ¼ã‚¸ã§ã¯`Astro.session`ã‹ã‚‰ã€APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã€ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯`context.session`ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯åˆå›ä½¿ç”¨æ™‚ã«è‡ªå‹•çš„ã«ç”Ÿæˆã•ã‚Œã€[`session.regenerate()`](/ja/reference/api-reference/#regenerate)ã§ã„ã¤ã§ã‚‚å†ç”Ÿæˆã—ãŸã‚Šã€[`session.destroy()`](/ja/reference/api-reference/#destroy)ã§ç ´æ£„ã—ãŸã‚Šã§ãã¾ã™ã€‚

å¤šãã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§ã¯ã€[`session.get()`](/ja/reference/api-reference/#get)ã¨[`session.set()`](/ja/reference/api-reference/#set)ã®ã¿ã§ååˆ†ã§ã™ã€‚

<ReadMore>
è©³ç´°ã«ã¤ã„ã¦ã¯ã€[ã‚»ãƒƒã‚·ãƒ§ãƒ³APIãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](/ja/reference/api-reference/#session)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
</ReadMore>

### Astroã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ãƒšãƒ¼ã‚¸

`.astro`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚„ãƒšãƒ¼ã‚¸ã§ã¯ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ãª`Astro`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é€šã˜ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚ãŸã¨ãˆã°ã€ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ã‚«ãƒ¼ãƒˆå†…ã®ã‚¢ã‚¤ãƒ†ãƒ æ•°ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯æ¬¡ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

```astro title="src/components/CartButton.astro" "Astro.session"
---
export const prerender = false; // 'server' outputã§ã¯ä¸è¦
const cart = await Astro.session?.get('cart');
---

<a href="/checkout">ğŸ›’ {cart?.length ?? 0} items</a>
```

### APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã¯ã€`context`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚ãŸã¨ãˆã°ã€ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ã‚«ãƒ¼ãƒˆã«ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ ã™ã‚‹ã«ã¯æ¬¡ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

```ts title="src/pages/api/addToCart.ts" "context.session"
export async function POST(context: APIContext) {
  const cart = await context.session?.get('cart') || [];
	const data = await context.request.json<{ item: string }>();
  if(!data?.item) {
    return new Response('Item is required', { status: 400 });
  }
  cart.push(data.item);
  await context.session?.set('cart', cart);
  return Response.json(cart);
}
```

### ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€`context`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚ãŸã¨ãˆã°ã€ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ã‚«ãƒ¼ãƒˆã«ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ ã™ã‚‹ã«ã¯æ¬¡ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

```ts title="src/actions/addToCart.ts" "context.session"
import { defineAction } from 'astro:actions';
import { z } from 'astro/zod';

export const server = {
  addToCart: defineAction({
    input: z.object({ productId: z.string() }),
    handler: async (input, context) => {
      const cart = await context.session?.get('cart');
      cart.push(input.productId);
      await context.session?.set('cart', cart);
      return cart;
    },
  }),
};
```

### ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢

:::note
ã‚¨ãƒƒã‚¸ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
:::

ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§ã¯ã€`context`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚ãŸã¨ãˆã°ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«æœ€çµ‚è¨ªå•æ—¥æ™‚ã‚’è¨­å®šã™ã‚‹ã«ã¯æ¬¡ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

```ts title="src/middleware.ts" "context.session"
import { defineMiddleware } from 'astro:middleware';

export const onRequest = defineMiddleware(async (context, next) => {
  context.session?.set('lastVisit', new Date());
  return next();
});
```

## ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®å‹

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã«ã¯å‹ãŒãªãã€ä»»æ„ã®ã‚­ãƒ¼ã«ä»»æ„ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã§ãã¾ã™ã€‚å€¤ã¯[devalue](https://github.com/Rich-Harris/devalue)ã‚’ä½¿ç”¨ã—ã¦ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºãƒ»ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã•ã‚Œã¾ã™ã€‚ã“ã‚Œã¯ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã®ã¨åŒã˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚ãã®ãŸã‚ã€ã‚µãƒãƒ¼ãƒˆã•ã‚Œã‚‹å‹ã‚‚åŒã˜ã§ã€æ–‡å­—åˆ—ã€æ•°å€¤ã€`Date`ã€`Map`ã€`Set`ã€`URL`ã€é…åˆ—ã€ãƒ—ãƒ¬ãƒ¼ãƒ³ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå«ã¾ã‚Œã¾ã™ã€‚

`src/env.d.ts`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€`App.SessionData`å‹ã®å®£è¨€ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®[TypeScriptå‹ã‚’å®šç¾©](/ja/guides/typescript/#extending-global-types)ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```ts title="src/env.d.ts"
declare namespace App {
  interface SessionData {
    user: {
      id: string;
      name: string;
    };
    cart: string[];
  }
}
```

ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã§å‹ãƒã‚§ãƒƒã‚¯ã¨è‡ªå‹•è£œå®Œã‚’ä½¿ã£ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```ts title="src/components/CartButton.astro"
---
const cart = await Astro.session?.get('cart');
// const cart: string[] | undefined

const something = await Astro.session?.get('something');
// const something: any

Astro.session?.set('user', { id: 1, name: 'Houston' });
// Error: Argument of type '{ id: number; name: string }' is not assignable to parameter of type '{ id: string; name: string; }'.
---
```

:::caution
ã“ã‚Œã¯å‹ãƒã‚§ãƒƒã‚¯ã«ã®ã¿ä½¿ç”¨ã•ã‚Œã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã®å‹•ä½œã«ã¯å½±éŸ¿ã—ã¾ã›ã‚“ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ãŸçŠ¶æ…‹ã§å‹ã‚’å¤‰æ›´ã™ã‚‹ã¨ã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€ååˆ†ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
:::
