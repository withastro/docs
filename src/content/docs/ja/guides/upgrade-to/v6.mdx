---
title: Astro v6へのアップグレード
description: Astro v6.0 の変更点を確認し、CSP 設定を更新する方法をまとめました。
i18nReady: false
---

> ℹ️ このページはまずCSPまわりの差分をカバーしています。その他の変更点は、[English版のv6ガイド](/en/guides/upgrade-to/v6/)を参照してください。

Astro v6では、Astro 5.xで試験提供されていたCSP機能が安定版に昇格し、設定場所も変更されました。ここでは、日本語ドキュメントで特に影響が大きいCSP関連の変更点をまとめます。

## 実験的フラグの削除

Astro 6.0では`experimental.csp`フラグが削除されました。すでに使用している場合は、このフラグを`astro.config.*`から取り除き、新しい`security.csp`設定に移行してください。

```diff title="astro.config.mjs"
 export default defineConfig({
-  experimental: {
-    csp: true
-  },
+  security: {
+    csp: {
+      // ここでアルゴリズムや追加ディレクティブを管理します
+    }
+  },
 })
```

`security.csp`を使うと、`experimental`セクションに依存せずにCSPを制御できるうえ、今後のメジャーアップデートでも互換性が保たれます。

## 安定化した機能: CSP

- **CSP** — AstroのCSP機能は安定版となり、`experimental`フラグなしで利用できます。新しい設定オプションやハッシュの付け方は[CSP 設定リファレンス](/ja/reference/configuration-reference/#securitycsp)を参照し、`security.csp`ブロックで必要なディレクティブを定義してください。
- `security.csp`はSSRページでもプリレンダリングされたページでも動作します。`astro build`で必ず確認し、本番ホストに必要なリソースだけが許可されているかを検証してください。

### 次のステップ

1. 既存の`astro.config.*`から`experimental.csp`を削除します。
2. `security.csp`に新しい設定を追加し、必要なリソースやハッシュを定義します。
3. `astro build && astro preview`でCSPヘッダーが期待通りに生成されていることを確認し、ホスティング環境に合わせた調整（例: Netlify/Vercelの`experimentalStaticHeaders`オプション）を行います。
