---
title: Sessions
description: Chia sáº» dá»¯ liá»‡u giá»¯a cÃ¡c request cho cÃ¡c trang Ä‘Æ°á»£c render theo yÃªu cáº§u.
i18nReady: true
---

import Since from '~/components/Since.astro';
import ReadMore from '~/components/ReadMore.astro';

<p>
<Since v="5.7.0" />
</p>

Sessions Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ chia sáº» dá»¯ liá»‡u giá»¯a cÃ¡c request cho [cÃ¡c trang Ä‘Æ°á»£c render theo yÃªu cáº§u](/en/guides/on-demand-rendering/). 

KhÃ¡c vá»›i [`cookies`](/en/guides/on-demand-rendering/#cookies), sessions Ä‘Æ°á»£c lÆ°u trá»¯ trÃªn server, vÃ¬ váº­y báº¡n cÃ³ thá»ƒ lÆ°u trá»¯ lÆ°á»£ng dá»¯ liá»‡u lá»›n hÆ¡n mÃ  khÃ´ng cáº§n lo láº¯ng vá» giá»›i háº¡n kÃ­ch thÆ°á»›c hoáº·c váº¥n Ä‘á» báº£o máº­t. ChÃºng há»¯u Ã­ch Ä‘á»ƒ lÆ°u trá»¯ nhá»¯ng thá»© nhÆ° dá»¯ liá»‡u ngÆ°á»i dÃ¹ng, giá» hÃ ng vÃ  tráº¡ng thÃ¡i form, vÃ  chÃºng hoáº¡t Ä‘á»™ng mÃ  khÃ´ng cáº§n JavaScript phÃ­a client:

```astro title="src/components/CartButton.astro" {3}
---
export const prerender = false; // KhÃ´ng cáº§n thiáº¿t vá»›i output 'server'
const cart = await Astro.session?.get('cart');
---

<a href="/checkout">ğŸ›’ {cart?.length ?? 0} sáº£n pháº©m</a>
```

## Cáº¥u hÃ¬nh sessions

Sessions yÃªu cáº§u má»™t storage driver Ä‘á»ƒ lÆ°u trá»¯ dá»¯ liá»‡u session. CÃ¡c adapter [Node](/en/guides/integrations-guide/node/#sessions), [Cloudflare](/en/guides/integrations-guide/cloudflare/#sessions), vÃ  [Netlify](/en/guides/integrations-guide/netlify/#sessions) tá»± Ä‘á»™ng cáº¥u hÃ¬nh driver máº·c Ä‘á»‹nh cho báº¡n, nhÆ°ng cÃ¡c adapter khÃ¡c hiá»‡n táº¡i yÃªu cáº§u báº¡n [chá»‰ Ä‘á»‹nh driver thá»§ cÃ´ng](/en/reference/configuration-reference/#sessiondriver).

```js title="astro.config.mjs" ins={4}
  {
    adapter: vercel(),
    session: {
      driver: "redis",
    },
  }
```

<ReadMore>
  Xem [tÃ¹y chá»n cáº¥u hÃ¬nh `session`](/en/reference/configuration-reference/#session-options) Ä‘á»ƒ biáº¿t thÃªm chi tiáº¿t vá» cÃ¡ch thiáº¿t láº­p storage driver vÃ  cÃ¡c tÃ¹y chá»n cÃ³ thá»ƒ cáº¥u hÃ¬nh khÃ¡c.
</ReadMore>

## TÆ°Æ¡ng tÃ¡c vá»›i dá»¯ liá»‡u session

[Äá»‘i tÆ°á»£ng `session`](/en/reference/api-reference/#session) cho phÃ©p báº¡n tÆ°Æ¡ng tÃ¡c vá»›i tráº¡ng thÃ¡i ngÆ°á»i dÃ¹ng Ä‘Æ°á»£c lÆ°u trá»¯ (vÃ­ dá»¥: thÃªm sáº£n pháº©m vÃ o giá» hÃ ng) vÃ  session ID (vÃ­ dá»¥: xÃ³a session ID cookie khi Ä‘Äƒng xuáº¥t). Äá»‘i tÆ°á»£ng nÃ y cÃ³ thá»ƒ truy cáº­p thÃ´ng qua `Astro.session` trong cÃ¡c component vÃ  page Astro cá»§a báº¡n vÃ  thÃ´ng qua Ä‘á»‘i tÆ°á»£ng `context.session` trong API endpoints, middleware vÃ  actions.

Session Ä‘Æ°á»£c táº¡o tá»± Ä‘á»™ng khi nÃ³ Ä‘Æ°á»£c sá»­ dá»¥ng láº§n Ä‘áº§u tiÃªn vÃ  cÃ³ thá»ƒ Ä‘Æ°á»£c tÃ¡i táº¡o báº¥t ká»³ lÃºc nÃ o vá»›i [`session.regenerate()`](/en/reference/api-reference/#regenerate) hoáº·c há»§y bá» vá»›i [`session.destroy()`](/en/reference/api-reference/#destroy).

Äá»‘i vá»›i nhiá»u trÆ°á»ng há»£p sá»­ dá»¥ng, báº¡n chá»‰ cáº§n sá»­ dá»¥ng [`session.get()`](/en/reference/api-reference/#get) vÃ  [`session.set()`](/en/reference/api-reference/#set).

<ReadMore>
Xem [tÃ i liá»‡u tham kháº£o Sessions API](/en/reference/api-reference/#session) Ä‘á»ƒ biáº¿t thÃªm chi tiáº¿t.
</ReadMore>

### Astro components vÃ  pages

Trong cÃ¡c component vÃ  page `.astro`, báº¡n cÃ³ thá»ƒ truy cáº­p Ä‘á»‘i tÆ°á»£ng session thÃ´ng qua Ä‘á»‘i tÆ°á»£ng global `Astro`. VÃ­ dá»¥, Ä‘á»ƒ hiá»ƒn thá»‹ sá»‘ lÆ°á»£ng sáº£n pháº©m trong giá» hÃ ng:

```astro title="src/components/CartButton.astro" "Astro.session"
---
export const prerender = false; // KhÃ´ng cáº§n thiáº¿t vá»›i output 'server'
const cart = await Astro.session?.get('cart');
---

<a href="/checkout">ğŸ›’ {cart?.length ?? 0} sáº£n pháº©m</a>
```

### API endpoints

Trong API endpoints, Ä‘á»‘i tÆ°á»£ng session cÃ³ sáºµn trÃªn Ä‘á»‘i tÆ°á»£ng `context`. VÃ­ dá»¥, Ä‘á»ƒ thÃªm má»™t sáº£n pháº©m vÃ o giá» hÃ ng:

```ts title="src/pages/api/addToCart.ts" "context.session"
export async function POST(context: APIContext) {
  const cart = await context.session?.get('cart') || [];
	const data = await context.request.json<{ item: string }>();
  if(!data?.item) {
    return new Response('Item lÃ  báº¯t buá»™c', { status: 400 });
  }
  cart.push(data.item);
  await context.session?.set('cart', cart);
  return Response.json(cart);
}
```

### Actions

Trong actions, Ä‘á»‘i tÆ°á»£ng session cÃ³ sáºµn trÃªn Ä‘á»‘i tÆ°á»£ng `context`. VÃ­ dá»¥, Ä‘á»ƒ thÃªm má»™t sáº£n pháº©m vÃ o giá» hÃ ng:

```ts title="src/actions/addToCart.ts" "context.session"
import { defineAction } from 'astro:actions';
import { z } from 'astro:schema';

export const server = {
  addToCart: defineAction({
    input: z.object({ productId: z.string() }),
    handler: async (input, context) => {
      const cart = await context.session?.get('cart');
      cart.push(input.productId);
      await context.session?.set('cart', cart);
      return cart;
    },
  }),
};
```

### Middleware

:::note
Sessions khÃ´ng Ä‘Æ°á»£c há»— trá»£ trong edge middleware.
:::

Trong middleware, Ä‘á»‘i tÆ°á»£ng session cÃ³ sáºµn trÃªn Ä‘á»‘i tÆ°á»£ng `context`. VÃ­ dá»¥, Ä‘á»ƒ thiáº¿t láº­p thá»i gian truy cáº­p cuá»‘i cÃ¹ng trong session:

```ts title="src/middleware.ts" "context.session"
import { defineMiddleware } from 'astro:middleware';

export const onRequest = defineMiddleware(async (context, next) => {
  context.session?.set('lastVisit', new Date());
  return next();
});
```

## Kiá»ƒu dá»¯ liá»‡u session

Máº·c Ä‘á»‹nh, dá»¯ liá»‡u session khÃ´ng cÃ³ kiá»ƒu, vÃ  báº¡n cÃ³ thá»ƒ lÆ°u trá»¯ dá»¯ liá»‡u tÃ¹y Ã½ trong báº¥t ká»³ key nÃ o. CÃ¡c giÃ¡ trá»‹ Ä‘Æ°á»£c serialize vÃ  deserialize báº±ng [devalue](https://github.com/Rich-Harris/devalue), Ä‘Ã¢y lÃ  thÆ° viá»‡n tÆ°Æ¡ng tá»± Ä‘Æ°á»£c sá»­ dá»¥ng trong content collections vÃ  actions. Äiá»u nÃ y cÃ³ nghÄ©a lÃ  cÃ¡c kiá»ƒu Ä‘Æ°á»£c há»— trá»£ giá»‘ng nhau, bao gá»“m strings, numbers, `Date`, `Map`, `Set`, `URL`, arrays vÃ  plain objects.

Báº¡n cÃ³ thá»ƒ tÃ¹y chá»n Ä‘á»‹nh nghÄ©a cÃ¡c kiá»ƒu TypeScript cho dá»¯ liá»‡u session cá»§a mÃ¬nh báº±ng cÃ¡ch táº¡o file `src/env.d.ts` vÃ  thÃªm má»™t khai bÃ¡o cho kiá»ƒu `App.SessionData`:

```ts title="src/env.d.ts"
declare namespace App {
  interface SessionData {
    user: {
      id: string;
      name: string;
    };
    cart: string[];
  }
}
```

Äiá»u nÃ y sáº½ cho phÃ©p báº¡n truy cáº­p dá»¯ liá»‡u session vá»›i type-checking vÃ  auto-completion trong editor:

```ts title="src/components/CartButton.astro"
---
const cart = await Astro.session?.get('cart');
// const cart: string[] | undefined

const something = await Astro.session?.get('something');
// const something: any

Astro.session?.set('user', { id: 1, name: 'Houston' });
// Error: Argument of type '{ id: number; name: string }' is not assignable to parameter of type '{ id: string; name: string; }'.
---
```

:::caution
Äiá»u nÃ y chá»‰ Ä‘Æ°á»£c sá»­ dá»¥ng cho type-checking vÃ  khÃ´ng áº£nh hÆ°á»Ÿng Ä‘áº¿n hÃ nh vi runtime cá»§a session. HÃ£y Ä‘áº·c biá»‡t cáº©n tháº­n náº¿u báº¡n thay Ä‘á»•i kiá»ƒu khi ngÆ°á»i dÃ¹ng Ä‘Ã£ lÆ°u trá»¯ dá»¯ liá»‡u trong session, vÃ¬ Ä‘iá»u nÃ y cÃ³ thá»ƒ gÃ¢y ra lá»—i runtime.
:::