---
type: integration
title: '@astrojs/cloudflare'
description: TÃ¬m hiá»ƒu cÃ¡ch sá»­ dá»¥ng adapter @astrojs/cloudflare Ä‘á»ƒ triá»ƒn khai dá»± Ã¡n Astro cá»§a báº¡n.
sidebar:
  label: Cloudflare
githubIntegrationURL: 'https://github.com/withastro/astro/tree/main/packages/integrations/cloudflare/'
category: adapter
i18nReady: true
---

import PackageManagerTabs from '~/components/tabs/PackageManagerTabs.astro'
import ReadMore from '~/components/ReadMore.astro';
import Since from '~/components/Since.astro';
import { Tabs, TabItem, Steps } from '@astrojs/starlight/components';

Adapter nÃ y cho phÃ©p Astro triá»ƒn khai [cÃ¡c tuyáº¿n Ä‘Æ°á»ng vÃ  tÃ­nh nÄƒng render theo yÃªu cáº§u](/en/guides/on-demand-rendering/) cá»§a báº¡n lÃªn [Cloudflare](https://www.cloudflare.com/), bao gá»“m [server islands](/en/guides/server-islands/), [actions](/en/guides/actions/), vÃ  [sessions](/en/guides/sessions/).

Náº¿u báº¡n sá»­ dá»¥ng Astro nhÆ° má»™t trÃ¬nh táº¡o trang web tÄ©nh, báº¡n khÃ´ng cáº§n adapter.

TÃ¬m hiá»ƒu cÃ¡ch triá»ƒn khai trang web Astro cá»§a báº¡n trong [hÆ°á»›ng dáº«n triá»ƒn khai Cloudflare](/en/guides/deploy/cloudflare/) cá»§a chÃºng tÃ´i.

## Táº¡i sao Astro Cloudflare

[Ná»n táº£ng NhÃ  phÃ¡t triá»ƒn](https://developers.cloudflare.com/) cá»§a Cloudflare cho phÃ©p báº¡n phÃ¡t triá»ƒn á»©ng dá»¥ng full-stack vá»›i quyá»n truy cáº­p vÃ o cÃ¡c tÃ i nguyÃªn nhÆ° lÆ°u trá»¯ vÃ  AI, táº¥t cáº£ Ä‘Æ°á»£c triá»ƒn khai trÃªn máº¡ng edge toÃ n cáº§u. Adapter nÃ y xÃ¢y dá»±ng dá»± Ã¡n Astro cá»§a báº¡n Ä‘á»ƒ triá»ƒn khai thÃ´ng qua Cloudflare.

## CÃ i Ä‘áº·t

Astro bao gá»“m lá»‡nh `astro add` Ä‘á»ƒ tá»± Ä‘á»™ng hÃ³a viá»‡c thiáº¿t láº­p cÃ¡c tÃ­ch há»£p chÃ­nh thá»©c. Náº¿u báº¡n muá»‘n, báº¡n cÃ³ thá»ƒ [cÃ i Ä‘áº·t tÃ­ch há»£p thá»§ cÃ´ng](#manual-install) thay tháº¿.

ThÃªm adapter Cloudflare Ä‘á»ƒ kÃ­ch hoáº¡t server-rendering trong dá»± Ã¡n Astro cá»§a báº¡n vá»›i lá»‡nh `astro add`. Äiá»u nÃ y sáº½ cÃ i Ä‘áº·t `@astrojs/cloudflare` vÃ  thá»±c hiá»‡n cÃ¡c thay Ä‘á»•i thÃ­ch há»£p cho tá»‡p `astro.config.mjs` cá»§a báº¡n trong má»™t bÆ°á»›c.

<PackageManagerTabs>
  <Fragment slot="npm">
  ```sh
  npx astro add cloudflare
  ```
  </Fragment>
  <Fragment slot="pnpm">
  ```sh
  pnpm astro add cloudflare
  ```
  </Fragment>
  <Fragment slot="yarn">
  ```sh
  yarn astro add cloudflare
  ```
  </Fragment>
</PackageManagerTabs>

BÃ¢y giá», báº¡n cÃ³ thá»ƒ báº­t [render theo yÃªu cáº§u cho tá»«ng trang](/en/guides/on-demand-rendering/#enabling-on-demand-rendering), hoáº·c Ä‘áº·t cáº¥u hÃ¬nh build output thÃ nh `output: 'server'` Ä‘á»ƒ [server-render táº¥t cáº£ cÃ¡c trang theo máº·c Ä‘á»‹nh](/en/guides/on-demand-rendering/#server-mode).

### CÃ i Ä‘áº·t thá»§ cÃ´ng

Äáº§u tiÃªn, thÃªm adapter `@astrojs/cloudflare` vÃ o dependencies cá»§a dá»± Ã¡n báº±ng trÃ¬nh quáº£n lÃ½ gÃ³i Æ°a thÃ­ch cá»§a báº¡n.

<PackageManagerTabs>
  <Fragment slot="npm">
  ```sh
  npm install @astrojs/cloudflare
  ```
  </Fragment>
  <Fragment slot="pnpm">
  ```sh
  pnpm add @astrojs/cloudflare
  ```
  </Fragment>
  <Fragment slot="yarn">
  ```sh
  yarn add @astrojs/cloudflare
  ```
  </Fragment>
</PackageManagerTabs>

Sau Ä‘Ã³, thÃªm adapter vÃ o tá»‡p `astro.config.mjs` cá»§a báº¡n:

```js title="astro.config.mjs" ins={2,5}
import { defineConfig } from 'astro/config';
import cloudflare from '@astrojs/cloudflare';

export default defineConfig({
  adapter: cloudflare(),
});
```

## TÃ¹y chá»n

Adapter Cloudflare cháº¥p nháº­n cÃ¡c tÃ¹y chá»n sau:

### `cloudflareModules`

<p>
**Kiá»ƒu:** `boolean`<br />
**Máº·c Ä‘á»‹nh:** `true`
</p>

KÃ­ch hoáº¡t [import cÃ¡c module `.wasm`, `.bin`, vÃ  `.txt`](#cloudflare-module-imports).

TÃ­nh nÄƒng nÃ y Ä‘Æ°á»£c báº­t theo máº·c Ä‘á»‹nh. Náº¿u báº¡n muá»‘n táº¯t, Ä‘áº·t `cloudflareModules` thÃ nh `false`.

### `imageService`

<p>
**Kiá»ƒu:** `'passthrough' | 'cloudflare' | 'compile' | 'custom'`<br />
**Máº·c Ä‘á»‹nh:** `'compile'`
</p>

XÃ¡c Ä‘á»‹nh dá»‹ch vá»¥ hÃ¬nh áº£nh nÃ o Ä‘Æ°á»£c adapter sá»­ dá»¥ng. Adapter sáº½ máº·c Ä‘á»‹nh vá» cháº¿ Ä‘á»™ `compile` khi má»™t dá»‹ch vá»¥ hÃ¬nh áº£nh khÃ´ng tÆ°Æ¡ng thÃ­ch Ä‘Æ°á»£c cáº¥u hÃ¬nh. Náº¿u khÃ´ng, nÃ³ sáº½ sá»­ dá»¥ng dá»‹ch vá»¥ hÃ¬nh áº£nh Ä‘Æ°á»£c cáº¥u hÃ¬nh toÃ n cá»¥c:

* **`cloudflare`:** Sá»­ dá»¥ng dá»‹ch vá»¥ [Cloudflare Image Resizing](https://developers.cloudflare.com/images/image-resizing/).
* **`passthrough`:** Sá»­ dá»¥ng dá»‹ch vá»¥ [`noop`](/en/guides/images/#configure-no-op-passthrough-service) hiá»‡n cÃ³.
* **`compile`:** Sá»­ dá»¥ng dá»‹ch vá»¥ máº·c Ä‘á»‹nh cá»§a Astro (sharp), nhÆ°ng chá»‰ trÃªn cÃ¡c tuyáº¿n Ä‘Æ°á»ng pre-rendered táº¡i thá»i Ä‘iá»ƒm build. Äá»‘i vá»›i cÃ¡c trang Ä‘Æ°á»£c render theo yÃªu cáº§u, táº¥t cáº£ cÃ¡c tÃ­nh nÄƒng `astro:assets` Ä‘á»u bá»‹ táº¯t.
* **`custom`:** LuÃ´n sá»­ dá»¥ng dá»‹ch vá»¥ hÃ¬nh áº£nh Ä‘Æ°á»£c cáº¥u hÃ¬nh trong [Image Options](/en/reference/configuration-reference/#image-options). **TÃ¹y chá»n nÃ y sáº½ khÃ´ng kiá»ƒm tra xem dá»‹ch vá»¥ hÃ¬nh áº£nh Ä‘Æ°á»£c cáº¥u hÃ¬nh cÃ³ hoáº¡t Ä‘á»™ng trong runtime `workerd` cá»§a Cloudflare hay khÃ´ng.**

```js title="astro.config.mjs" ins={6}
import { defineConfig } from "astro/config";
import cloudflare from '@astrojs/cloudflare';

export default defineConfig({
  adapter: cloudflare({
     imageService: 'cloudflare'
  }),
})
```

### `platformProxy`

XÃ¡c Ä‘á»‹nh xem vÃ  cÃ¡ch thÃªm runtime Cloudflare vÃ o `astro dev`. NÃ³ chá»©a cÃ¡c proxy Ä‘áº¿n bindings `workerd` cá»¥c bá»™ vÃ  emulation cÃ¡c giÃ¡ trá»‹ cá»¥ thá»ƒ cá»§a Cloudflare, cho phÃ©p emulation runtime trong tiáº¿n trÃ¬nh dev Node.js. Äá»c thÃªm vá» [Cloudflare Runtime](#cloudflare-runtime).

:::note
CÃ¡c proxy Ä‘Æ°á»£c cung cáº¥p bá»Ÿi Ä‘iá»u nÃ y lÃ  emulation ná»— lá»±c tá»‘t nháº¥t cá»§a thá»±c táº¿ production. Máº·c dÃ¹ chÃºng Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ gáº§n giá»‘ng vá»›i thá»±c táº¿ nháº¥t cÃ³ thá»ƒ, cÃ³ thá»ƒ cÃ³ nhá»¯ng khÃ¡c biá»‡t vÃ  khÃ´ng nháº¥t quÃ¡n nhá» giá»¯a hai bÃªn.
:::

#### `platformProxy.enabled`
<p>
**Kiá»ƒu:** `boolean`<br />
**Máº·c Ä‘á»‹nh:** `true`
</p>

XÃ¡c Ä‘á»‹nh cÃ³ báº­t runtime Cloudflare trong cháº¿ Ä‘á»™ development hay khÃ´ng.

#### `platformProxy.configPath`
<p>
**Kiá»ƒu:** `string`<br />
**Máº·c Ä‘á»‹nh:** `undefined`
</p>

Äá»‹nh nghÄ©a Ä‘Æ°á»ng dáº«n Ä‘áº¿n tá»‡p cáº¥u hÃ¬nh Wrangler. Náº¿u khÃ´ng cÃ³ giÃ¡ trá»‹ nÃ o Ä‘Æ°á»£c Ä‘áº·t, nÃ³ sáº½ theo dÃµi `wrangler.toml`, `wrangler.json`, vÃ  `wrangler.jsonc` trong thÆ° má»¥c gá»‘c dá»± Ã¡n.

#### `platformProxy.environment`
<p>
**Kiá»ƒu:** `string`<br />
**Máº·c Ä‘á»‹nh:** `undefined`
</p>

Äáº·t [mÃ´i trÆ°á»ng Cloudflare](https://developers.cloudflare.com/workers/wrangler/environments/) Ä‘á»ƒ sá»­ dá»¥ng. Báº¡n pháº£i chá»n má»™t mÃ´i trÆ°á»ng Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong tá»‡p cáº¥u hÃ¬nh Wrangler, náº¿u khÃ´ng sáº½ xáº£y ra lá»—i.

#### `platformProxy.persist`
<p>
**Kiá»ƒu:** `boolean | { path: string }`<br />
**Máº·c Ä‘á»‹nh:** `true`
</p>

Äáº·t cÃ³ vÃ  nÆ¡i lÆ°u dá»¯ liá»‡u binding cá»¥c bá»™ vÃ o há»‡ thá»‘ng tá»‡p.

- Náº¿u Ä‘áº·t thÃ nh `true`, dá»¯ liá»‡u binding Ä‘Æ°á»£c lÆ°u trá»¯ trong `.wrangler/state/v3/`. ÄÃ¢y giá»‘ng nhÆ° cÃ i Ä‘áº·t máº·c Ä‘á»‹nh cho wrangler.
- Náº¿u Ä‘áº·t thÃ nh `false`, dá»¯ liá»‡u binding khÃ´ng Ä‘Æ°á»£c lÆ°u trá»¯ trong há»‡ thá»‘ng tá»‡p.
- Náº¿u Ä‘áº·t thÃ nh `{ path: string }`, dá»¯ liá»‡u binding Ä‘Æ°á»£c lÆ°u trá»¯ trong Ä‘Æ°á»ng dáº«n Ä‘Æ°á»£c chá»‰ Ä‘á»‹nh.

:::note
TÃ¹y chá»n `--persist-to` cá»§a `wrangler` thÃªm má»™t thÆ° má»¥c con cÃ³ tÃªn `v3` bÃªn dÆ°á»›i trong khi thuá»™c tÃ­nh `persist` cá»§a `@astrojs/cloudflare` thÃ¬ khÃ´ng. VÃ­ dá»¥, Ä‘á»ƒ sá»­ dá»¥ng láº¡i cÃ¹ng vá»‹ trÃ­ nhÆ° cháº¡y `wrangler dev --persist-to ./my-directory`, báº¡n pháº£i chá»‰ Ä‘á»‹nh: `persist: { path: "./my-directory/v3" }`.
:::

Cáº¥u hÃ¬nh sau Ä‘Ã¢y hiá»ƒn thá»‹ vÃ­ dá»¥ vá» viá»‡c báº­t runtime Cloudflare khi cháº¡y development server, cÅ©ng nhÆ° sá»­ dá»¥ng tá»‡p cáº¥u hÃ¬nh `wrangler.json`. NÃ³ cÅ©ng chá»‰ Ä‘á»‹nh vá»‹ trÃ­ tÃ¹y chá»‰nh Ä‘á»ƒ lÆ°u trá»¯ dá»¯ liá»‡u vÃ o há»‡ thá»‘ng tá»‡p:

```js
import cloudflare from '@astrojs/cloudflare';
import { defineConfig } from 'astro/config';

export default defineConfig({
	adapter: cloudflare({
		platformProxy: {
			enabled: true,
			configPath: 'wrangler.json',
			persist: {
				path: './.cache/wrangler/v3'
			},
		},
	}),
});
```

### `routes.extend`

TrÃªn Cloudflare Workers, tÃ¹y chá»n nÃ y khÃ´ng Ã¡p dá»¥ng. Tham kháº£o [Routing trÃªn Cloudflare Workers](#routing-on-cloudflare-workers) Ä‘á»ƒ biáº¿t thÃªm thÃ´ng tin.

TrÃªn Cloudflare Pages, tÃ¹y chá»n nÃ y cho phÃ©p báº¡n thÃªm hoáº·c loáº¡i trá»« cÃ¡c pattern tÃ¹y chá»‰nh (vÃ­ dá»¥ `/fonts/*`) vÃ o tá»‡p `_routes.json` Ä‘Æ°á»£c táº¡o ra, tá»‡p nÃ y xÃ¡c Ä‘á»‹nh nhá»¯ng tuyáº¿n Ä‘Æ°á»ng nÃ o Ä‘Æ°á»£c táº¡o theo yÃªu cáº§u. Äiá»u nÃ y cÃ³ thá»ƒ há»¯u Ã­ch náº¿u báº¡n cáº§n thÃªm cÃ¡c pattern tuyáº¿n Ä‘Æ°á»ng khÃ´ng thá»ƒ Ä‘Æ°á»£c táº¡o tá»± Ä‘á»™ng, hoáº·c loáº¡i trá»« cÃ¡c tuyáº¿n Ä‘Æ°á»ng prerendered.

ThÃ´ng tin thÃªm vá» cÃ¡c pattern tuyáº¿n Ä‘Æ°á»ng tÃ¹y chá»‰nh cÃ³ thá»ƒ Ä‘Æ°á»£c tÃ¬m tháº¥y trong [tÃ i liá»‡u routing cá»§a Cloudflare](https://developers.cloudflare.com/pages/functions/routing/#functions-invocation-routes). Báº¥t ká»³ tuyáº¿n Ä‘Æ°á»ng nÃ o Ä‘Æ°á»£c chá»‰ Ä‘á»‹nh Ä‘á»u khÃ´ng Ä‘Æ°á»£c tá»± Ä‘á»™ng deduplicated vÃ  sáº½ Ä‘Æ°á»£c thÃªm vÃ o cÃ¡c tuyáº¿n Ä‘Æ°á»ng hiá»‡n cÃ³ nhÆ° lÃ .

#### `routes.extend.include`

<p>
**Kiá»ƒu:** `{ pattern: string }[]`<br />
**Máº·c Ä‘á»‹nh:** `undefined`
</p>

Cáº¥u hÃ¬nh cÃ¡c tuyáº¿n Ä‘Æ°á»ng bá»• sung Ä‘á»ƒ Ä‘Æ°á»£c táº¡o theo yÃªu cáº§u bá»Ÿi adapter Cloudflare trong máº£ng `routes.extend.include`.

#### `routes.extend.exclude`

<p>
**Kiá»ƒu:** `{ pattern: string }[]`<br />
**Máº·c Ä‘á»‹nh:** `undefined`
</p>

Cáº¥u hÃ¬nh cÃ¡c tuyáº¿n Ä‘Æ°á»ng Ä‘á»ƒ loáº¡i trá»« khá»i rendering theo yÃªu cáº§u trong máº£ng `routes.extend.exclude`. Nhá»¯ng tuyáº¿n Ä‘Æ°á»ng nÃ y sáº½ Ä‘Æ°á»£c prerendered vÃ  phá»¥c vá»¥ tÄ©nh thay tháº¿, vÃ  sáº½ khÃ´ng gá»i server function. NgoÃ i ra, báº¡n cÃ³ thá»ƒ sá»­ dá»¥ng tÃ¹y chá»n nÃ y Ä‘á»ƒ phá»¥c vá»¥ báº¥t ká»³ tá»‡p tÃ i sáº£n tÄ©nh nÃ o (vÃ­ dá»¥ hÃ¬nh áº£nh, fonts, css, js, html, txt, json, v.v.) trá»±c tiáº¿p mÃ  khÃ´ng Ä‘á»‹nh tuyáº¿n yÃªu cáº§u qua server function.

```js title="astro.config.mjs"
export default defineConfig({
  adapter: cloudflare({
    routes: {
      extend: {
        include: [{ pattern: '/static' }], // Äá»‹nh tuyáº¿n má»™t trang prerended Ä‘áº¿n server function Ä‘á»ƒ rendering theo yÃªu cáº§u
        exclude: [{ pattern: '/pagefind/*' }], // Sá»­ dá»¥ng tÃ¬m kiáº¿m pagefind cá»§a Starlight, Ä‘Æ°á»£c táº¡o tÄ©nh táº¡i thá»i Ä‘iá»ƒm build
      }
    },
  }),
});
```

### `sessionKVBindingName`
<p>
**Kiá»ƒu:** `string`<br />
**Máº·c Ä‘á»‹nh:** `SESSION`
<Since v="5.6.0" />
</p>

TÃ¹y chá»n `sessionKVBindingName` cho phÃ©p báº¡n chá»‰ Ä‘á»‹nh tÃªn cá»§a KV binding Ä‘Æ°á»£c sá»­ dá»¥ng cho lÆ°u trá»¯ session. Theo máº·c Ä‘á»‹nh, Ä‘iá»u nÃ y Ä‘Æ°á»£c Ä‘áº·t thÃ nh `SESSION`, nhÆ°ng báº¡n cÃ³ thá»ƒ thay Ä‘á»•i Ä‘á»ƒ khá»›p vá»›i tÃªn KV binding cá»§a riÃªng báº¡n. Xem [Sessions](#sessions) Ä‘á»ƒ biáº¿t thÃªm thÃ´ng tin.

```js title="astro.config.mjs" "MY_SESSION_BINDING"
export default defineConfig({
  adapter: cloudflare({
    sessionKVBindingName: 'MY_SESSION_BINDING',
  }),
});
```

## Cloudflare runtime

### Sá»­ dá»¥ng

Runtime Cloudflare cung cáº¥p cho báº¡n quyá»n truy cáº­p vÃ o cÃ¡c biáº¿n mÃ´i trÆ°á»ng vÃ  bindings Ä‘áº¿n tÃ i nguyÃªn Cloudflare.
Runtime Cloudflare sá»­ dá»¥ng bindings Ä‘Æ°á»£c tÃ¬m tháº¥y trong tá»‡p cáº¥u hÃ¬nh `wrangler.toml`/`wrangler.json`.

Báº¡n cÃ³ thá»ƒ truy cáº­p bindings tá»« `Astro.locals.runtime`:

```astro title="src/pages/index.astro"
---
const { env } = Astro.locals.runtime;
---
```
Báº¡n cÃ³ thá»ƒ truy cáº­p runtime tá»« API endpoints thÃ´ng qua `context.locals`:

```js title="src/pages/api/someFile.js"
export function GET(context) {
  const runtime = context.locals.runtime;

  return new Response('Some body');
}
```

Xem [danh sÃ¡ch táº¥t cáº£ bindings Ä‘Æ°á»£c há»— trá»£](https://developers.cloudflare.com/workers/wrangler/api/#supported-bindings) trong tÃ i liá»‡u Cloudflare.

### Biáº¿n mÃ´i trÆ°á»ng vÃ  secrets

Runtime Cloudflare coi biáº¿n mÃ´i trÆ°á»ng nhÆ° má»™t loáº¡i binding.

VÃ­ dá»¥, báº¡n cÃ³ thá»ƒ Ä‘á»‹nh nghÄ©a má»™t [biáº¿n mÃ´i trÆ°á»ng](https://developers.cloudflare.com/workers/configuration/environment-variables/#add-environment-variables-via-wrangler) trong `wrangler.json` nhÆ° sau:

```json title="wrangler.json"
{
  "vars" : {
    "MY_VARIABLE": "test"
  }
}
```

Secrets lÃ  má»™t loáº¡i biáº¿n mÃ´i trÆ°á»ng Ä‘áº·c biá»‡t cho phÃ©p báº¡n Ä‘Ã­nh kÃ¨m cÃ¡c giÃ¡ trá»‹ vÄƒn báº£n Ä‘Æ°á»£c mÃ£ hÃ³a vÃ o Worker cá»§a báº¡n. ChÃºng cáº§n Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a khÃ¡c Ä‘á»ƒ Ä‘áº£m báº£o chÃºng khÃ´ng hiá»ƒn thá»‹ sau khi báº¡n Ä‘áº·t chÃºng.

Äá»ƒ Ä‘á»‹nh nghÄ©a `secrets`, thÃªm chÃºng thÃ´ng qua [Wrangler CLI](https://developers.cloudflare.com/workers/wrangler/) thay vÃ¬ trong tá»‡p cáº¥u hÃ¬nh Wrangler cá»§a báº¡n.

```bash
npx wrangler secret put <KEY>
```

Äá»ƒ Ä‘áº·t secrets cho development cá»¥c bá»™, báº¡n cÅ©ng cáº§n thÃªm tá»‡p `.dev.vars` vÃ o gá»‘c dá»± Ã¡n Astro:

```ini title=".dev.vars"
DB_PASSWORD=myPassword
```

Sau Ä‘Ã³ báº¡n cÃ³ thá»ƒ truy cáº­p biáº¿n mÃ´i trÆ°á»ng, bao gá»“m secrets, tá»« Ä‘á»‘i tÆ°á»£ng `env` cÃ³ sáºµn tá»« `Astro.locals.runtime`:

```astro title="src/pages/index.astro"
---
const { env } = Astro.locals.runtime;
const myVariable = env.MY_VARIABLE;
const secret = env.DB_PASSWORD;
---
```

Biáº¿n mÃ´i trÆ°á»ng vÃ  secrets cá»§a Cloudflare tÆ°Æ¡ng thÃ­ch vá»›i [API `astro:env`](/en/guides/environment-variables/#type-safe-environment-variables).

### Typing

`wrangler` cung cáº¥p lá»‡nh `types` Ä‘á»ƒ táº¡o TypeScript types cho bindings. Äiá»u nÃ y cho phÃ©p báº¡n type locals mÃ  khÃ´ng cáº§n pháº£i type thá»§ cÃ´ng chÃºng. Tham kháº£o [tÃ i liá»‡u Cloudflare](https://developers.cloudflare.com/workers/wrangler/commands/#types) Ä‘á»ƒ biáº¿t thÃªm thÃ´ng tin.

Má»—i khi báº¡n thay Ä‘á»•i cÃ¡c tá»‡p cáº¥u hÃ¬nh (vÃ­ dá»¥ `wrangler.toml`, `.dev.vars`) báº¡n cáº§n cháº¡y `wrangler types`.

:::note
Báº¡n cÃ³ thá»ƒ táº¡o script pnpm Ä‘á»ƒ cháº¡y `wrangler types` tá»± Ä‘á»™ng trÆ°á»›c cÃ¡c lá»‡nh khÃ¡c.

```json title="package.json"
{
  "scripts": {
    "dev": "wrangler types && astro dev",
    "start": "wrangler types && astro dev",
    "build": "wrangler types && astro check && astro build",
    "preview": "wrangler types && astro preview",
    "astro": "astro"
  }
}
```
:::

Báº¡n cÃ³ thá»ƒ type Ä‘á»‘i tÆ°á»£ng `runtime` báº±ng `Runtime`:

```ts title="src/env.d.ts"
type Runtime = import('@astrojs/cloudflare').Runtime<Env>;

declare namespace App {
  interface Locals extends Runtime {
    otherLocals: {
      test: string;
    };
  }
}
```

## Ná»n táº£ng Cloudflare

### Headers

Báº¡n cÃ³ thá»ƒ Ä‘Ã­nh kÃ¨m [custom headers](https://developers.cloudflare.com/pages/platform/headers/) vÃ o responses cá»§a báº¡n báº±ng cÃ¡ch thÃªm tá»‡p `_headers` trong thÆ° má»¥c `public/` cá»§a dá»± Ã¡n Astro. Tá»‡p nÃ y sáº½ Ä‘Æ°á»£c sao chÃ©p vÃ o thÆ° má»¥c build output cá»§a báº¡n.

Äiá»u nÃ y cÃ³ sáºµn trÃªn Cloudflare Workers vÃ  Pages.

### Assets
Assets Ä‘Æ°á»£c xÃ¢y dá»±ng bá»Ÿi Astro Ä‘á»u Ä‘Æ°á»£c Ä‘áº·t tÃªn vá»›i hash vÃ  do Ä‘Ã³ cÃ³ thá»ƒ Ä‘Æ°á»£c cung cáº¥p headers cache dÃ i. Theo máº·c Ä‘á»‹nh, Astro trÃªn Cloudflare sáº½ thÃªm header nhÆ° váº­y cho nhá»¯ng tá»‡p nÃ y.

### Redirects

Báº¡n cÃ³ thá»ƒ khai bÃ¡o [custom redirects](https://developers.cloudflare.com/pages/platform/redirects/) Ä‘á»ƒ chuyá»ƒn hÆ°á»›ng yÃªu cáº§u Ä‘áº¿n URL khÃ¡c. Äá»ƒ lÃ m Ä‘iá»u nÃ y, thÃªm tá»‡p `_redirects` trong thÆ° má»¥c `public/` cá»§a dá»± Ã¡n Astro. Tá»‡p nÃ y sáº½ Ä‘Æ°á»£c sao chÃ©p vÃ o thÆ° má»¥c build output cá»§a báº¡n.

Äiá»u nÃ y cÃ³ sáºµn trÃªn Cloudflare Workers vÃ  Pages.

### Routes
#### Routing trÃªn Cloudflare Workers

Routing cho tÃ i sáº£n tÄ©nh dá»±a trÃªn cáº¥u trÃºc tá»‡p trong thÆ° má»¥c build (vÃ­ dá»¥ `./dist`). Náº¿u khÃ´ng tÃ¬m tháº¥y káº¿t quáº£ khá»›p, Ä‘iá»u nÃ y sáº½ fallback vá» Worker Ä‘á»ƒ rendering theo yÃªu cáº§u. Äá»c thÃªm vá» [static asset routing vá»›i Cloudflare Workers](https://developers.cloudflare.com/workers/static-assets/routing/).

KhÃ´ng giá»‘ng nhÆ° [Cloudflare Pages](#routing-on-cloudflare-pages), vá»›i Workers, báº¡n khÃ´ng cáº§n tá»‡p `_routes.json`.

Hiá»‡n táº¡i, adapter Cloudflare luÃ´n táº¡o tá»‡p nÃ y. Äá»ƒ workaround, táº¡o tá»‡p `.assetsignore` trong thÆ° má»¥c `public/` cá»§a báº¡n, vÃ  thÃªm cÃ¡c dÃ²ng sau vÃ o Ä‘Ã³:
  ```txt title="public/.assetsignore"
  _worker.js
  _routes.json
  ```

#### Routing trÃªn Cloudflare Pages

Äá»‘i vá»›i Cloudflare Pages, [routing](https://developers.cloudflare.com/pages/platform/functions/routing/#functions-invocation-routes) sá»­ dá»¥ng tá»‡p `_routes.json` Ä‘á»ƒ xÃ¡c Ä‘á»‹nh yÃªu cáº§u nÃ o Ä‘Æ°á»£c Ä‘á»‹nh tuyáº¿n Ä‘áº¿n server function vÃ  cÃ¡i nÃ o Ä‘Æ°á»£c phá»¥c vá»¥ nhÆ° tÃ i sáº£n tÄ©nh. Theo máº·c Ä‘á»‹nh, tá»‡p `_routes.json` sáº½ Ä‘Æ°á»£c tá»± Ä‘á»™ng táº¡o cho dá»± Ã¡n cá»§a báº¡n dá»±a trÃªn cÃ¡c tá»‡p vÃ  cáº¥u hÃ¬nh cá»§a nÃ³.

Báº¡n cÃ³ thá»ƒ [chá»‰ Ä‘á»‹nh cÃ¡c pattern routing bá»• sung Ä‘á»ƒ tuÃ¢n theo](#routesextend) trong cáº¥u hÃ¬nh adapter cá»§a báº¡n, hoáº·c táº¡o tá»‡p `_routes.json` tÃ¹y chá»‰nh cá»§a riÃªng báº¡n Ä‘á»ƒ hoÃ n toÃ n ghi Ä‘Ã¨ viá»‡c táº¡o tá»± Ä‘á»™ng.

Táº¡o `public/_routes.json` tÃ¹y chá»‰nh sáº½ ghi Ä‘Ã¨ viá»‡c táº¡o tá»± Ä‘á»™ng. Xem [tÃ i liá»‡u Cloudflare vá» táº¡o `_routes.json` tÃ¹y chá»‰nh](https://developers.cloudflare.com/pages/platform/functions/routing/#create-a-_routesjson-file) Ä‘á»ƒ biáº¿t thÃªm chi tiáº¿t.

## Sessions

[API Sessions](/en/guides/sessions/) cá»§a Astro cho phÃ©p báº¡n dá»… dÃ ng lÆ°u trá»¯ dá»¯ liá»‡u ngÆ°á»i dÃ¹ng giá»¯a cÃ¡c yÃªu cáº§u. Äiá»u nÃ y cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng cho nhá»¯ng thá»© nhÆ° dá»¯ liá»‡u vÃ  tÃ¹y chá»n ngÆ°á»i dÃ¹ng, giá» hÃ ng, vÃ  thÃ´ng tin Ä‘Äƒng nháº­p. KhÃ´ng giá»‘ng nhÆ° lÆ°u trá»¯ cookie, khÃ´ng cÃ³ giá»›i háº¡n kÃ­ch thÆ°á»›c trÃªn dá»¯ liá»‡u, vÃ  nÃ³ cÃ³ thá»ƒ Ä‘Æ°á»£c khÃ´i phá»¥c trÃªn cÃ¡c thiáº¿t bá»‹ khÃ¡c nhau.

Astro tá»± Ä‘á»™ng cáº¥u hÃ¬nh [Workers KV](https://developers.cloudflare.com/kv/) cho lÆ°u trá»¯ session khi sá»­ dá»¥ng adapter Cloudflare. TrÆ°á»›c khi sá»­ dá»¥ng sessions, báº¡n cáº§n táº¡o namespace KV Ä‘á»ƒ lÆ°u trá»¯ dá»¯ liá»‡u vÃ  cáº¥u hÃ¬nh KV binding trong tá»‡p cáº¥u hÃ¬nh Wrangler cá»§a báº¡n. Theo máº·c Ä‘á»‹nh, Astro mong Ä‘á»£i KV binding Ä‘Æ°á»£c Ä‘áº·t tÃªn `SESSION`, nhÆ°ng báº¡n cÃ³ thá»ƒ chá»n tÃªn khÃ¡c náº¿u báº¡n muá»‘n báº±ng cÃ¡ch Ä‘áº·t tÃ¹y chá»n [`sessionKVBindingName`](#sessionkvbindingname) trong cáº¥u hÃ¬nh adapter.

<Steps>

1. Táº¡o namespace KV báº±ng Wrangler CLI vÃ  ghi chÃº ID cá»§a namespace má»›i:

   ```sh
   npx wrangler kv namespace create "SESSION"
   ```

2. Khai bÃ¡o namespace KV trong cáº¥u hÃ¬nh Wrangler cá»§a báº¡n, Ä‘áº·t namespace ID thÃ nh cÃ¡i Ä‘Æ°á»£c tráº£ vá» bá»Ÿi lá»‡nh trÆ°á»›c:

    <Tabs>
      <TabItem label="wrangler.json">
        ```json title="wrangler.json" "<KV_NAMESPACE_ID>"
        {
          "kv_namespaces": [
            {
              "binding": "SESSION",
              "id": "<KV_NAMESPACE_ID>"
            }
          ]
        }
        ```
      </TabItem>
      <TabItem label="wrangler.toml">
        ```toml title="wrangler.toml" "<KV_NAMESPACE_ID>"
        kv_namespaces = [
          { binding = "SESSION", id = "<KV_NAMESPACE_ID>" }
        ]
        ```
      </TabItem>
    </Tabs>

3. Sau Ä‘Ã³ báº¡n cÃ³ thá»ƒ sá»­ dá»¥ng sessions trong server code cá»§a báº¡n:

    ```astro title="src/components/CartButton.astro" "Astro.session?.get('cart')"
    ---
    export const prerender = false;
    const cart = await Astro.session?.get('cart');
    ---

    <a href="/checkout">ğŸ›’ {cart?.length ?? 0} items</a>
    ```

</Steps>

:::note
Ghi vÃ o Cloudflare KV lÃ  [eventually consistent](https://developers.cloudflare.com/kv/concepts/how-kv-works/#consistency) giá»¯a cÃ¡c vÃ¹ng. Äiá»u nÃ y cÃ³ nghÄ©a lÃ  cÃ¡c thay Ä‘á»•i cÃ³ sáºµn ngay láº­p tá»©c trong cÃ¹ng má»™t vÃ¹ng nhÆ°ng cÃ³ thá»ƒ máº¥t Ä‘áº¿n 60 giÃ¢y Ä‘á»ƒ lan truyá»n toÃ n cáº§u. Äiá»u nÃ y sáº½ khÃ´ng áº£nh hÆ°á»Ÿng Ä‘áº¿n háº§u háº¿t ngÆ°á»i dÃ¹ng vÃ¬ há» khÃ´ng cÃ³ kháº£ nÄƒng chuyá»ƒn Ä‘á»•i vÃ¹ng giá»¯a cÃ¡c yÃªu cáº§u, nhÆ°ng nÃ³ cÃ³ thá»ƒ lÃ  má»™t cÃ¢n nháº¯c cho má»™t sá»‘ trÆ°á»ng há»£p sá»­ dá»¥ng, cháº³ng háº¡n nhÆ° ngÆ°á»i dÃ¹ng VPN.
:::

## Cloudflare Module Imports

Runtime `workerd` cá»§a Cloudflare há»— trá»£ imports cá»§a má»™t sá»‘ [loáº¡i module khÃ´ng chuáº©n](https://developers.cloudflare.com/workers/wrangler/bundling/#including-non-javascript-modules). Háº§u háº¿t cÃ¡c loáº¡i tá»‡p bá»• sung cÅ©ng cÃ³ sáºµn trong Astro:

- `.wasm` hoáº·c `.wasm?module`: xuáº¥t má»™t [`WebAssembly.Module`](https://developer.mozilla.org/en-US/docs/WebAssembly/JavaScript_interface/Module) cÃ³ thá»ƒ Ä‘Æ°á»£c khá»Ÿi táº¡o sau Ä‘Ã³
- `.bin`: xuáº¥t má»™t [`ArrayBuffer`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer) cá»§a ná»™i dung binary thÃ´ cá»§a tá»‡p
- `.txt`: xuáº¥t má»™t string cá»§a ná»™i dung tá»‡p

Táº¥t cáº£ cÃ¡c loáº¡i module Ä‘á»u xuáº¥t má»™t giÃ¡ trá»‹ máº·c Ä‘á»‹nh duy nháº¥t. Modules cÃ³ thá»ƒ Ä‘Æ°á»£c import cáº£ tá»« cÃ¡c trang server-side rendered, hoáº·c tá»« cÃ¡c trang prerendered Ä‘á»ƒ táº¡o trang web tÄ©nh.

Sau Ä‘Ã¢y lÃ  vÃ­ dá»¥ vá» import module Wasm sau Ä‘Ã³ tráº£ lá»i yÃªu cáº§u báº±ng cÃ¡ch cá»™ng cÃ¡c tham sá»‘ sá»‘ cá»§a yÃªu cáº§u láº¡i vá»›i nhau.

```js title="pages/add/[a]/[b].js"
// Import WebAssembly module
import mod from '../util/add.wasm';

// Khá»Ÿi táº¡o trÆ°á»›c Ä‘á»ƒ sá»­ dá»¥ng nÃ³
const addModule: any = new WebAssembly.Instance(mod);

export async function GET(context) {
  const a = Number.parseInt(context.params.a);
  const b = Number.parseInt(context.params.b);
  return new Response(`${addModule.exports.add(a, b)}`);
}
```

Máº·c dÃ¹ vÃ­ dá»¥ nÃ y táº§m thÆ°á»ng, Wasm cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ tÄƒng tá»‘c cÃ¡c hoáº¡t Ä‘á»™ng tÃ­nh toÃ¡n phá»©c táº¡p khÃ´ng liÃªn quan Ä‘áº¿n I/O Ä‘Ã¡ng ká»ƒ nhÆ° nhÃºng thÆ° viá»‡n xá»­ lÃ½ hÃ¬nh áº£nh, hoáº·c nhÃºng cÆ¡ sá»Ÿ dá»¯ liá»‡u nhá» Ä‘Ã£ Ä‘Æ°á»£c láº­p chá»‰ má»¥c trÆ°á»›c Ä‘á»ƒ tÃ¬m kiáº¿m trÃªn dataset chá»‰ Ä‘á»c.

## TÆ°Æ¡ng thÃ­ch Node.js

Theo máº·c Ä‘á»‹nh, Cloudflare khÃ´ng há»— trá»£ cÃ¡c API runtime Node.js. Vá»›i má»™t sá»‘ cáº¥u hÃ¬nh, Cloudflare há»— trá»£ má»™t táº­p con cÃ¡c API runtime Node.js. Báº¡n cÃ³ thá»ƒ tÃ¬m cÃ¡c API runtime Node.js Ä‘Æ°á»£c há»— trá»£ trong [tÃ i liá»‡u](https://developers.cloudflare.com/workers/runtime-apis/nodejs) cá»§a Cloudflare.

Äá»ƒ sá»­ dá»¥ng cÃ¡c API nÃ y, trang hoáº·c endpoint cá»§a báº¡n pháº£i Ä‘Æ°á»£c server-side rendered (khÃ´ng pre-rendered) vÃ  pháº£i sá»­ dá»¥ng cÃº phÃ¡p import `import {} from 'node:*'`.

```js title="pages/api/endpoint.js"
export const prerender = false;
import { Buffer } from 'node:buffer';
```

Báº¡n cÅ©ng sáº½ cáº§n sá»­a Ä‘á»•i cáº¥u hÃ¬nh `vite` trong cáº¥u hÃ¬nh Astro cá»§a báº¡n Ä‘á»ƒ cho phÃ©p cÃº phÃ¡p import `node:*`:

```js title="astro.config.mjs" ins={6-10}
import {defineConfig} from "astro/config";
import cloudflare from '@astrojs/cloudflare';

export default defineConfig({
  adapter: cloudflare({}),
  vite: {
		ssr: {
			external: ['node:buffer'],
		},
	},
})
```

NgoÃ i ra, báº¡n sáº½ cáº§n tuÃ¢n theo tÃ i liá»‡u cá»§a Cloudflare vá» cÃ¡ch báº­t há»— trá»£. Äá»ƒ Ä‘Æ°á»£c hÆ°á»›ng dáº«n chi tiáº¿t, vui lÃ²ng tham kháº£o [tÃ i liá»‡u Cloudflare vá» báº­t tÆ°Æ¡ng thÃ­ch Node.js](https://developers.cloudflare.com/workers/runtime-apis/nodejs/).

:::note[TÃ¡c Ä‘á»™ng tÆ°Æ¡ng thÃ­ch gÃ³i]
Náº¿u má»™t dá»± Ã¡n import má»™t gÃ³i vÃ o server sá»­ dá»¥ng API runtime Node.js, Ä‘iá»u nÃ y cÃ³ thá»ƒ gÃ¢y ra váº¥n Ä‘á» khi triá»ƒn khai lÃªn Cloudflare. Váº¥n Ä‘á» nÃ y xáº£y ra vá»›i cÃ¡c gÃ³i khÃ´ng sá»­ dá»¥ng cÃº phÃ¡p import `node:*`. ÄÆ°á»£c khuyáº¿n nghá»‹ báº¡n liÃªn há»‡ vá»›i tÃ¡c giáº£ cá»§a gÃ³i Ä‘á»ƒ xÃ¡c Ä‘á»‹nh xem gÃ³i cÃ³ há»— trá»£ cÃº phÃ¡p import á»Ÿ trÃªn hay khÃ´ng. Náº¿u gÃ³i khÃ´ng há»— trá»£ Ä‘iá»u nÃ y, báº¡n cÃ³ thá»ƒ cáº§n sá»­ dá»¥ng má»™t gÃ³i khÃ¡c.
:::

## Preview vá»›i Wrangler

Äá»ƒ sá»­ dá»¥ng [`wrangler`](https://developers.cloudflare.com/workers/wrangler/) Ä‘á»ƒ cháº¡y á»©ng dá»¥ng cá»§a báº¡n cá»¥c bá»™, cáº­p nháº­t script preview.

Äá»‘i vá»›i Workers:

```json title="package.json"
"preview": "wrangler dev ./dist"
```

Äá»‘i vá»›i Pages:

```json title="package.json"
"preview": "wrangler pages dev ./dist"
```

PhÃ¡t triá»ƒn vá»›i [`wrangler`](https://developers.cloudflare.com/workers/wrangler/) cung cáº¥p cho báº¡n quyá»n truy cáº­p vÃ o [Cloudflare bindings](https://developers.cloudflare.com/pages/platform/functions/bindings), [biáº¿n mÃ´i trÆ°á»ng](https://developers.cloudflare.com/pages/platform/functions/bindings/#environment-variables), vÃ  [Ä‘á»‘i tÆ°á»£ng cf](https://developers.cloudflare.com/workers/runtime-apis/request/#incomingrequestcfproperties). Äá»ƒ hot reloading cá»§a Astro dev server hoáº¡t Ä‘á»™ng vá»›i Wrangler cÃ³ thá»ƒ yÃªu cáº§u thiáº¿t láº­p tÃ¹y chá»‰nh. Xem [vÃ­ dá»¥ cá»™ng Ä‘á»“ng](https://github.com/withastro/roadmap/discussions/590).

### ThÃ´ng bÃ¡o lá»—i cÃ³ Ã½ nghÄ©a

Hiá»‡n táº¡i, lá»—i trong quÃ¡ trÃ¬nh cháº¡y á»©ng dá»¥ng cá»§a báº¡n trong Wrangler khÃ´ng há»¯u Ã­ch láº¯m, do viá»‡c minification code cá»§a báº¡n. Äá»ƒ debug tá»‘t hÆ¡n, báº¡n cÃ³ thá»ƒ thÃªm cÃ i Ä‘áº·t `vite.build.minify = false` vÃ o `astro.config.mjs` cá»§a báº¡n.

```js title="astro.config.mjs" ins={3-7}
export default defineConfig({
  adapter: cloudflare(),
  vite: {
    build: {
      minify: false,
    },
  },
});
```

[astro-integration]: /en/guides/integrations-guide/