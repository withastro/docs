---
title: Sesiones
description: Comparte datos entre solicitudes para p치ginas renderizadas bajo demanda.
i18nReady: true
---

import Since from '~/components/Since.astro';
import ReadMore from '~/components/ReadMore.astro';

<p>
<Since v="5.7.0" />
</p>

Las sesiones se utilizan para compartir datos entre solicitudes para [p치ginas renderizadas bajo demanda](/es/guides/on-demand-rendering/).

A diferencia de las [`cookies`](/es/guides/on-demand-rendering/#cookies), las sesiones se almacenan en el servidor, por lo que puedes almacenar grandes cantidades de datos sin preocuparte por l칤mites de tama침o o problemas de seguridad. Son 칰tiles para almacenar cosas como datos de usuario, carritos de compra y estados de formularios, y funcionan sin ning칰n JavaScript del lado del cliente:

```astro title="src/components/CartButton.astro" {3}
---
export const prerender = false; // No es necesario con la salida 'server'
const cart = await Astro.session.get('cart');
---

<a href="/checkout">游 {cart?.length ?? 0} art칤culos</a>
````

## Configuraci칩n de sesiones

Las sesiones requieren un controlador de almacenamiento para guardar los datos de la sesi칩n. Los adaptadores de [Node](/es/guides/integrations-guide/node/#sessions), [Cloudflare](/es/guides/integrations-guide/cloudflare/#sessions) y [Netlify](/es/guides/integrations-guide/netlify/#sessions) configuran autom치ticamente un controlador predeterminado para ti, pero otros adaptadores actualmente requieren que [especifiques un controlador manualmente](/es/reference/configuration-reference/#sessiondriver).

```js title="astro.config.mjs" ins={4}
  {
    adapter: vercel(),
    session: {
      driver: "redis",
    },
  }
```

<ReadMore>
  Consulta [la opci칩n de configuraci칩n `session`](/es/reference/configuration-reference/#session-options) para obtener m치s detalles sobre c칩mo configurar un controlador de almacenamiento y otras opciones configurables.
</ReadMore>

## Interacci칩n con datos de sesi칩n

El [`objeto session`](/es/reference/api-reference/#session) te permite interactuar con el estado de usuario almacenado (por ejemplo, agregar art칤culos a un carrito de compras) y el ID de sesi칩n (por ejemplo, eliminar la cookie del ID de sesi칩n al cerrar sesi칩n). El objeto es accesible como `Astro.session` en tus componentes y p치ginas de Astro y como el objeto `context.session` en endpoints de API, middleware y acciones.

La sesi칩n se genera autom치ticamente cuando se usa por primera vez y se puede regenerar en cualquier momento con [`session.regenerate()`](/es/reference/api-reference/#regenerate) o destruir con [`session.destroy()`](/es/reference/api-reference/#destroy).

Para muchos casos de uso, solo necesitar치s usar [`session.get()`](/es/reference/api-reference/#get) y [`session.set()`](/es/reference/api-reference/#set).

<ReadMore>
Consulta [la referencia de la API de Sesiones](/es/reference/api-reference/#session) para obtener m치s detalles.
</ReadMore>

### Componentes y p치ginas de Astro

En componentes y p치ginas `.astro`, puedes acceder al objeto de sesi칩n a trav칠s del objeto global `Astro`. Por ejemplo, para mostrar el n칰mero de art칤culos en un carrito de compras:

```astro title="src/components/CartButton.astro" "Astro.session"
---
export const prerender = false; // No es necesario con la salida 'server'
const cart = await Astro.session.get('cart');
---

<a href="/checkout">游 {cart?.length ?? 0} art칤culos</a>
```

### Endpoints de API

En endpoints de API, el objeto de sesi칩n est치 disponible en el objeto `context`. Por ejemplo, para agregar un art칤culo a un carrito de compras:

```ts title="src/pages/api/addToCart.ts" "context.session"
export async function POST(context: APIContext) {
  const cart = await context.session.get('cart') || [];
  const data = await context.request.json<{ item: string }>();
  if(!data?.item) {
    return new Response('Art칤culo requerido', { status: 400 });
  }
  cart.push(data.item);
  await context.session.set('cart', cart);
  return Response.json(cart);
}
```

### Acciones

En acciones, el objeto de sesi칩n est치 disponible en el objeto `context`. Por ejemplo, para agregar un art칤culo a un carrito de compras:

```ts title="src/actions/addToCart.ts" "context.session"
import { defineAction } from 'astro:actions';
import { z } from 'astro:schema';

export const server = {
  addToCart: defineAction({
    input: z.object({ productId: z.string() }),
    handler: async (input, context) => {
      const cart = await context.session.get('cart');
      cart.push(input.productId);
      await context.session.set('cart', cart);
      return cart;
    },
  }),
};
```

### Middleware

:::note
Las sesiones no son compatibles actualmente en middleware de borde.
:::

En middleware, el objeto de sesi칩n est치 disponible en el objeto `context`. Por ejemplo, para establecer la 칰ltima hora de visita en la sesi칩n:

```ts title="src/middleware.ts" "context.session"
import { defineMiddleware } from 'astro:middleware';

export const onRequest = defineMiddleware(async (context, next) => {
  context.session.set('lastVisit', new Date());
  return next();
});
```

## Tipos de datos de sesi칩n

De forma predeterminada, los datos de sesi칩n no est치n tipados y puedes almacenar datos arbitrarios en cualquier clave. Los valores se serializan y deserializan utilizando [devalue](https://github.com/Rich-Harris/devalue), que es la misma biblioteca utilizada en colecciones de contenido y acciones. Esto significa que los tipos admitidos son los mismos e incluyen cadenas, n칰meros, `Date`, `Map`, `Set`, `URL`, matrices y objetos planos.

Opcionalmente, puedes definir tipos de TypeScript para tus datos de sesi칩n creando un archivo `src/env.d.ts` y agregando una declaraci칩n para el tipo `App.SessionData`:

```ts title="src/env.d.ts"
declare namespace App {
  interface SessionData {
    user: {
      id: string;
      name: string;
    };
    cart: string[];
  }
}
```

Esto te permitir치 acceder a los datos de la sesi칩n con verificaci칩n de tipos y autocompletado en tu editor:

```ts title="src/components/CartButton.astro"
---
const cart = await Astro.session.get('cart');
// const cart: string[] | undefined

const something = await Astro.session.get('something');
// const something: any

Astro.session.set('user', { id: 1, name: 'Houston' });
// Error: El argumento de tipo '{ id: number; name: string }' no se puede asignar al par치metro de tipo '{ id: string; name: string; }'.
---
```

:::caution
Esto solo se utiliza para la verificaci칩n de tipos y no afecta el comportamiento en tiempo de ejecuci칩n de la sesi칩n. Ten mucho cuidado si cambias el tipo cuando los usuarios tienen datos almacenados en la sesi칩n, ya que esto podr칤a causar errores en tiempo de ejecuci칩n.
:::
