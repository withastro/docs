---
title: Sesiones
description: Comparte datos entre solicitudes para p치ginas renderizadas bajo demanda.
i18nReady: true
---

import Since from '~/components/Since.astro';
import ReadMore from '~/components/ReadMore.astro';

<p>
<Since v="5.7.0" />
</p>

Las sesiones se utilizan para compartir datos entre solicitudes para [p치ginas renderizadas bajo demanda](/es/guides/on-demand-rendering/).

En tercera persona y en espa침ol:

A diferencia de las [`cookies`](/es/guides/on-demand-rendering/#cookies), las sesiones se almacenan en el servidor, por lo que es posible guardar cantidades mayores de datos sin preocuparse por los l칤mites de tama침o o problemas de seguridad. Son 칰tiles para almacenar cosas como datos de usuario, carritos de compra y el estado de formularios, y funcionan sin necesidad de JavaScript del lado del cliente:

```astro title="src/components/CartButton.astro" {3}
---
export const prerender = false; // No es necesario con la salida `'server'`

const cart = await Astro.session?.get('cart');
---

<a href="/checkout">游 {cart?.length ?? 0} art칤culos</a>
```

## Configurando de sesiones

{/* TODO: add link to 
 - Node: /es/guides/integrations-guide/node/#sesiones, 
 - cloudflare: /es/guides/integrations-guide/cloudflare/#sesiones
 - netlify: /es/guides/integrations-guide/netlify/#sessions
 - controlador: /es/reference/configuration-reference/#sessiondriver
*/}
Las sesiones requieren un controlador de almacenamiento para guardar los datos de la sesi칩n. Los adaptadores de Node, Cloudflare y Netlify configuran autom치ticamente un controlador predeterminado para ti, pero otros adaptadores actualmente requieren que especifiques un controlador manualmente.

```js title="astro.config.mjs" ins={4}
  {
    adapter: vercel(),
    session: {
      driver: "redis",
    },
  }
```

{/* TODO: add link to session options /en/reference/configuration-reference/#session-options*/}
<ReadMore>
  Consulta las opciones de configuraci칩n de `session` para m치s detalles sobre c칩mo establecer un controlador de almacenamiento y otras opciones configurables.
</ReadMore>

## Interactuando con los datos de la sesi칩n

{/* TODO: add link to /en/reference/api-reference/#session*/}
El `objeto session` te permite interactuar con el estado almacenado del usuario (por ejemplo, agregar art칤culos a un carrito de compras) y con el ID de la sesi칩n (por ejemplo, eliminar la cookie del ID de sesi칩n al cerrar sesi칩n). El objeto es accesible como `Astro.session` en tus componentes y p치ginas de Astro, y como `context.session` en endpoints API, middleware y acciones.

{/* TODO: add link to /en/reference/api-reference/#regenerate and /es/reference/api-reference/#destroy */}
La sesi칩n se genera autom치ticamente cuando se usa por primera vez y puede regenerarse en cualquier momento con `session.regenerate()` o destruirse con `session.destroy()`.

{/* TODO: add link to /en/reference/api-reference/#get and /en/reference/api-reference/#set*/}
Para muchos casos de uso, solo necesitar치s usar `session.get()` y `session.set()`.

<ReadMore>
{/* TODO: add link to /en/reference/api-reference/#session*/}
Consulta la referencia de la API de Sesiones para m치s detalles.
</ReadMore>

### Componentes y p치ginas de Astro

En los componentes y p치ginas `.astro`, puedes acceder al objeto sesi칩n a trav칠s del objeto global `Astro`. Por ejemplo, para mostrar el n칰mero de art칤culos en un carrito de compras:

```astro title="src/components/CartButton.astro" "Astro.session"
---
export const prerender = false; // No es necesario con la salida 'server'
const cart = await Astro.session?.get('cart');
---

<a href="/checkout">游 {cart?.length ?? 0} art칤culos</a>
```

### Endpoints API

En los endpoints de la API, el objeto sesi칩n est치 disponible en el objeto `context`. Por ejemplo, para agregar un art칤culo a un carrito de compras:

```ts title="src/pages/api/addToCart.ts" "context.session"
export async function POST(context: APIContext) {
  const cart = await context.session?.get('cart') || [];
	const data = await context.request.json<{ item: string }>();
  if(!data?.item) {
    return new Response('Item is required', { status: 400 });
  }
  cart.push(data.item);
  await context.session?.set('cart', cart);
  return Response.json(cart);
}
```

### Acciones

En las acciones, el objeto sesi칩n est치 disponible en el objeto `context`. Por ejemplo, para agregar un art칤culo a un carrito de compras:

```ts title="src/actions/addToCart.ts" "context.session"
import { defineAction } from 'astro:actions';
import { z } from 'astro:schema';

export const server = {
  addToCart: defineAction({
    input: z.object({ productId: z.string() }),
    handler: async (input, context) => {
      const cart = await context.session?.get('cart');
      cart.push(input.productId);
      await context.session?.set('cart', cart);
      return cart;
    },
  }),
};
```

### Middleware

:::note
Las sesiones no son compatibles con middleware en el edge.
:::

En el middleware, el objeto sesi칩n est치 disponible en el objeto `context`. Por ejemplo, para establecer la hora de la 칰ltima visita en la sesi칩n:

```ts title="src/middleware.ts" "context.session"
import { defineMiddleware } from 'astro:middleware';

export const onRequest = defineMiddleware(async (context, next) => {
  context.session?.set('lastVisit', new Date());
  return next();
});
```

## Tipos de datos de la sesi칩n

Por defecto, los datos de la sesi칩n no tienen un tipo espec칤fico, y puedes almacenar datos arbitrarios en cualquier clave. Los valores se serializan y deserializan usando [devalue](https://github.com/Rich-Harris/devalue), que es la misma biblioteca utilizada en colecciones de contenido y acciones. Esto significa que los tipos compatibles son los mismos, e incluyen cadenas, n칰meros, `Date`, `Map`, `Set`, `URL`, arreglos y objetos simples.

Opcionalmente, puedes definir tipos TypeScript para tus datos de sesi칩n creando un archivo `src/env.d.ts` y agregando una declaraci칩n para el tipo `App.SessionData`:

```ts title="src/env.d.ts"
declare namespace App {
  interface SessionData {
    user: {
      id: string;
      name: string;
    };
    cart: string[];
  }
}
```

Esto te permitir치 acceder a los datos de la sesi칩n con verificaci칩n de tipos y autocompletado en tu editor:

```ts title="src/components/CartButton.astro"
---
const cart = await Astro.session?.get('cart');
// const cart: string[] | undefined

const something = await Astro.session?.get('something');
// const something: any

Astro.session?.set('user', { id: 1, name: 'Houston' });
// Error: Argument of type '{ id: number; name: string }' is not assignable to parameter of type '{ id: string; name: string; }'.
---
```

:::caution
Esto solo se utiliza para la verificaci칩n de tipos y no afecta el comportamiento en tiempo de ejecuci칩n de la sesi칩n. Ten especial cuidado si cambias el tipo cuando los usuarios ya han almacenado datos en la sesi칩n, ya que esto podr칤a causar errores en tiempo de ejecuci칩n.
:::
