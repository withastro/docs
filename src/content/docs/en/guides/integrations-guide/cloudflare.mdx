---
type: integration
title: '@astrojs/cloudflare'
description: Learn how to use the @astrojs/cloudflare adapter to deploy your Astro project.
sidebar:
  label: Cloudflare
githubIntegrationURL: 'https://github.com/withastro/astro/tree/main/packages/integrations/cloudflare/'
category: adapter
i18nReady: true
---

import PackageManagerTabs from '~/components/tabs/PackageManagerTabs.astro';
import ReadMore from '~/components/ReadMore.astro';
import Since from '~/components/Since.astro';
import { Tabs, TabItem, Steps, Aside } from '@astrojs/starlight/components';

This adapter allows Astro to deploy your [on-demand rendered routes and features](/en/guides/on-demand-rendering/) to [Cloudflare](https://www.cloudflare.com/), including [server islands](/en/guides/server-islands/), [actions](/en/guides/actions/), and [sessions](/en/guides/sessions/).

If you're using Astro as a static site builder, you don't need an adapter.

Learn how to deploy your Astro site in our [Cloudflare deployment guide](/en/guides/deploy/cloudflare/).

<Aside title="Upgrading to Astro 6?">
  See the [Astro 6 upgrade instructions](#upgrading-to-astro-6) for breaking changes and migration
  guidance.
</Aside>

## Why Astro Cloudflare

Cloudflare's [Developer Platform](https://developers.cloudflare.com/) lets you develop full-stack applications with access to resources such as storage and AI, all deployed to a global edge network. This adapter builds your Astro project for deployment through Cloudflare.

## Installation

Astro includes an `astro add` command to automate the setup of official integrations. If you prefer, you can [install integrations manually](#manual-install) instead.

Add the Cloudflare adapter to enable server-rendering in your Astro project with the `astro add` command. This will install `@astrojs/cloudflare` and make the appropriate changes to your `astro.config.mjs` file in one step.

<PackageManagerTabs>
  <Fragment slot="npm">
  ```sh
  npx astro add cloudflare
  ```
  </Fragment>
  <Fragment slot="pnpm">
  ```sh
  pnpm astro add cloudflare
  ```
  </Fragment>
  <Fragment slot="yarn">
  ```sh
  yarn astro add cloudflare
  ```
  </Fragment>
</PackageManagerTabs>

Now, you can enable [on-demand rendering per page](/en/guides/on-demand-rendering/#enabling-on-demand-rendering), or set your build output configuration to `output: 'server'` to [server-render all your pages by default](/en/guides/on-demand-rendering/#server-mode).

### Manual Install

<Steps>

1. Add the `@astrojs/cloudflare` adapter to your project's dependencies using your preferred package manager.

    <PackageManagerTabs>
      <Fragment slot="npm">
      ```sh
      npm install @astrojs/cloudflare
      ```
      </Fragment>
      <Fragment slot="pnpm">
      ```sh
      pnpm add @astrojs/cloudflare
      ```
      </Fragment>
      <Fragment slot="yarn">
      ```sh
      yarn add @astrojs/cloudflare
      ```
      </Fragment>
    </PackageManagerTabs>

2. Add the adapter to your `astro.config.mjs` file:

   ```js title="astro.config.mjs" ins={2,5}
   import { defineConfig } from 'astro/config';
   import cloudflare from '@astrojs/cloudflare';

   export default defineConfig({
     adapter: cloudflare(),
   });
   ```

3. Optionally, create a [Wrangler configuration file](https://developers.cloudflare.com/workers/wrangler/configuration/) if you need custom settings, or to declare Cloudflare bindings (KV, D1, Durable Objects, etc.):

   ```jsonc title="wrangler.jsonc"
   {
     "name": "my-astro-app",
     // Add your bindings here, e.g.:
     // "kv_namespaces": [{ "binding": "MY_KV", "id": "<namespace_id>" }]
   }
   ```

   For simple projects without bindings, you can skip this step as Astro will generate a default configuration automatically. The Worker name will be based on the `package.json` name field or the folder name.

</Steps>

## Options

The Cloudflare adapter accepts the following options:

### `cloudflareModules`

<p>
  **Type:** `boolean`
  <br />
  **Default:** `true`
</p>

Enables [imports of `.wasm`, `.bin`, and `.txt` modules](#cloudflare-module-imports).

This functionality is enabled by default. If you'd like to disable, set `cloudflareModules` to `false`.

### `imageService`

<p>
  **Type:** `'passthrough' | 'cloudflare' | 'cloudflare-binding' | 'compile' | 'custom'`
  <br />
  **Default:** `'compile'`
</p>

Determines which image service is used by the adapter. The adapter will default to `compile` mode when an incompatible image service is configured. Otherwise, it will use the globally configured image service:

- **`cloudflare`:** Uses the [Cloudflare Image Resizing](https://developers.cloudflare.com/images/image-resizing/) service.
- **`cloudflare-binding`:** Uses the [Cloudflare Images binding](https://developers.cloudflare.com/images/transform-images/bindings/) for image transformation. The binding is automatically provisioned when you deploy.
- **`passthrough`:** Uses the existing [`noop`](/en/guides/images/#configure-no-op-passthrough-service) service.
- **`compile`:** Uses Astro's default service (sharp), but only on pre-rendered routes at build time. For pages rendered on-demand, all `astro:assets` features are disabled.
- **`custom`:** Always uses the image service configured in [Image Options](/en/reference/configuration-reference/#image-options). **This option will not check to see whether the configured image service works in Cloudflare's `workerd` runtime.**

```js title="astro.config.mjs" ins={6}
import { defineConfig } from 'astro/config';
import cloudflare from '@astrojs/cloudflare';

export default defineConfig({
  adapter: cloudflare({
    imageService: 'cloudflare-binding',
  }),
});
```

### `sessionKVBindingName`

<p>
  **Type:** `string`
  <br />
  **Default:** `SESSION`
  <Since v="5.6.0" />
</p>

Sets the name of the KV binding used for session storage. The KV namespace is automatically provisioned when you deploy. By default, the binding is named `SESSION`, but you can change it if you define the binding manually in your wrangler config. See [Sessions](#sessions) for more information.

```js title="astro.config.mjs" "MY_SESSION_BINDING"
export default defineConfig({
  adapter: cloudflare({
    sessionKVBindingName: 'MY_SESSION_BINDING',
  }),
});
```

```jsonc title="wrangler.jsonc"
{
  "kv_namespaces": [
    {
      "binding": "MY_SESSION_BINDING",
    }
  ]
}
```

### `imagesBindingName`

<p>
  **Type:** `string`
  <br />
  **Default:** `IMAGES`
</p>

Sets the name of the Images binding used when [`imageService`](#imageservice) is set to `cloudflare-binding`. The binding is automatically provisioned when you deploy. By default, the binding is named `IMAGES`, but you can change it if you define the binding manually in your wrangler config.

```js title="astro.config.mjs" "MY_IMAGES"
export default defineConfig({
  adapter: cloudflare({
    imageService: 'cloudflare-binding',
    imagesBindingName: 'MY_IMAGES',
  }),
});
```

```jsonc title="wrangler.jsonc"
{
  "images": [
    {
      "binding": "MY_IMAGES",
    }
  ]
}
``` 

## Cloudflare runtime

The Cloudflare runtime gives you access to environment variables, bindings to Cloudflare resources, and other Cloudflare-specific APIs.

### Environment variables and bindings

Environment variables and bindings defined in your `wrangler.jsonc` configuration file are accessed by importing `env` from `cloudflare:workers`:

```astro title="src/pages/index.astro"
---
import { env } from 'cloudflare:workers';

const myVariable = env.MY_VARIABLE;
const myKVNamespace = env.MY_KV;
---
```

Define [environment variables](https://developers.cloudflare.com/workers/configuration/environment-variables/#add-environment-variables-via-wrangler) in `wrangler.jsonc`:

```jsonc title="wrangler.jsonc"
{
  "vars": {
    "MY_VARIABLE": "test",
  },
}
```

Secrets are a special type of environment variable that allow you to attach encrypted text values to your Worker. They need to be defined differently to ensure they are not visible after you set them.

To define `secrets`, add them through the [Wrangler CLI](https://developers.cloudflare.com/workers/wrangler/) rather than in your Wrangler config file:

```bash
npx wrangler secret put <KEY>
```

To set secrets for local development, add a `.dev.vars` file to the root of the Astro project:

```ini title=".dev.vars"
DB_PASSWORD=myPassword
```

As well as being available to import from `"cloudflare:workers"`, Cloudflare environment variables and secrets are compatible with the [`astro:env` API](/en/guides/environment-variables/#type-safe-environment-variables):

```js
import { MY_VARIABLE } from 'astro:env/server';
```

See the [list of all supported bindings](https://developers.cloudflare.com/workers/wrangler/api/#supported-bindings) in the Cloudflare documentation.

### The `cf` object

The Cloudflare [`cf` object](https://developers.cloudflare.com/workers/runtime-apis/request/#incomingrequestcfproperties) contains request metadata such as geolocation information. Access it directly from the request:

```astro title="src/pages/index.astro"
---
const cf = Astro.request.cf;
const country = cf?.country;
---
```

### Execution context

Access the Cloudflare [`ExecutionContext`](https://developers.cloudflare.com/workers/runtime-apis/context/) through `Astro.locals.cfContext`. This is useful for operations like [`waitUntil()`](https://developers.cloudflare.com/workers/runtime-apis/context/#waituntil), or accessing [Durable Object exports](https://developers.cloudflare.com/workers/runtime-apis/context/#exports) within your page.

```astro title="src/pages/index.astro"
---
const cfContext = Astro.locals.cfContext;
cfContext.exports.Greeter.greet('Astro');
cfContext.waitUntil(someAsyncOperation());
---
```

### Typing

`wrangler` provides a `types` command to generate TypeScript types for your bindings. This allows you to type your environment without the need for manual type definitions. Refer to the [Cloudflare documentation](https://developers.cloudflare.com/workers/wrangler/commands/#types) for more information.

Run `wrangler types` every time you change your configuration files (e.g. `wrangler.jsonc`, `.dev.vars`).

:::note
The following example shows a script configuration to run `wrangler types` automatically before other commands:

```json title="package.json"
{
  "scripts": {
    "dev": "wrangler types && astro dev",
    "start": "wrangler types && astro dev",
    "build": "wrangler types && astro check && astro build",
    "preview": "wrangler types && astro preview",
    "astro": "astro"
  }
}
```

:::

## Cloudflare Platform

### Headers

Add [custom headers](https://developers.cloudflare.com/workers/static-assets/headers/) to your responses by creating a `_headers` file in your Astro project's `public/` folder. This file will be copied to the build output directory.

### Assets

Assets built by Astro are all named with a hash and therefore can be given long cache headers. By default, Astro on Cloudflare will add such a header for these files.

### Redirects

Declare [custom redirects](https://developers.cloudflare.com/workers/static-assets/redirects/) by adding a `_redirects` file in your Astro project's `public/` folder. This file will be copied to your build output directory. This only applies to static assets; dynamic routes should use [Astro redirects](/en/guides/routing/#configured-redirects).

### Routes

Routing for static assets is based on the file structure in the build directory (e.g. `./dist`). If no match is found, this will fall back to the Worker for on-demand rendering. Read more about [static asset routing with Cloudflare Workers](https://developers.cloudflare.com/workers/static-assets/routing/).

## Sessions

The Astro [Sessions API](/en/guides/sessions/) allows you to easily store user data between requests. This can be used for things like user data and preferences, shopping carts, and authentication credentials. Unlike cookie storage, there are no size limits on the data, and it can be restored on different devices.

Astro automatically configures [Workers KV](https://developers.cloudflare.com/kv/) for session storage when using the Cloudflare adapter. The KV namespace is [automatically provisioned](https://developers.cloudflare.com/workers/wrangler/configuration/#automatic-provisioning) when you deploy, so no manual setup is required. Alternatively, you can define the KV binding manually in your `wrangler.jsonc` file and set a custom binding name using the [`sessionKVBindingName`](#sessionkvbindingname) adapter option.

```astro title="src/components/CartButton.astro"
---
export const prerender = false;
const cart = await Astro.session?.get('cart');
---

<a href="/checkout">ðŸ›’ {cart?.length ?? 0} items</a>
```

By default, the KV binding is named `SESSION`. To use a different name, set the [`sessionKVBindingName`](#sessionkvbindingname) option in the adapter config.

:::note
Writes to Cloudflare KV are [eventually consistent](https://developers.cloudflare.com/kv/concepts/how-kv-works/#consistency) between regions. This means that changes are available immediately within the same region but may take up to 60 seconds to propagate globally. This won't affect most users as they are unlikely to switch regions between requests, but it may be a consideration for some use cases, such as VPN users.
:::

## Cloudflare Module Imports

The Cloudflare `workerd` runtime supports imports of some [non-standard module types](https://developers.cloudflare.com/workers/wrangler/bundling/#including-non-javascript-modules). Most additional file types are also available in Astro:

- `.wasm` or `.wasm?module`: exports a [`WebAssembly.Module`](https://developer.mozilla.org/en-US/docs/WebAssembly/JavaScript_interface/Module) that can then be instantiated
- `.bin`: exports an [`ArrayBuffer`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer) of the raw binary contents of the file
- `.txt`: exports a string of the file contents

All module types export a single default value. Modules can be imported both from server-side rendered pages, or from prerendered pages for static site generation.

The following is an example of importing a Wasm module that then responds to requests by adding the request's number parameters together.

```js title="pages/add/[a]/[b].js"
// Import the WebAssembly module
import mod from '../util/add.wasm';

// Instantiate first in order to use it
const addModule: any = new WebAssembly.Instance(mod);

export async function GET(context) {
  const a = Number.parseInt(context.params.a);
  const b = Number.parseInt(context.params.b);
  return new Response(`${addModule.exports.add(a, b)}`);
}
```

While this example is trivial, Wasm can be used to accelerate computationally intensive operations which do not involve significant I/O such as embedding an image processing library, or embedding a small pre-indexed database for search over a read-only dataset.

## Node.js compatibility

Cloudflare Workers supports a growing subset of Node.js runtime APIs through the `nodejs_compat` compatibility flag. This includes commonly used modules like `node:buffer`, `node:crypto`, `node:path`, and many others. See the [full list of supported Node.js APIs](https://developers.cloudflare.com/workers/runtime-apis/nodejs) in Cloudflare's documentation.

To enable Node.js compatibility, add the `nodejs_compat` flag to your Wrangler configuration:

```jsonc title="wrangler.jsonc"
{
  "compatibility_flags": ["nodejs_compat"],
}
```

Then use the `node:*` import syntax in your server-side code:

```js title="src/pages/api/endpoint.js"
export const prerender = false;
import { Buffer } from 'node:buffer';
```

For APIs not yet natively supported, Wrangler automatically provides polyfills.

<ReadMore>See the [Cloudflare documentation on Node.js compatibility](https://developers.cloudflare.com/workers/runtime-apis/nodejs/) for the complete list of supported APIs and configuration details.</ReadMore>

## Local preview

After building your project with `astro build`, use `astro preview` to test your Cloudflare Workers application locally. The preview runs using Cloudflare's `workerd` runtime, providing a staging environment that matches production exactly.

### Meaningful error messages

Currently, errors during running your application in Wrangler are not very useful, due to the minification of your code. For better debugging, add `vite.build.minify = false` to your `astro.config.mjs`:

```js title="astro.config.mjs" ins={3-7}
export default defineConfig({
  adapter: cloudflare(),
  vite: {
    build: {
      minify: false,
    },
  },
});
```

## Using with Cloudflare Pages

The Cloudflare adapter deploys to Cloudflare Workers by default. To deploy to Cloudflare Pages instead, additional manual configuration is required.

:::caution
Cloudflare recommends migrating from Pages to Workers for new projects. See Cloudflare's [migration guide from Pages to Workers](https://developers.cloudflare.com/workers/static-assets/migration-guides/migrate-from-pages/) for more information.
:::

<Steps>
1. Configure your build output directories in `astro.config.mjs`:

    ```js title="astro.config.mjs" ins={6-9}
    import { defineConfig } from 'astro/config';
    import cloudflare from '@astrojs/cloudflare';

    export default defineConfig({
      adapter: cloudflare(),
      build: {
        client: './dist',
        server: './dist/_worker.js',
      },
    });
    ```

2. Create a `_routes.json` file in your `public/` folder to route requests to your Worker:

    ```jsonc title="public/_routes.json"
    {
      "version": 1,
      "include": ["/*"], // Alternatively, specify specific routes
      "exclude": ["/static/*"] // Exclude static assets if needed
    }
    ```

    See the [Cloudflare documentation on routing with Pages](https://developers.cloudflare.com/pages/functions/routing/#create-a-_routesjson-file) for more details.
</Steps>

## Upgrading to Astro 6

Astro 6 brings significant improvements to the Cloudflare development experience and requires `@astrojs/cloudflare` v13 or later. Now, `astro dev` uses Cloudflare's Vite plugin and `workerd` runtime to closely mirror production behavior.

<ReadMore>
  See [the Astro 6 upgrade guide](/en/guides/upgrade-to/v6/) for full instructions on upgrading
  Astro itself.
</ReadMore>

### Development server now uses workerd

The biggest change for Cloudflare users in Astro 6 is that `astro dev` and `astro preview` now use the Cloudflare Vite plugin to run your site using the real Workers runtime (`workerd`) instead of Node.js. This means your development environment is now a much closer replica of your production environment, with the same runtime, APIs, and behavior.

This change helps you catch issues during development that would have previously only appeared in production, and features like Durable Objects, R2 bindings, and Workers AI now work exactly as they do when deployed to Cloudflare's platform.

This change is transparent for most projects. If your project had special configuration for `astro dev` or was relying on Node.js-specific behavior in development, adjust your code or configuration accordingly.

### Changed: Wrangler entrypoint configuration

Previously, the `main` field in your Wrangler configuration pointed to the built worker file (e.g. `dist/_worker.js/index.js`). With Astro 6, this has changed to point to a new unified entrypoint provided by the Cloudflare adapter: `@astrojs/cloudflare/entrypoints/server`.

Update your `wrangler.jsonc` to use the new entrypoint:

```jsonc title="wrangler.jsonc" del={2} ins={3}
{
  "main": "dist/_worker.js/index.js",
  "main": "@astrojs/cloudflare/entrypoints/server",
  "name": "my-astro-app",
  // ... rest of config
}
```

This single entrypoint handles both `astro dev` and production deployments.

### Removed: `Astro.locals.runtime` API

The `Astro.locals.runtime` object has been removed in favor of direct access to Cloudflare Workers APIs. Access environment variables, the `cf` object, caches, and execution context directly through the provided interfaces.

**Accessing environment variables:**

Previously, environment variables were accessed through `Astro.locals.runtime.env`. Now import `env` directly instead:

```js del={1} ins={2}
const { env } = Astro.locals.runtime;
import { env } from 'cloudflare:workers';
```

**Accessing the `cf` object:**

Previously, the `cf` object was accessed through `Astro.locals.runtime.cf`. Now access it directly from the request:

```js del={1} ins={2}
const { cf } = Astro.locals.runtime;
const cf = Astro.request.cf;
```

**Accessing the caches API:**

Previously, the caches API was accessed through `Astro.locals.runtime.caches`. Now use the global `caches` object directly:

```js del={1} 
const { caches } = Astro.locals.runtime;

caches.default.put(request, response);
```

**Accessing the execution context:**

The `Astro.locals.runtime.ctx` object is replaced with `Astro.locals.cfContext` which contains the Cloudflare `ExecutionContext`:

```js del={1} ins={2}
const ctx = Astro.locals.runtime.ctx;
const ctx = Astro.locals.cfContext;
```

### Optional: Wrangler configuration file

The Wrangler configuration file is now optional for simple projects. If you don't have custom configuration such as Cloudflare bindings (KV, D1, Durable Objects, etc.), Astro will automatically generate a default configuration for you.

If your `wrangler.jsonc` only contains basic configuration like this:

```jsonc
{
  "main": "@astrojs/cloudflare/entrypoints/server",
  "compatibility_date": "2025-05-21",
  "assets": {
    "directory": "./dist",
    "binding": "ASSETS",
  },
}
```

You can safely delete this file. Astro handles this configuration automatically. Alternatively, create a minimal `wrangler.jsonc` with just your project name and other custom settings:

```jsonc title="wrangler.jsonc"
{
  "name": "my-astro-app",
}
```

### Changed: Custom entrypoint API

If you were using a custom `workerEntryPoint` configuration in the adapter options, this has been removed. Instead, specify your custom entrypoint in your Wrangler configuration and create a standard Cloudflare Worker export object directly, rather than using the `createExports()` function.

<Steps>
1. Remove the `workerEntryPoint` option from your adapter config:

    ```js title="astro.config.mjs" del={6-9}
    import { defineConfig } from 'astro/config';
    import cloudflare from '@astrojs/cloudflare';

    export default defineConfig({
      adapter: cloudflare({
        workerEntryPoint: {
          path: 'src/worker.ts',
          namedExports: ['MyDurableObject'],
        },
      }),
    });
    ```

2. Specify the entrypoint in `wrangler.jsonc` instead:

    ```jsonc title="wrangler.jsonc"
    {
      "main": "./src/worker.ts"
    }
    ```

3. Update your custom worker entry file to use standard Worker syntax. Import the handler from `@astrojs/cloudflare/entrypoints/server` and export a standard Cloudflare Worker object, alongside any custom exports like Durable Objects:

    ```ts title="src/worker.ts"
    import handler from '@astrojs/cloudflare/entrypoints/server';
    import { DurableObject } from 'cloudflare:workers';

    export class MyDurableObject extends DurableObject<Env> {
      // ...
    }

    export default {
      async fetch(request, env, ctx) {
        await env.MY_QUEUE.send('log');
        return handler.fetch(request, env, ctx);
      },
      async queue(batch, _env) {
        let messages = JSON.stringify(batch.messages);
        console.log(`consumed from our queue: ${messages}`);
      },
    } satisfies ExportedHandler<Env>;
    ```
</Steps>

The manifest is now created internally by the adapter, so does not need to be passed to your handler.

### New: `astro preview` support

Use `astro preview` to test your Cloudflare Workers application locally before deploying. The preview runs using Cloudflare's `workerd` runtime, providing a staging environment that matches production exactly. Run `astro build` followed by `astro preview` to start the preview server.

### Deprecated: Cloudflare Pages support

The Astro Cloudflare adapter now only supports deploying to Cloudflare Workers by default. If you are currently deploying to Cloudflare Pages, consider migrating to Workers for the best experience and feature support.

<ReadMore>See Cloudflare's [migration guide from Pages to Workers](https://developers.cloudflare.com/workers/static-assets/migration-guides/migrate-from-pages/) for detailed migration instructions.</ReadMore>

If you need to continue using Cloudflare Pages, see [Using with Cloudflare Pages](#using-with-cloudflare-pages) for the required manual configuration.

[astro-integration]: /en/guides/integrations-guide/
