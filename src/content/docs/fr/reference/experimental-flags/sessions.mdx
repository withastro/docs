---
title: Sessions (exp√©rimental)
sidebar:
  label: Sessions
i18nReady: true
---

import Since from '~/components/Since.astro';
import ReadMore from '~/components/ReadMore.astro';

<p>

**Type :** `SessionConfig`<br />
**Par d√©faut :** `undefined`<br />

<Since v="5.1.0" />
</p>

Les sessions sont utilis√©es pour stocker l'√©tat de l'utilisateur entre les demandes de [pages rendues √† la demande](/fr/guides/on-demand-rendering/).

Cette fonctionnalit√© exp√©rimentale vous permet de stocker et d'acc√©der √† des √©l√©ments tels que le statut de connexion, le contenu du panier d'achat ou d'autres donn√©es sp√©cifiques √† l'utilisateur :

```astro title="src/components/CartButton.astro" {3}
---
export const prerender = false; // Inutile en mode "serveur
const cart = await Astro.session.get('cart');
---

<a href="/checkout">üõí {cart?.length ?? 0} articles</a>
```

Les sessions s'appuient sur un [pilote de session configurable](#activation-des-sessions-exp√©rimentales) pour stocker les donn√©es sur l'objet `session`. Un [cookie de session](#cookies) stocke un identifiant de session.

L'objet [`session`](#api-sessions) vous permet d'interagir avec l'√©tat de l'utilisateur stock√© (par exemple, ajouter des articles √† un panier d'achat) et l'identifiant de session (par exemple, supprimer le cookie d'identifiant de session lors de la d√©connexion).


## Activation des sessions exp√©rimentales

Dans cette premi√®re version de `experimental.sessions`, les adaptateurs de serveur officiels d'Astro n'ont pas encore √©t√© mis √† jour pour fournir un pilote de session par d√©faut bas√© sur la fonctionnalit√© de stockage par d√©faut de la plate-forme. Jusqu'√† ce qu'ils soient int√©gr√©s, vous devrez sp√©cifier vous-m√™me un `driver` dans l'objet de configuration `experimental.sessions` en plus d'[ajouter un adaptateur](/fr/guides/on-demand-rendering/#ajouter-un-adaptateur).

Les sections suivantes montrent les pilotes recommand√©s pour chaque adaptateur. (Ceux-ci seront automatiquement configur√©s pour vous dans la version stable de cette fonctionnalit√©). Vous pouvez √©galement sp√©cifier [n'importe quel pilote pris en charge √† partir d'unstorage](https://unstorage.unjs.io/drivers/).

### Configuration de sessions avec l'adaptateur Node

L'adaptateur Node est compatible avec le [pilote de syst√®me de fichiers](https://unstorage.unjs.io/drivers/fs). Notez qu'il ne peut pas √™tre utilis√© dans les environnements sans serveur, car ils n'ont pas de syst√®me de fichiers partag√©.

```js title="astro.config.mjs" ins={6}
	{
    adapter: node({ mode: 'standalone' }),
		experimental: {
      session: {
        // Requis : le nom du pilote de unstorage
        driver: "fs",
      },
    },
	}
```

### Configuration d'un pilote de session pour d'autres adaptateurs

Choisissez le [nom du `driver` d'unstorage](https://unstorage.unjs.io/drivers/) qui correspond √† la fonction de stockage fournie par votre plateforme d'h√©bergement, comme le [pilote Netlify Blobs (`netlify-blobs`)](https://unstorage.unjs.io/drivers/netlify), le [pilote Cloudflare KV (`cloudflare-kv-binding`)](https://unstorage.unjs.io/drivers/cloudflare) ou le [pilote Deno KV (`deno-kv`)](https://unstorage.unjs.io/drivers/deno). Vous pouvez √©galement utiliser un pilote multiplateforme tel que [Upstash](https://unstorage.unjs.io/drivers/upstash) ou [Redis](https://unstorage.unjs.io/drivers/redis).

:::note
Certains pilotes peuvent n√©cessiter l'installation de paquets suppl√©mentaires. Par exemple, le pilote `netlify-blobs` n√©cessite le paquet `@netlify/blobs`, et Upstash n√©cessite le paquet `@upstash/redis`. Certains pilotes peuvent √©galement n√©cessiter l'installation de variables d'environnement ou d'informations d'identification.

<ReadMore>Voir [la documentation sur le pilote de d'unstorage](https://unstorage.unjs.io/drivers) pour plus d'informations.</ReadMore>
:::

### Options du pilote

Vous pouvez √©galement passer toutes les options disponibles au pilote d'unstorage dans un objet `session.options` s√©par√©. L'exemple suivant configure le pilote [Netlify Blobs](https://unstorage.unjs.io/drivers/netlify) en fournissant un `name` et en sp√©cifiant un mode de `consistency` :

```js title="astro.config.mjs" ins={7-11}
  {
    experimental: {
      adapter: netlify(),
      session: {
        // Le nom du pilote d'unstorage est camelCase
        driver: "netlify-blobs",
        options: {
          name: 'astro-sessions',
          // Les sessions ont besoin d'une forte coh√©rence
          consistency: 'strong',
        }
      },
    },
  }
```

## Utilisation des sessions

Une fois que vous avez configur√© un pilote, vous pouvez utiliser l'objet `session` pour interagir avec la session. Cet objet est accessible en tant que `Astro.session` dans vos composants et pages Astro et sur l'objet `context` dans les points de terminaison de l'API, le middleware et les actions. L'API est la m√™me dans tous les cas.

Dans la plupart des cas, vous n'aurez besoin que d'utiliser [`Astro.session.get()`](#sessionget) et [`Astro.session.set()`](#sessionset). Pour les autres m√©thodes disponibles, voir la [section API](#api-sessions).

### Composants et pages Astro

Dans les composants et les pages `.astro`, vous pouvez acc√©der √† l'objet session via l'objet global `Astro`. Par exemple, pour afficher le nombre d'articles dans un panier d'achat :

```astro title="src/components/CartButton.astro" "Astro.session"
---
export const prerender = false; // Inutile en mode 'server'
const cart = await Astro.session.get('cart');
---

<a href="/checkout">üõí {cart?.length ?? 0} articles</a>
```

### Points d'acc√®s √† l'API

Dans les points de terminaison de l'API, l'objet de session est disponible dans l'objet `context`. Par exemple, pour ajouter un article √† un panier d'achat :

```ts title="src/pages/api/addToCart.ts" "context.session"
import type { APIContext } from "astro";

export async function POST(req: Request, context: APIContext) {
  const cart = await context.session.get("cart");
  cart.push(req.body.item);
  await context.session.set("cart", cart);
  return Response.json(cart);
}
```

### Actions

Dans les actions, l'objet session est disponible dans l'objet `context`. Par exemple, pour ajouter un article √† un panier d'achat :

```ts title="src/actions/addToCart.ts" "context.session"
import { defineAction } from "astro:actions";
import { z } from "astro:schema";

export const server = {
  addToCart: defineAction({
    input: z.object({ productId: z.string() }),
    handler: async (input, context) => {
      const cart = await context.session.get("cart");
      cart.push(input.productId);
      await context.session.set("cart", cart);
      return cart;
    },
  }),
};
```

### Middleware

:::note
Les sessions ne sont actuellement pas prises en charge par le middleware.
:::

Dans le middleware, l'objet session est disponible sur l'objet `context`. Par exemple, pour d√©finir l'heure de la derni√®re visite dans la session :

```ts title="src/middleware.ts" "context.session"
import { defineMiddleware } from 'astro:middleware';

export const onRequest = defineMiddleware(async (context, next) => {
  context.session.set('lastVisit', new Date());
  return next();
});
```

## Cookies

Les sessions sont g√©n√©r√©es lors du premier acc√®s et un cookie d'identification de session est plac√© dans la r√©ponse. Aucune donn√©e utilisateur n'est stock√©e dans le cookie, juste un identifiant utilis√© pour identifier la session de l'utilisateur. La session peut √™tre r√©g√©n√©r√©e √† tout moment avec [`Astro.session.regenerate()`](#sessionregenerate), et d√©truite avec [`Astro.session.destroy()`](#sessiondestroy).

### `session.cookie`

<p>

**Type :** `string` | `object`<br />
**Par d√©faut :** `undefined`<br />

</p>

Une propri√©t√© optionnelle pour d√©finir les options du cookie. La propri√©t√© `cookie.name` peut √™tre automatiquement d√©finie en fournissant une cha√Æne de caract√®res. Pour configurer des options suppl√©mentaires, il faut fournir un objet.

```js title="astro.config.mjs" {5} ins={7-10}
  {
    experimental: {
      session: {
        // S'il s'agit d'une cha√Æne de caract√®res, elle sera utilis√©e comme nom de cookie.
        // cookie : "my-session-id",
        // S'il s'agit d'un objet, cela permettra de d√©finir des options avanc√©es.
        cookie: {
          name: "my-session-id"
          sameSite: "Strict",
        },
      }
    }
  }
```

## API Sessions

L'objet session est disponible dans tous les contextes Astro, y compris les composants, les actions et les points de terminaison API. Dans les composants, il est accessible via l'objet global `Astro`, et dans les actions et les points de terminaison d'API, il est disponible sur l'objet `context`. L'API est la m√™me dans tous les cas.

Les valeurs sont s√©rialis√©es et d√©s√©rialis√©es en utilisant [devalue](https://github.com/Rich-Harris/devalue), qui est la m√™me biblioth√®que utilis√©e par la couche de contenu et les actions. Cela signifie que les types support√©s sont les m√™mes, et incluent les cha√Ænes de caract√®res, les nombres, `Date`, `Map`, `Set`, `URL`, les tableaux et les objets simples.

### `session.get()` 

<p>

**Type** : `(key: string) => Promise<any>`
</p>

Renvoie la valeur de la cl√© donn√©e dans la session. Si la cl√© n'existe pas, il renvoie `undefined`.

### `session.set()`

<p>

**Type** : `(key: string, value: any, options?: { ttl: number }) => void`
</p>

D√©finit la valeur de la cl√© donn√©e dans la session. La valeur peut √™tre de n'importe quel type s√©rialisable.

### `session.regenerate()`

<p>

**Type** : `() => void`
</p>

R√©g√©n√®re l'identifiant de session. La meilleure pratique consiste √† appeler cette fonction lorsqu'un utilisateur se connecte ou augmente ses privil√®ges, afin de pr√©venir les attaques par fixation de session.

### `session.destroy()`

<p>

**Type** : `() => void`
</p>

D√©truit la session, en supprimant le cookie et l'objet du backend. Elle doit √™tre appel√©e lorsqu'un utilisateur se d√©connecte ou que sa session est invalid√©e d'une autre mani√®re.

## Lecture compl√©mentaire

Pour plus de d√©tails et pour donner votre avis sur cette API exp√©rimentale, consultez [le RFC Sessions](https://github.com/withastro/roadmap/blob/sessions/proposals/0054-sessions.md).
