---
title: Sessions (exp√©rimental)
sidebar:
  label: Sessions
i18nReady: true
---

import Since from '~/components/Since.astro';
import ReadMore from '~/components/ReadMore.astro';

<p>

**Type :** `boolean`<br />
**Par d√©faut :** `false`<br />

<Since v="5.1.0" />
</p>

Les sessions sont utilis√©es pour stocker l'√©tat de l'utilisateur entre les demandes de [pages rendues √† la demande](/fr/guides/on-demand-rendering/).

Cette fonctionnalit√© exp√©rimentale vous permet de stocker et d'acc√©der √† des √©l√©ments tels que le statut de connexion, le contenu du panier d'achat ou d'autres donn√©es sp√©cifiques √† l'utilisateur :

```astro title="src/components/CartButton.astro" {3}
---
export const prerender = false; // Inutile avec la sortie `server`
const cart = await Astro.session.get('cart');
---

<a href="/checkout">üõí {cart?.length ?? 0} articles</a>
```

Les sessions s'appuient sur un [pilote de session configurable](#activation-des-sessions-exp√©rimentales) pour stocker les donn√©es sur l'objet `session`. Un [cookie de session](#sessioncookie) stocke un identifiant de session.

L'[objet `session`](#api-sessions) vous permet d'interagir avec l'√©tat de l'utilisateur stock√© (par exemple, ajouter des articles √† un panier d'achat) et l'identifiant de session (par exemple, supprimer le cookie d'identifiant de session lors de la d√©connexion).

## Activation des sessions exp√©rimentales

Pour activer les sessions, d√©finissez l'option `experimental.session` sur `true`. Les sessions ne fonctionnent que sur les pages avec un rendu √† la demande, vous devez donc [installer un adaptateur](/fr/guides/on-demand-rendering/#ajouter-un-adaptateur) prenant en charge le rendu √† la demande et vous assurer que toutes les pages qui utilisent des sessions sont d√©finies avec `prerender: false` ou que `output` est d√©fini sur `server` dans la configuration Astro.

```js title="astro.config.mjs" ins={6}
  {
    adapter: node({
      mode: "standalone",
    }),
    experimental: {
      session: true,
    },
  }
```

Les sessions n√©cessitent un pilote de stockage pour stocker les donn√©es de session. Les adaptateurs Node et Netlify configurent automatiquement un pilote par d√©faut pour vous, mais d'autres adaptateurs n√©cessitent actuellement que vous [sp√©cifiiez un pilote manuellement](#configuration-dun-pilote-de-session). Vous pouvez utiliser [n'importe quel pilote pris en charge par unstorage](https://unstorage.unjs.io/drivers/).

### Configuration d'un pilote de session

Si vous utilisez un adaptateur qui n'a pas de pilote par d√©faut, ou si vous souhaitez choisir un autre pilote, vous pouvez le configurer en utilisant l'option de configuration `session`¬†:

```js title="astro.config.mjs" ins={4}
  {
    adapter: vercel(),
    session: {
      driver: "upstash",
    },
    experimental: {
      session: true,
    },
  }
```

Configurez `session.driver` avec le nom du `driver` Unstorage qui correspond √† la fonctionnalit√© de stockage fournie par votre plateforme d'h√©bergement, comme le [pilote Cloudflare KV](https://unstorage.unjs.io/drivers/cloudflare) ou le [pilote Deno KV](https://unstorage.unjs.io/drivers/deno). Vous pouvez √©galement utiliser un pilote multiplateforme tel que [Upstash](https://unstorage.unjs.io/drivers/upstash) ou [Redis](https://unstorage.unjs.io/drivers/redis).

:::note
Certains pilotes peuvent n√©cessiter l'installation de paquets suppl√©mentaires. Par exemple, Upstash n√©cessite le paquet `@upstash/redis`. Certains pilotes peuvent √©galement n√©cessiter la d√©finition de variables d'environnement ou d'informations d'identification.

<ReadMore>
  Voir [la documentation des pilotes Unstorage](https://unstorage.unjs.io/drivers) pour plus d'informations sur chaque pilote, y compris son nom de pilote, toutes les d√©pendances suppl√©mentaires et son utilisation.
</ReadMore>

:::

### Options du pilote

Vous pouvez √©galement transmettre toutes les options disponibles au pilote unstorage dans un objet `session.options` distinct. Consultez la documentation du pilote que vous avez choisi pour conna√Ætre les options disponibles.

L'exemple suivant d√©finit un pr√©fixe dans `base` (`"sessions"`) √† utiliser pour toutes les cl√©s dans Upstash¬†:

```js title="astro.config.mjs" ins={5-7}
  {
    adapter: vercel(),
    session: {
      driver: "upstash",
      options: {
        base: "sessions",
      },
    },
    experimental: {
      session: true,
    },
  }
```

### Autres options de session

Vous pouvez configurer des options suppl√©mentaires pour les sessions dans l'objet `session`.

#### `session.cookie`

<p>

**Type¬†:** `string` | `object`<br />
**Par d√©faut¬†:** `astro-session`<br />

</p>

Configure le cookie de session. Ce cookie est d√©fini dans la r√©ponse lorsqu'une session est g√©n√©r√©e. Aucune donn√©e utilisateur r√©elle n'est stock√©e dans le cookie - juste un identifiant utilis√© pour identifier la session d'un utilisateur. L'option `session.cookie` peut √™tre utilis√©e pour d√©finir des options pour ce cookie. Vous pouvez soit fournir une cha√Æne de caract√®res, qui sera utilis√©e comme nom de cookie, soit un objet qui permet des options suppl√©mentaires¬†:

```js title="astro.config.mjs" {4} ins={6-9}
  {
    session: {
      // Si d√©fini avec une cha√Æne de caract√®res, celle-ci sera utilis√©e comme nom de cookie
      // cookie: "mon-id-de-session",
      // Si d√©fini avec un objet, cela permettra de d√©finir des options avanc√©es
      cookie: {
        name: "mon-id-de-session"
        sameSite: "Strict",
      },
    }
  }
```

#### `session.ttl`

<p>
  
**Type¬†:** `number`<br />
**Par d√©faut¬†:** `undefined`<br />

</p>

Une p√©riode d'expiration de dur√©e de vie par d√©faut facultative pour les valeurs de session, en secondes.

Par d√©faut, les valeurs de session persistent jusqu'√† ce qu'elles soient supprim√©es ou que la session soit d√©truite, et n'expirent pas automatiquement car un certain laps de temps s'est √©coul√©. D√©finissez `session.ttl` pour ajouter une p√©riode d'expiration par d√©faut pour vos valeurs de session. Passer une option `ttl` √† [`session.set()`](#sessionset) remplacera la valeur globale par d√©faut pour cette entr√©e individuelle.

```js title="astro.config.mjs" {3}
  {
    session: {
      ttl: 60 * 60, // 1 heure
    }
  }
```

:::note
La d√©finition d'une valeur pour `ttl` ne supprime pas automatiquement la valeur du stockage une fois le d√©lai √©coul√©.

Les valeurs stock√©es ne seront supprim√©es que si une tentative d'acc√®s est effectu√©e apr√®s l'expiration de la p√©riode `ttl`. √Ä ce moment-l√†, la valeur de session sera ind√©finie et ce n'est qu'√† ce moment-l√† que la valeur sera supprim√©e.

Les pilotes individuels peuvent √©galement prendre en charge une option `ttl` qui supprimera automatiquement les sessions apr√®s le d√©lai sp√©cifi√©. Consultez la documentation du pilote choisi pour plus d'informations.
:::

## Utilisation des sessions

Une fois que vous avez configur√© un pilote, vous pouvez utiliser l'objet `session` pour interagir avec la session. Cet objet est accessible en tant que `Astro.session` dans vos composants et pages Astro et sur l'objet `context` dans les points de terminaison de l'API, le middleware et les actions. L'API est la m√™me dans tous les cas.

La session est g√©n√©r√©e automatiquement lors de sa premi√®re utilisation et peut √™tre r√©g√©n√©r√©e √† tout moment avec [`Astro.session.regenerate()`](#sessionregenerate) ou d√©truite avec [`Astro.session.destroy()`](#sessiondestroy).

Dans la plupart des cas, vous n'aurez besoin que d'utiliser [`Astro.session.get()`](#sessionget) et [`Astro.session.set()`](#sessionset). Pour les autres m√©thodes disponibles, voir la [section API](#api-sessions).

### Composants et pages Astro

Dans les composants et les pages `.astro`, vous pouvez acc√©der √† l'objet session via l'objet global `Astro`. Par exemple, pour afficher le nombre d'articles dans un panier d'achat :

```astro title="src/components/CartButton.astro" "Astro.session"
---
export const prerender = false; // Inutile avec la sortie `server`
const cart = await Astro.session.get('cart');
---

<a href="/checkout">üõí {cart?.length ?? 0} articles</a>
```

### Points d'acc√®s √† l'API

Dans les points de terminaison de l'API, l'objet de session est disponible dans l'objet `context`. Par exemple, pour ajouter un article √† un panier d'achat :

```ts title="src/pages/api/addToCart.ts" "context.session"
import type { APIContext } from 'astro';

export async function POST(req: Request, context: APIContext) {
  const cart = await context.session.get('cart');
  cart.push(req.body.item);
  await context.session.set('cart', cart);
  return Response.json(cart);
}
```

### Actions

Dans les actions, l'objet session est disponible dans l'objet `context`. Par exemple, pour ajouter un article √† un panier d'achat :

```ts title="src/actions/addToCart.ts" "context.session"
import { defineAction } from 'astro:actions';
import { z } from 'astro:schema';

export const server = {
  addToCart: defineAction({
    input: z.object({ productId: z.string() }),
    handler: async (input, context) => {
      const cart = await context.session.get('cart');
      cart.push(input.productId);
      await context.session.set('cart', cart);
      return cart;
    },
  }),
};
```

### Middleware

:::note
Les sessions ne sont actuellement pas prises en charge dans les middlewares de p√©riph√©rie.
:::

Dans le middleware, l'objet session est disponible sur l'objet `context`. Par exemple, pour d√©finir l'heure de la derni√®re visite dans la session :

```ts title="src/middleware.ts" "context.session"
import { defineMiddleware } from 'astro:middleware';

export const onRequest = defineMiddleware(async (context, next) => {
  context.session.set('lastVisit', new Date());
  return next();
});
```

### Types des donn√©es de session

Par d√©faut, les donn√©es de session ne sont pas typ√©es et vous pouvez stocker des donn√©es arbitraires dans n'importe quelle cl√©. Les valeurs sont s√©rialis√©es et d√©s√©rialis√©es √† l'aide de [devalue](https://github.com/Rich-Harris/devalue), qui est la m√™me biblioth√®que utilis√©e dans les collections de contenu et les actions. Cela signifie que les types pris en charge sont les m√™mes et incluent les cha√Ænes de caract√®res, les nombres, `Date`, `Map`, `Set`, `URL`, les tableaux et les objets simples.

Vous pouvez √©ventuellement d√©finir des types TypeScript pour vos donn√©es de session en cr√©ant un fichier `src/env.d.ts` et en ajoutant une d√©claration pour le type `App.SessionData`¬†:

```ts title="src/env.d.ts"
declare namespace App {
  interface SessionData {
    user: {
      id: string;
      name: string;
    };
    cart: string[];
  }
}
```

Cela vous permettra d'acc√©der aux donn√©es de session avec v√©rification de type et saisie semi-automatique dans votre √©diteur¬†:

```ts title="src/components/CartButton.astro"
---
const cart = await Astro.session.get('cart');
// const cart: string[] | undefined

const something = await Astro.session.get('something');
// const something: any

Astro.session.set('user', { id: 1, name: 'Houston' });
// Error: Argument of type '{ id: number; name: string }' is not assignable to parameter of type '{ id: string; name: string; }'.
---
```

:::caution
Ceci est uniquement utilis√© pour la v√©rification de type et n‚Äôaffecte pas le comportement d‚Äôex√©cution de la session. Soyez particuli√®rement prudent si vous modifiez le type lorsque les utilisateurs ont stock√© des donn√©es dans la session, car cela pourrait entra√Æner des erreurs d'ex√©cution.
:::
## API Sessions

L'objet session est disponible dans tous les contextes Astro, y compris les composants, les actions et les points de terminaison API. Dans les composants, il est accessible via l'objet global `Astro`, et dans les actions et les points de terminaison d'API, il est disponible sur l'objet `context`. L'API est la m√™me dans tous les cas.

### `session.get()` 

<p>

**Type** : `(key: string) => Promise<any>`

</p>

Renvoie la valeur de la cl√© donn√©e dans la session. Si la cl√© n'existe pas, il renvoie `undefined`.

### `session.set()`

<p>

**Type** : `(key: string, value: any, options?: { ttl: number }) => void`

</p>

D√©finit la valeur de la cl√© donn√©e dans la session. La valeur peut √™tre de n'importe quel type s√©rialisable. Cette m√©thode est synchrone et la valeur est imm√©diatement disponible pour la r√©cup√©ration, mais elle n'est pas enregistr√©e dans le backend avant la fin de la requ√™te.

### `session.load()`

<p>

**Type**¬†: `(id: string) => Promise<void>`

<Since v="5.6.0" />

</p>

Charge une session par identifiant. En utilisation normale, une session est charg√©e automatiquement √† partir du cookie de la requ√™te, mais cette m√©thode permet de charger une session √† partir d'un identifiant diff√©rent. Ceci est utile si vous g√©rez vous-m√™me l'identifiant de la session ou si vous souhaitez suivre une session sans utiliser de cookies.
### `session.regenerate()`

<p>

**Type** : `() => void`

</p>

R√©g√©n√®re l'identifiant de session. La meilleure pratique consiste √† appeler cette fonction lorsqu'un utilisateur se connecte ou augmente ses privil√®ges, afin de pr√©venir les attaques par fixation de session.

### `session.destroy()`

<p>

**Type** : `() => void`

</p>

D√©truit la session, en supprimant le cookie et l'objet du backend. Elle doit √™tre appel√©e lorsqu'un utilisateur se d√©connecte ou que sa session est invalid√©e d'une autre mani√®re.

## Lecture compl√©mentaire

Pour plus de d√©tails et pour donner votre avis sur cette API exp√©rimentale, consultez [le RFC Sessions](https://github.com/withastro/roadmap/blob/sessions/proposals/0054-sessions.md).
