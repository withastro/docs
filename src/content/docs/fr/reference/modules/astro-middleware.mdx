---
title: Référence de l'API Middleware
sidebar:
  label: 'astro:middleware'
i18nReady: true
tableOfContents:
  minHeadingLevel: 2
  maxHeadingLevel: 6
---
import Since from '~/components/Since.astro';
import ReadMore from '~/components/ReadMore.astro';

<p><Since v="2.6.0" /></p>

Un middleware vous permet d'intercepter les requêtes et les réponses et d'injecter des comportements de manière dynamique chaque fois qu'une page ou un point de terminaison est sur le point d'être rendu. Pour les fonctionnalités et les exemples d'utilisation, [consultez notre guide Middleware](/fr/guides/middleware/).

## Importations depuis `astro:middleware`

Les fonctions d'assistance suivantes sont importées du module middleware virtuel :

```js
import { 
  defineMiddleware,
  sequence,
} from 'astro:middleware';
```

### `defineMiddleware()`

<p>

**Type :** <code>(fn: <a href="#middlewarehandler">MiddlewareHandler</a>) => MiddlewareHandler</code>
</p>

Une fonction permettant de définir une fonction middleware avec sûreté du typage. Lorsque vous utilisez cet utilitaire, les arguments [`context`](#context) et [`next()`](#next) sont automatiquement typés, et vous obtiendrez une erreur Typescript si vous essayez de renvoyer une [valeur non prise en charge dans votre middleware](#middlewarehandler).

```ts title="src/middleware.ts"
import { defineMiddleware } from "astro:middleware";

export const onRequest = defineMiddleware((context, next) => {
  /* la logique de votre middleware */
});
```

### `sequence()`

<p>

**Type :** <code>(...handlers: <a href="#middlewarehandler">MiddlewareHandler</a>[]) => MiddlewareHandler</code>
</p>

Une fonction qui accepte des fonctions de middleware comme arguments et les exécutera dans l'ordre dans lequel elles sont transmises.

```js title="src/middleware.js"
import { sequence } from "astro:middleware";

async function validation(context, next) {/* ... */}
async function auth(context, next) {/* ... */}
async function greeting(context, next) {/* ... */}

export const onRequest = sequence(validation, auth, greeting);
```

## Importations depuis `astro/middleware`

Les fonctions d'assistance suivantes peuvent être importées depuis le module middleware standard lors de la création d'une [intégration Astro](/fr/reference/integrations-reference/) :

```js
import {
  createContext,
  defineMiddleware,
  sequence,
  trySerializeLocals,
} from "astro/middleware";
```

### `createContext()`

<p>

**Type :** <code>(context: <a href="#createcontext-1">CreateContext</a>) => <a href="/fr/reference/api-reference/">APIContext</a></code><br />
<Since v="2.8.0" />
</p>

Une API de bas niveau pour créer un objet [`APIContext`](/fr/reference/api-reference/) à transmettre à une [fonction `onRequest()`](#onrequest) d'un middleware d'Astro.

Cette fonction peut être utilisée par les intégrations/adaptateurs pour exécuter par programmation le middleware d'Astro.

### `defineMiddleware()`

Voir [`defineMiddleware()`](#definemiddleware) de `astro:middleware`.

### `sequence()`

Voir [`sequence()`](#sequence) de `astro:middleware`.

### `trySerializeLocals()`

<p>

**Type :** `(value: unknown) => string`<br />
<Since v="2.8.0" />
</p>

Une API de bas niveau qui prend n'importe quelle valeur et tente d'en renvoyer une version sérialisée (une chaîne de caractères). Si la valeur ne peut pas être sérialisée, la fonction générera une erreur d'exécution.

## Types d'`astro/middleware`

Les types suivants sont importés du module middleware standard :

```js
import type {
  CreateContext,
} from "astro/middleware";
```

### `CreateContext`

<p>

**Type :** `{ request: Request; params?: Params; userDefinedLocales?: string[]; defaultLocale: string; locals: App.Locals; }`<br />
<Since v="2.8.0" />
</p>

Un objet pour [créer un contexte](#createcontext) à transmettre à un middleware Astro. Il contient les propriétés suivantes :

#### `request`

<p>

**Type :** `Request`
</p>

L'objet [`Request`](https://developer.mozilla.org/fr/docs/Web/API/Request) entrant.

#### `params`

<p>

**Type :** `Params`
</p>

Un objet contenant les paramètres optionnels à transmettre à [`Astro.params`](/fr/reference/api-reference/#params).

#### `userDefinedLocales`

<p>

**Type :** `string[]`<br />
<Since v="3.5.0" />
</p>

Une liste des paramètres régionaux pris en charge définis dans la [configuration `i18n` de l'utilisateur](/fr/reference/configuration-reference/#i18nlocales).

#### `defaultLocale`

<p>

**Type :** `string`<br />
<Since v="4.16.0" />
</p>

Le paramètre régional par défaut défini dans la [configuration `i18n` de l'utilisateur](/fr/reference/configuration-reference/#i18ndefaultlocale).

#### `locals`

<p>

**Type :** `App.Locals`<br />
<Since v="5.0.0" />
</p>

Un objet permettant de stocker des informations arbitraires provenant d'un middleware, accessible à l'utilisateur via [`Astro.locals`](/fr/reference/api-reference/#locals).

<ReadMore>Apprenez-en davantage sur [le stockage des données dans `locals`](/fr/guides/middleware/#stocker-des-données-dans-contextlocals) avec un exemple d'utilisation.</ReadMore>

## Types d'`astro`

```js
import type {
  MiddlewareHandler,
  MiddlewareNext,
  RewritePayload,
} from "astro";
```

### `MiddlewareHandler`

<p>

**Type :** <code>(context: <a href="/fr/reference/api-reference/">APIContext</a>, next: <a href="#middlewarenext">MiddlewareNext</a>) => Promise\<Response\> | Response | Promise\<void\> | void</code>
</p>

Représente une fonction middleware pour Astro. Les gestionnaires de middleware reçoivent deux arguments et peuvent soit renvoyer directement un objet `Response`, soit appeler `next()` pour invoquer le middleware suivant dans la chaîne. Vous pouvez également utiliser [`defineMiddleware()`](#definemiddleware) pour garantir la sûreté du typage pour votre middleware.

L'exemple suivant importe le type `MiddlewareHandler` pour garantir la sûreté du typage dans la fonction [`onRequest()`](#onrequest) :

```ts title="src/middleware.ts"
import type { MiddlewareHandler } from "astro";

export const onRequest: MiddlewareHandler = (context, next) => {
  /* la logique du middleware */
};
```

Un gestionnaire de middleware reçoit les propriétés suivantes :

#### `context`

<p>

**Type :** [`APIContext`](/fr/reference/api-reference/)
</p>

Un objet de [contexte Astro](/fr/reference/api-reference/) reflétant de nombreuses propriétés globales disponibles dans `Astro`.

#### `next()`

<p>

**Type :** [`MiddlewareNext`](#middlewarenext)<br />
</p>

Une fonction qui appelle tous les middlewares suivants dans la chaîne et renvoie un objet `Response`. Par exemple, d'autres middlewares pourraient modifier le corps HTML d'une réponse et l'attente du résultat de `next()` permettrait à votre middleware de réagir à ces modifications.

Depuis Astro v4.13.0, `next()` accepte un paramètre de chemin d'URL facultatif sous la forme d'une chaîne de caractères, d'une `URL` ou d'un objet `Request` pour [réécrire](/fr/guides/routing/#réécritures) la requête actuelle sans déclencher une nouvelle phase de rendu.

L'exemple suivant utilise `next()` pour diffuser du contenu à partir d'un chemin différent lorsque le chemin actuel correspond à `/ancien-chemin` :

```ts title="src/middleware.ts"
import type { MiddlewareHandler } from "astro";

export const onRequest: MiddlewareHandler = (context, next) => {
  if (context.url.pathname === '/ancien-chemin') {
    return next('/nouveau-chemin');
  }
  return next();
};
```

### `MiddlewareNext`

<p>

**Type :** <code>(rewritePayload?: <a href="#rewritepayload">RewritePayload</a>) => Promise\<Response\></code><br />
</p>

Représente la fonction [`next()`](#next) transmise aux gestionnaires de middleware.

### `RewritePayload`

<p>

**Type :** `string | URL | Request`<br />
<Since v="4.13.0" />
</p>

Représente la destination d'une [réécriture](/fr/guides/routing/#réécritures) lorsqu'elle est transmise à la fonction [`next()`](#next).

## Exportations depuis un middleware

Lors de la définition du middleware de votre projet dans `src/middleware.js`, exportez les fonctions définies par l'utilisateur suivantes :

### `onRequest()`

**Type :** [`MiddlewareHandler`](#middlewarehandler)

Une fonction requise exportée depuis `src/middleware.js` qui sera appelée avant le rendu de chaque page ou route d'API. Elle reçoit deux arguments : [context](#context) et [next()](#next). `onRequest()` doit renvoyer une réponse (`Response`) : soit directement, soit en appelant `next()`.

```js title="src/middleware.js"
export function onRequest (context, next) {
    // intercepte les données de réponse d'une requête
    // éventuellement, transforme la réponse
    // renvoie directement une réponse, ou le résultat de l'appel de `next()`
    return next();
};
```
