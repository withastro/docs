---
title: Sessions
description: Partagez des donn√©es entre les requ√™tes de pages rendues √† la demande.
i18nReady: true
---

import Since from '~/components/Since.astro';
import ReadMore from '~/components/ReadMore.astro';

<p>
<Since v="5.7.0" />
</p>

Les sessions sont utilis√©es pour partager des donn√©es entre les requ√™tes de [pages rendues √† la demande](/fr/guides/on-demand-rendering/). 

Contrairement aux [`cookies`](/fr/guides/on-demand-rendering/#cookies) classiques, les sessions sont stock√©es sur le serveur, ce qui vous permet de stocker de grandes quantit√©s de donn√©es sans vous soucier des limites de taille ni des probl√®mes de s√©curit√©. Bien que les sessions Astro cr√©ent un cookie pour stocker l'ID de session dans le navigateur, les donn√©es r√©elles restent c√¥t√© serveur, ce qui signifie que vous n'avez pas √† vous soucier d'exposer des informations sensibles ou d'atteindre les limites de stockage du navigateur.

Elles sont utiles pour stocker des √©l√©ments tels que les donn√©es utilisateur, les paniers d'achat et l'√©tat des formulaires, et fonctionnent sans JavaScript c√¥t√© client :

```astro title="src/components/CartButton.astro" {3}
---
export const prerender = false; // Pas n√©cessaire avec la sortie `server`
const cart = await Astro.session?.get('cart');
---

<a href="/checkout">üõí {cart?.length ?? 0} articles</a>
```

## Configuration des sessions

Les sessions n√©cessitent un pilote de stockage pour stocker les donn√©es de session. Les adaptateurs [Node](/fr/guides/integrations-guide/node/#sessions), [Cloudflare](/fr/guides/integrations-guide/cloudflare/#sessions) et [Netlify](/fr/guides/integrations-guide/netlify/#sessions) configurent automatiquement un pilote par d√©faut pour vous, mais d'autres adaptateurs n√©cessitent actuellement que vous [sp√©cifiiez un pilote manuellement](/fr/reference/configuration-reference/#sessiondriver). 

```js title="astro.config.mjs" ins={4}
  {
    adapter: vercel(),
    session: {
      driver: "redis",
    },
  }
```

<ReadMore>
  Consultez [l'option de configuration `session`](/fr/reference/configuration-reference/#options-des-sessions) pour plus de d√©tails sur la configuration d'un pilote de stockage et d'autres options configurables.
</ReadMore>


## Interaction avec les donn√©es de session

L'[objet `session`](/fr/reference/api-reference/#session) vous permet d'interagir avec l'√©tat utilisateur enregistr√© (par exemple, l'ajout d'articles au panier) et l'identifiant de session (par exemple, la suppression du cookie d'identifiant de session lors de la d√©connexion). Cet objet est accessible avec `Astro.session` dans vos composants et pages Astro, et avec `context.session` dans les points de terminaison d'API, les middlewares et les actions.

La session est g√©n√©r√©e automatiquement lors de sa premi√®re utilisation et peut √™tre r√©g√©n√©r√©e √† tout moment avec [`session.regenerate()`](/fr/reference/api-reference/#regenerate) ou d√©truite avec [`session.destroy()`](/fr/reference/api-reference/#destroy).

Pour de nombreux cas d'utilisation, vous aurez uniquement besoin d'utiliser [`session.get()`](/fr/reference/api-reference/#get) et [`session.set()`](/fr/reference/api-reference/#set). 

<ReadMore>
Consultez [la r√©f√©rence de l'API Sessions](/fr/reference/api-reference/#session) pour plus de d√©tails.
</ReadMore>

### Composants et pages Astro

Dans les composants et pages `.astro`, vous pouvez acc√©der √† l'objet session via l'objet global `Astro`. Par exemple, pour afficher le nombre d'articles dans un panier¬†:

```astro title="src/components/CartButton.astro" "Astro.session"
---
export const prerender = false; // Pas n√©cessaire avec la sortie `server`
const cart = await Astro.session?.get('cart');
---

<a href="/checkout">üõí {cart?.length ?? 0} articles</a>
```

### Points de terminaison d'API

Dans les points de terminaison d'API, l'objet session est disponible dans l'objet `context`. Par exemple, pour ajouter un article √† un panier¬†:

```ts title="src/pages/api/addToCart.ts" "context.session"
export async function POST(context: APIContext) {
  const cart = await context.session?.get('cart') || [];
	const data = await context.request.json<{ item: string }>();
  if(!data?.item) {
    return new Response('Un article est obligatoire', { status: 400 });
  }
  cart.push(data.item);
  await context.session?.set('cart', cart);
  return Response.json(cart);
}
```

### Actions

Dans les actions, l'objet session est disponible dans l'objet `context`. Par exemple, pour ajouter un article √† un panier¬†:

```ts title="src/actions/addToCart.ts" "context.session"
import { defineAction } from 'astro:actions';
import { z } from 'astro:schema';

export const server = {
  addToCart: defineAction({
    input: z.object({ productId: z.string() }),
    handler: async (input, context) => {
      const cart = await context.session?.get('cart');
      cart.push(input.productId);
      await context.session?.set('cart', cart);
      return cart;
    },
  }),
};
```

### Middleware

:::note
Les sessions ne sont actuellement pas prises en charge dans les middlewares de p√©riph√©rie.
:::

Dans le middleware, l'objet session est disponible dans l'objet `context`. Par exemple, pour d√©finir l'heure de la derni√®re visite de la session¬†:

```ts title="src/middleware.ts" "context.session"
import { defineMiddleware } from 'astro:middleware';

export const onRequest = defineMiddleware(async (context, next) => {
  context.session?.set('lastVisit', new Date());
  return next();
});
```

## Types des donn√©es de session

Par d√©faut, les donn√©es de session sont non typ√©es et vous pouvez stocker des donn√©es arbitraires dans n'importe quelle cl√©. Les valeurs sont s√©rialis√©es et d√©s√©rialis√©es avec [devalue](https://github.com/Rich-Harris/devalue), qui est la m√™me biblioth√®que utilis√©e dans les collections de contenu et les actions. Cela signifie que les types pris en charge sont les m√™mes et incluent les cha√Ænes de caract√®res, les nombres, `Date`, `Map`, `Set`, `URL`, les tableaux et les objets.

Vous pouvez √©ventuellement d√©finir des types TypeScript pour vos donn√©es de session en cr√©ant un fichier `src/env.d.ts` et en ajoutant une d√©claration pour le type `App.SessionData`¬†:

```ts title="src/env.d.ts"
declare namespace App {
  interface SessionData {
    user: {
      id: string;
      name: string;
    };
    cart: string[];
  }
}
```

Cela vous permettra d'acc√©der aux donn√©es de session avec la v√©rification des types et la saisie semi-automatique dans votre √©diteur¬†:

```ts title="src/components/CartButton.astro"
---
const cart = await Astro.session?.get('cart');
// const cart: string[] | undefined

const something = await Astro.session?.get('something');
// const something: any

Astro.session?.set('user', { id: 1, name: 'Houston' });
// Error: Argument of type '{ id: number; name: string }' is not assignable to parameter of type '{ id: string; name: string; }'.
---
```

:::caution
Ceci est uniquement utilis√© pour la v√©rification des types et n'affecte pas le comportement d'ex√©cution de la session. Soyez particuli√®rement vigilant si vous modifiez le type alors que les utilisateurs ont stock√© des donn√©es dans la session, car cela pourrait provoquer des erreurs d'ex√©cution.
:::
