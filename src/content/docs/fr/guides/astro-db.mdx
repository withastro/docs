---
title: 'Astro DB'
description: Apprenez √† utiliser Astro DB, une base de donn√©es SQL enti√®rement g√©r√©e, con√ßue exclusivement pour Astro.
githubIntegrationURL: 'https://github.com/withastro/astro/tree/main/packages/db/'
i18nReady: true
---
import { FileTree } from '@astrojs/starlight/components';
import PackageManagerTabs from '~/components/tabs/PackageManagerTabs.astro';
import ReadMore from '~/components/ReadMore.astro';
import Since from '~/components/Since.astro';
import { Steps } from '@astrojs/starlight/components';

Astro DB est une base de donn√©es SQL enti√®rement g√©r√©e con√ßue pour l'√©cosyst√®me Astro. D√©veloppez localement dans Astro et d√©ployez vers n'importe quelle base de donn√©es compatible libSQL.

Astro DB est une solution compl√®te pour configurer, d√©velopper et interroger vos donn√©es. Une base de donn√©es locale est cr√©√©e dans `.astro/content.db` chaque fois que vous ex√©cutez `astro dev` pour g√©rer vos donn√©es sans avoir besoin de Docker ou d'une connexion r√©seau.

## Installation

Installez [l'int√©gration `@astrojs/db`](/fr/guides/integrations-guide/db/) √† l'aide de la commande int√©gr√©e `astro add`¬†:

<PackageManagerTabs>
  <Fragment slot="npm">
    ```sh
    npx astro add db
    ```
  </Fragment>
  <Fragment slot="pnpm">
    ```sh
    pnpm astro add db
    ```
  </Fragment>
  <Fragment slot="yarn">
    ```sh
    yarn astro add db
    ```
  </Fragment>
</PackageManagerTabs>

## D√©finir votre base de donn√©es

L'installation de `@astrojs/db` avec la commande `astro add` cr√©era automatiquement un fichier `db/config.ts` dans votre projet o√π vous d√©finirez vos tables de base de donn√©es¬†:

```ts title="db/config.ts"
import { defineDb } from 'astro:db';

export default defineDb({
  tables: { },
})
```

### Tables

Dans Astro DB, les donn√©es sont stock√©es dans des tables SQL. Les tables structurent vos donn√©es en lignes et en colonnes, o√π les colonnes imposent le type de chaque valeur de ligne.

D√©finissez vos tables dans votre fichier `db/config.ts` en fournissant la structure des donn√©es de votre base de donn√©es libSQL existante ou les donn√©es que vous collecterez dans une nouvelle base de donn√©es. Cela permettra √† Astro de g√©n√©rer une interface TypeScript pour interroger cette table √† partir de votre projet. Le r√©sultat est une prise en charge compl√®te de TypeScript lorsque vous acc√©dez √† vos donn√©es avec la saisie semi-automatique des propri√©t√©s et la v√©rification des types.

Pour configurer une table de base de donn√©es, importez et utilisez les utilitaires `defineTable()` et `column` depuis `astro:db`. Ensuite, d√©finissez un nom (sensible √† la casse) pour votre table et le type de donn√©es dans chaque colonne.

Cet exemple configure une table `Comment` avec les colonnes de texte requises pour `author` et `body` et la rend disponible pour votre projet via l'exportation `defineDb()`.

```ts title="db/config.ts" "Comment"
import { defineDb, defineTable, column } from 'astro:db';

const Comment = defineTable({
  columns: {
    author: column.text(),
    body: column.text(),
  }
})

export default defineDb({
  tables: { Comment },
})
```

<ReadMore>Voir la [r√©f√©rence de configuration des tables](/fr/guides/integrations-guide/db/#r√©f√©rence-de-configuration-des-tables) pour une r√©f√©rence compl√®te des options de table.</ReadMore>

### Colonnes

Astro DB prend en charge les types de colonnes suivants :

```ts title="db/config.ts" "column.text()" "column.number()" "column.boolean()" "column.date()" "column.json()"
import { defineTable, column } from 'astro:db';

const Comment = defineTable({
  columns: {
    // Une cha√Æne de texte.
    author: column.text(),
    // Une valeur enti√®re.
    likes: column.number(),
    // Une valeur vraie ou fausse.
    flagged: column.boolean(),
    // Valeurs de date et d'heure interrog√©es sous forme d'Objets JavaScript de type date.
    published: column.date(),
    // Un objet JSON non typ√©.
    metadata: column.json(),
  }
});
```

<ReadMore>Voir la [r√©f√©rence des colonnes de la table](/fr/guides/integrations-guide/db/#r√©f√©rence-de-configuration-des-tables) pour plus de d√©tails.</ReadMore>

### R√©f√©rences des tables

Les relations entre les tables sont un mod√®le courant dans la conception des bases de donn√©es. Par exemple, une table `Blog` peut √™tre en relation √©troite avec d'autres tables `Comment`, `Author`, et `Category`.

Vous pouvez d√©finir ces relations entre les tables et les enregistrer dans votre sch√©ma de base de donn√©es √† l'aide de **colonnes de r√©f√©rence**. Pour √©tablir une relation, vous aurez besoin de :

- Une **colonne identifiant** de la table r√©f√©renc√©e. Il s'agit g√©n√©ralement d'une colonne `id` avec la propri√©t√© `primaryKey`.
- Une colonne sur la table de base pour **stocker l'`id` r√©f√©renc√©**. Celle-ci utilise la propri√©t√© `references` pour √©tablir une relation.

Cet exemple montre que la colonne `authorId` d'une table `Comment` fait r√©f√©rence √† la colonne `id` d'une table `Author`.

```ts title="db/config.ts" {3, 10}
const Author = defineTable({
  columns: {
    id: column.number({ primaryKey: true }),
    name: column.text(),
  }
});

const Comment = defineTable({
  columns: {
    authorId: column.number({ references: () => Author.columns.id }),
    body: column.text(),
  }
});
```

## Alimentez votre base de donn√©es pour le d√©veloppement

En cours de d√©veloppement, Astro utilisera la configuration de votre base de donn√©es pour g√©n√©rer des types locaux en fonction de vos sch√©mas. Ces derniers seront g√©n√©r√©s √† partir de votre fichier de d√©part √† chaque d√©marrage du serveur de d√©veloppement et vous permettront d'interroger et de travailler avec la forme de vos donn√©es avec la s√ªret√© du typage et la saisie semi-automatique.

Vous n'aurez pas acc√®s aux donn√©es de production pendant le d√©veloppement, sauf si vous vous [connectez √† une base de donn√©es distante](#connexion-√†-des-bases-de-donn√©es-distantes) pendant le d√©veloppement. Cela prot√®ge vos donn√©es tout en vous permettant de tester et de d√©velopper avec une base de donn√©es fonctionnelle et la s√ªret√© du typage.

Pour introduire des donn√©es de d√©veloppement √† des fins de test et de d√©bogage dans votre projet Astro, cr√©ez un fichier `db/seed.ts`. Importez √† la fois l'objet `db` et vos tables d√©finies dans `astro:db`. Puis ins√©rez des donn√©es initiales dans chaque table. Ces donn√©es de d√©veloppement doivent correspondre √† la forme de votre sch√©ma de base de donn√©es et de vos donn√©es de production.

L'exemple suivant d√©finit deux lignes de donn√©es de d√©veloppement pour une table `Comment` et une table `Author`¬†:

```ts title="db/seed.ts"
import { db, Comment, Author } from 'astro:db';

export default async function() {
  await db.insert(Author).values([
    { id: 1, name: "Kasim" },
    { id: 2, name: "Mina" },
  ]);

  await db.insert(Comment).values([
    { authorId: 1, body: 'Hope you like Astro DB!' },
    { authorId: 2, body: 'Enjoy!'},
  ])
}
```

Votre serveur de d√©veloppement red√©marrera automatiquement votre base de donn√©es chaque fois que ce fichier sera modifi√©, en r√©g√©n√©rant vos types et en initialisant ces donn√©es de d√©veloppement √† partir de `seed.ts` √† chaque fois.

## Connecter une base de donn√©es libSQL pour la production

Astro DB peut se connecter √† n'importe quelle base de donn√©es libSQL locale ou √† n'importe quel serveur qui expose le protocole distant libSQL, qu'il soit g√©r√© ou auto-h√©berg√©.

Pour connecter Astro DB √† une base de donn√©es libSQL, d√©finissez les variables d'environnement suivantes obtenues aupr√®s de votre fournisseur de base de donn√©es¬†:

- `ASTRO_DB_REMOTE_URL`¬†: l'URL de connexion √† l'emplacement de votre base de donn√©es libSQL locale ou distante. Cela peut inclure des [options de configuration d'URL](#options-de-configuration-durl-distantes) telles que la synchronisation et le chiffrement en tant que param√®tres.
- `ASTRO_DB_APP_TOKEN`¬†: le jeton d'authentification de votre serveur libSQL. Ceci est n√©cessaire pour les bases de donn√©es distantes et n'est pas n√©cessaire pour [les bases de donn√©es locales comme les fichiers ou les bases de donn√©es en m√©moire](#sch√©ma-durl-et-h√¥te).

Selon votre service, vous pouvez avoir acc√®s √† une interface CLI ou √† une interface Web pour r√©cup√©rer ces valeurs. La section suivante illustre la connexion √† Turso et la d√©finition de ces valeurs √† titre d'exemple, mais vous √™tes libre d'utiliser n'importe quel fournisseur.

### Premiers pas avec Turso

Turso est l'entreprise √† l'origine de [libSQL](https://github.com/tursodatabase/libsql), le fork open source de SQLite qui alimente Astro DB. Ils fournissent une plate-forme de base de donn√©es libSQL enti√®rement g√©r√©e et sont enti√®rement compatibles avec Astro.

Les √©tapes ci-dessous vous guideront tout au long du processus d'installation de Turso CLI, de connexion (ou d'inscription), de cr√©ation d'une nouvelle base de donn√©es, d'obtention des variables d'environnement requises et de transmission du sch√©ma √† la base de donn√©es distante.

<Steps>

1. Installez le [CLI de Turso](https://docs.turso.tech/cli/installation).

2. [Connectez-vous ou inscrivez-vous](https://docs.turso.tech/cli/authentication) √† Turso.

3. Cr√©ez une nouvelle base de donn√©es. Dans cet exemple, le nom de la base de donn√©es est `andromeda`.

   ```sh "andromeda"
   turso db create andromeda
   ```

4. Ex√©cutez la commande `show` pour voir les informations sur la base de donn√©es nouvellement cr√©√©e¬†:

   ```sh "andromeda"
   turso db show andromeda
   ```

   Copiez la valeur `URL` et d√©finissez-la comme valeur pour `ASTRO_DB_REMOTE_URL`.
   

   ```dotenv title=".env" "libsql://andromeda-houston.turso.io"
   ASTRO_DB_REMOTE_URL=libsql://andromeda-houston.turso.io
   ```

5. Cr√©ez un nouveau jeton pour authentifier les requ√™tes vers la base de donn√©es¬†:

   ```sh "andromeda"
   turso db tokens create andromeda
   ```

   Copiez la sortie de la commande et d√©finissez-la comme valeur pour `ASTRO_DB_APP_TOKEN`.

   ```dotenv title=".env" add={2} "eyJhbGciOiJF...3ahJpTkKDw"
   ASTRO_DB_REMOTE_URL=libsql://andromeda-houston.turso.io
   ASTRO_DB_APP_TOKEN=eyJhbGciOiJF...3ahJpTkKDw
   ```

6. Transf√©rez vos sch√©ma et m√©tadonn√©es de base de donn√©es vers la nouvelle base de donn√©es Turso.

   ```sh
   astro db push --remote
   ```

7. F√©licitations, vous avez maintenant une base de donn√©es connect√©e¬†! Accordez-vous une pause. üëæ

   ```sh
   turso relax
   ```

</Steps>

Pour d√©couvrir davantage de fonctionnalit√©s de Turso, consultez la [documentation de Turso](https://docs.turso.tech).

### Connexion √† des bases de donn√©es distantes

Astro DB vous permet de vous connecter √† des bases de donn√©es locales et distantes. Par d√©faut, Astro utilise un fichier de base de donn√©es local pour les commandes `dev` et `build`, recr√©ant des tables et ins√©rant des donn√©es de d√©veloppement √† chaque fois.

Pour vous connecter √† une base de donn√©es distante h√©berg√©e, utilisez l'indicateur `--remote`. Celui-ci permet un acc√®s en lecture et en √©criture √† votre base de donn√©es distante, ce qui vous permet d'[accepter et de conserver les donn√©es utilisateur](#ins√©rer) dans les environnements de production.

:::note
Bien que les connexions √† distance soient g√©n√©ralement possibles avec n'importe quelle plateforme de d√©ploiement utilisant le mode de rendu statique ou serveur, il existe actuellement certaines limitations. Les environnements d'ex√©cution non-Node comme Cloudflare et Deno ne prennent actuellement pas en charge les bases de donn√©es sur les routes rendues par le serveur lors de l'utilisation de libSQL. La prise en charge de ces plateformes est pr√©vue pour une impl√©mentation future.
:::

Configurez votre commande de construction pour utiliser l'indicateur `--remote`¬†:

```json title="package.json" "--remote"
{
  "scripts": {
    "build": "astro build --remote"
  }
}
```

Vous pouvez √©galement utiliser l'indicateur directement dans la ligne de commande¬†:

```bash
# Construire avec une connexion √† distance
astro build --remote

# D√©velopper avec une connexion √† distance
astro dev --remote
```

:::caution
Soyez prudent lorsque vous utilisez `--remote` en d√©veloppement. Cela entra√Æne la connexion √† votre base de donn√©es de production en direct et toutes les modifications (insertions, mises √† jour, suppressions) seront conserv√©es.
:::

L'indicateur `--remote` utilise la connexion √† la base de donn√©es distante √† la fois localement pendant la construction et sur le serveur. Assurez-vous de d√©finir les variables d'environnement n√©cessaires √† la fois dans votre environnement de d√©veloppement local et sur votre plateforme de d√©ploiement.

Lors du d√©ploiement de votre projet Astro DB, assurez-vous que la commande de construction de votre plate-forme de d√©ploiement est d√©finie sur `npm run build` (ou l'√©quivalent pour votre gestionnaire de packages) pour utiliser l'indicateur `--remote` configur√© dans votre fichier `package.json`.

### Options de configuration d'URL distantes

La variable d'environnement `ASTRO_DB_REMOTE_URL` configure l'emplacement de votre base de donn√©es ainsi que d'autres options telles que la synchronisation et le chiffrement.

#### Sch√©ma d'URL et h√¥te

libSQL prend en charge HTTP et WebSockets comme protocole de transport pour un serveur distant. Il prend √©galement en charge l'utilisation d'un fichier local ou d'une base de donn√©es en m√©moire. Ceux-ci peuvent √™tre configur√©s √† l'aide des sch√©mas d'URL suivants dans l'URL de connexion¬†:

- `memory:` utilisera une base de donn√©es en m√©moire. L'h√¥te doit √™tre vide dans ce cas.
- `file:` utilisera un fichier local. L'h√¥te est le chemin d'acc√®s au fichier (`file:path/to/file.db`).
- `libsql:` utilisera un serveur distant via le protocole pr√©f√©r√© par la biblioth√®que (cela peut √™tre diff√©rent selon les versions). L'h√¥te est l'adresse du serveur (`libsql://your.server.io`).
- `http:` utilisera un serveur distant via HTTP. `https:` peut √™tre utilis√© pour activer une connexion s√©curis√©e. L'h√¥te est le m√™me que pour `libsql:`.
- `ws:` utilisera un serveur distant via WebSockets. `wss:` peut √™tre utilis√© pour activer une connexion s√©curis√©e. L'h√¥te est le m√™me que pour `libsql:`.

Les d√©tails de la connexion libSQL (par exemple, la cl√© de chiffrement, la r√©plication, l'intervalle de synchronisation) peuvent √™tre configur√©s comme param√®tres de requ√™te dans l'URL de connexion √† distance.

Par exemple, pour qu'un fichier local chiffr√© fonctionne comme une r√©plique int√©gr√©e sur un serveur libSQL, vous pouvez d√©finir les variables d'environnement suivantes¬†:

```dotenv title=".env"
ASTRO_DB_REMOTE_URL=file://local-copy.db?encryptionKey=your-encryption-key&syncInterval=60&syncUrl=libsql%3A%2F%2Fyour.server.io
ASTRO_DB_APP_TOKEN=token-to-your-remote-url
```

:::caution
L'utilisation d'un fichier de base de donn√©es est une fonctionnalit√© avanc√©e et des pr√©cautions doivent √™tre prises lors du d√©ploiement pour √©viter de remplacer votre base de donn√©es et de perdre vos donn√©es de production.

De plus, cette m√©thode ne fonctionnera pas dans les d√©ploiements sans serveur, car le syst√®me de fichiers n‚Äôest pas conserv√© dans ces environnements.
:::

#### `encryptionKey`

libSQL prend en charge nativement les bases de donn√©es chiffr√©es. La transmission de ce param√®tre de recherche activera le chiffrement √† l'aide de la cl√© donn√©e¬†:

```dotenv title=".env"
ASTRO_DB_REMOTE_URL=file:path/to/file.db?encryptionKey=your-encryption-key
```

#### `syncUrl`

Les r√©pliques int√©gr√©es sont une fonctionnalit√© des clients libSQL qui cr√©e une copie synchronis√©e compl√®te de votre base de donn√©es sur un fichier local ou en m√©moire pour des lectures ultra-rapides. Les √©critures sont envoy√©es vers une base de donn√©es distante d√©finie sur `syncUrl` et synchronis√©es avec la copie locale.

Utilisez cette propri√©t√© pour transmettre une URL de connexion distincte afin de transformer la base de donn√©es en une r√©plique int√©gr√©e d'une autre base de donn√©es. Cela ne doit √™tre utilis√© qu'avec les sch√©mas `file:` et `memory:`. Le param√®tre doit √™tre cod√© au format URL.

Par exemple, pour avoir une r√©plique int√©gr√©e en m√©moire d'une base de donn√©es sur `libsql://votre.server.io`, vous pouvez d√©finir l'URL de connexion comme suit¬†:

```dotenv title=".env"
ASTRO_DB_REMOTE_URL=memory:?syncUrl=libsql%3A%2F%2Fyour.server.io
```

#### `syncInterval`

Intervalle en secondes entre les synchronisations de r√©pliques int√©gr√©es. Par d√©faut, la synchronisation se fait uniquement au d√©marrage et apr√®s les √©critures.

Cette propri√©t√© n'est utilis√©e que lorsque `syncUrl` est √©galement d√©finie. Par exemple, pour configurer une r√©plique int√©gr√©e en m√©moire afin qu'elle se synchronise toutes les minutes, d√©finissez la variable d'environnement suivante¬†:

```dotenv title=".env"
ASTRO_DB_REMOTE_URL=memory:?syncUrl=libsql%3A%2F%2Fyour.server.io&syncInterval=60
```

## Interrogez votre base de donn√©es

Vous pouvez interroger votre base de donn√©es depuis n'importe quelle [page Astro](/fr/basics/astro-pages/#pages-astro) ou [endpoint](/fr/guides/endpoints/) ou [action](/fr/guides/actions/) de votre projet en utilisant l'ORM `db` et le constructeur de requ√™tes fourni.

### Drizzle ORM

```ts
import { db } from 'astro:db';
```

Astro DB comprend un client int√©gr√© [Drizzle ORM](https://orm.drizzle.team/). Il n'y a pas d'installation ou de configuration manuelle requise pour utiliser le client. Le client Astro DB `db` est automatiquement configur√© pour communiquer avec votre base de donn√©es (locale ou distante) lorsque vous lancez Astro. Il utilise la d√©finition exacte de votre sch√©ma de base de donn√©es pour des requ√™tes SQL avec s√ªret√© du typage et des erreurs TypeScript lorsque vous r√©f√©rencez une colonne ou une table qui n'existe pas.

### S√©lectionner

L'exemple suivant s√©lectionne toutes les lignes d'une table `Comment`. Cela renvoie le tableau complet des donn√©es de d√©veloppement provenant de `db/seed.ts`, qui est alors disponible pour √™tre utilis√© dans votre mod√®le de page :

```astro title="src/pages/index.astro"
---
import { db, Comment } from 'astro:db';

const comments = await db.select().from(Comment);
---

<h2>Commentaires</h2>

{
  comments.map(({ author, body }) => (
    <article>
      <p>Auteur : {author}</p>
      <p>{body}</p>
    </article>
  ))
}
```

<ReadMore>Consultez la [r√©f√©rence `select()` de l'API Drizzle](https://orm.drizzle.team/docs/select) pour un aper√ßu complet.</ReadMore>

### Ins√©rer

Pour accepter les entr√©es de l'utilisateur, comme le traitement des demandes de formulaire et l'insertion de donn√©es dans votre base de donn√©es h√©berg√©e √† distance, configurez votre projet Astro pour [un rendu √† la demande](/fr/guides/on-demand-rendering/) et [ajoutez un adaptateur](/fr/guides/on-demand-rendering/#ajouter-un-adaptateur) pour votre environnement de d√©ploiement.

Cet exemple ins√®re une ligne dans une table `Comment` sur la base d'une requ√™te POST de formulaire analys√©e :

```astro
---
// src/pages/index.astro
import { db, Comment } from 'astro:db';

if (Astro.request.method === 'POST') {
  // Analyser les donn√©es du formulaire
  const formData = await Astro.request.formData();
  const author = formData.get('author');
  const content = formData.get('content');
  if (typeof author === 'string' && typeof content === 'string') {
    // Ins√©rer les donn√©es du formulaire dans la table Comment
    await db.insert(Comment).values({ author, content });
  }
}

// Affiche la nouvelle liste des commentaires sur chaque demande
const comments = await db.select().from(Comment);
---

<form method="POST" style="display: grid">
	<label for="author">Auteur</label>
	<input id="author" name="author" />

	<label for="body">Corps</label>
	<textarea id="body" name="body"></textarea>

	<button type="submit">Envoyer</button>
</form>

<!-- Afficher les commentaires -->
```

Vous pouvez √©galement utiliser [Astro Actions](/fr/guides/actions/) pour ins√©rer des donn√©es dans une table Astro DB. L'exemple suivant ins√®re une ligne dans une table `Comment` √† l'aide d'une action¬†:

```ts
// src/actions/index.ts
import { db, Comment } from 'astro:db';
import { defineAction } from 'astro:actions';
import { z } from 'astro:schema';

export const server = {
  addComment: defineAction({
    // Les actions incluent la s√ªret√© du typage avec Zod, supprimant ainsi le
    // besoin de v√©rifier si typeof {value} === 'string' dans vos pages
    input: z.object({
      author: z.string(),
      body: z.string(),
    }),
    handler: async (input) => {
      const updatedComments = await db
        .insert(Comment)
        .values(input)
        .returning(); // Renvoie les commentaires mis √† jour
      return updatedComments;
    },
  }),
};
```

<ReadMore>

Consultez la [r√©f√©rence `insert()` de l'API Drizzle] (https://orm.drizzle.team/docs/insert) pour une vue d'ensemble compl√®te.

</ReadMore>

### Supprimer

Vous pouvez √©galement interroger votre base de donn√©es √† partir d'un point de terminaison d'API. Cet exemple supprime une ligne d'une table `Comment` par le param√®tre `id`¬†:

```ts
// src/pages/api/comments/[id].ts
import type { APIRoute } from "astro";
import { db, Comment, eq } from 'astro:db';

export const DELETE: APIRoute = async (ctx) => {
  await db.delete(Comment).where(eq(Comment.id, ctx.params.id ));
  return new Response(null, { status: 204 });
}
```

<ReadMore>

Consultez la [r√©f√©rence `delete()` de l'API Drizzle](https://orm.drizzle.team/docs/delete) pour un aper√ßu complet.

</ReadMore>

### Filtrage

Pour rechercher les r√©sultats d'une table en fonction d'une propri√©t√© sp√©cifique, utilisez [les options Drizzle pour les s√©lections partielles](https://orm.drizzle.team/docs/select#partial-select). Par exemple, ajoutez [un appel √† `.where()`](https://orm.drizzle.team/docs/select#filtering) √† votre requ√™te `select()` et passez la comparaison que vous voulez faire.

L'exemple suivant recherche toutes les lignes d'une table `Comment` qui contiennent l'expression ¬´¬†Astro DB¬†¬ª. Utilisez [l'op√©rateur `like()`](https://orm.drizzle.team/docs/operators#like) pour v√©rifier si une phrase est pr√©sente dans le `body` :


```astro title="src/pages/index.astro"
---
import { db, Comment, like } from 'astro:db';

const comments = await db.select().from(Comment).where(
    like(Comment.body, '%Astro DB%')
);
---
```

### Utilitaires de Drizzle

Tous les utilitaires Drizzle permettant de construire des requ√™tes sont expos√©s √† partir du module `astro:db`. Cela inclut :

- [Op√©rateurs de filtre](https://orm.drizzle.team/docs/operators) comme `eq()` et `gt()`
- [Les aides √† l'agr√©gation](https://orm.drizzle.team/docs/select#aggregations-helpers) comme `count()`
- [L'aide `sql`](https://orm.drizzle.team/docs/sql) pour √©crire des requ√™tes SQL brutes

```ts
import { eq, gt, count, sql } from 'astro:db';
```

### Les relations

Vous pouvez interroger des donn√©es li√©es provenant de plusieurs tables √† l'aide d'une liaison SQL. Pour cr√©er une requ√™te de liaison, ajoutez un op√©rateur de liaison √† votre d√©claration `db.select()`. Chaque fonction accepte une table √† l'origine de la liaison et une condition pour faire correspondre les lignes entre les deux tables.

Cet exemple utilise une fonction `innerJoin()` pour faire la liaison entre les auteurs de `Commentaires` et leurs informations `Author` sur la base de la colonne `authorId`. Cette fonction retourne un tableau d'objets avec chaque ligne `Author` et `Comment` comme propri√©t√©s de premier niveau :

```astro title="src/pages/index.astro"
---
import { db, eq, Comment, Author } from 'astro:db';

const comments = await db.select()
  .from(Comment)
  .innerJoin(Author, eq(Comment.authorId, Author.id));
---

<h2>Commentaires</h2>

{
  comments.map(({ Author, Comment }) => (
    <article>
      <p>Auteur : {Author.name}</p>
      <p>{Comment.body}</p>
    </article>
  ))
}
```

<ReadMore>

  Voir la [r√©f√©rence de liaison Drizzle](https://orm.drizzle.team/docs/joins#join-types) pour tous les op√©rateurs de liaison disponibles et les options de configuration.

</ReadMore>

### Transactions par paquets

Toutes les requ√™tes de bases de donn√©es distantes sont effectu√©es sous la forme d'une requ√™te r√©seau. Vous pouvez avoir besoin de regrouper les requ√™tes en une seule transaction lorsque vous effectuez un grand nombre de requ√™tes, ou de proc√©der √† des retours en arri√®re automatiques en cas d'√©chec d'une requ√™te.

Cet exemple permet de lancer plusieurs lignes en une seule requ√™te √† l'aide de la m√©thode `db.batch()` :

```ts
// db/seed.ts
import { db, Author, Comment } from 'astro:db';

export default async function () {
  let queries;
  // Envoyez 100 exemples de commentaires dans votre base de donn√©es distante
  // avec une seule demande de r√©seau.
  for (let i = 0; i < 100; i++) {
    queries.push(db.insert(Comment).values({ body: `Test comment ${i}` }));
  }
  await db.batch(queries);
}
```

<ReadMore>

  Voir la documentation [Drizzle `db.batch()`](https://orm.drizzle.team/docs/batch-api) pour plus de d√©tails.

</ReadMore>

## Envoi des modifications vers votre base de donn√©es

Vous pouvez transf√©rer les modifications apport√©es pendant le d√©veloppement vers votre base de donn√©es.

### Pousser les sch√©mas de table

Votre sch√©ma de table peut changer au fil du temps √† mesure que votre projet se d√©veloppe. Vous pouvez tester en toute s√©curit√© les modifications de configuration localement et les transf√©rer vers votre base de donn√©es distante lors du d√©ploiement.

Vous pouvez transf√©rer les modifications de votre sch√©ma local vers votre base de donn√©es distante via le CLI √† l'aide de la commande `astro db push --remote`¬†:

<PackageManagerTabs>
  <Fragment slot="npm">
    ```sh
    npm run astro db push --remote
    ```
  </Fragment>
  <Fragment slot="pnpm">
    ```sh
    pnpm astro db push --remote
    ```
  </Fragment>
  <Fragment slot="yarn">
    ```sh
    yarn astro db push --remote
    ```
  </Fragment>
</PackageManagerTabs>

Cette commande v√©rifiera que vos modifications locales peuvent √™tre effectu√©es sans perte de donn√©es et, si n√©cessaire, vous sugg√©rera comment apporter des modifications en toute s√©curit√© √† votre sch√©ma afin de r√©soudre les conflits.

#### Pousser les changements majeurs de sch√©ma

:::caution
__Cela d√©truira votre base de donn√©es__. N'ex√©cutez cette commande que si vous n'avez pas besoin de vos donn√©es de production.
:::

Si vous devez modifier le sch√©ma de votre table d'une mani√®re incompatible avec vos donn√©es existantes h√©berg√©es chez Astro Studio, vous devrez r√©initialiser votre base de donn√©es de production.

Pour pousser une mise √† jour du sch√©ma de table qui inclut un changement radical, ajoutez le drapeau `--force-reset` pour r√©initialiser toutes les donn√©es de production :

<PackageManagerTabs>
  <Fragment slot="npm">
    ```sh
    npm run astro db push --remote --force-reset
    ```
  </Fragment>
  <Fragment slot="pnpm">
    ```sh
    pnpm astro db push --remote --force-reset
    ```
  </Fragment>
  <Fragment slot="yarn">
    ```sh
    yarn astro db push --remote --force-reset
    ```
  </Fragment>
</PackageManagerTabs>

### Renommer des tables

Il est possible de renommer une table apr√®s avoir transmis votre sch√©ma √† votre base de donn√©es distante.

Si vous **n'avez pas de donn√©es de production importantes**, alors vous pouvez [r√©initialiser votre base de donn√©es](#pousser-les-changements-majeurs-de-sch√©ma) en utilisant l'option `--force-reset`. Cet indicateur supprimera toutes les tables de la base de donn√©es et en cr√©era de nouvelles afin qu'elles correspondent exactement √† votre sch√©ma actuel.

Pour renommer une table tout en pr√©servant vos donn√©es de production, vous devez effectuer une s√©rie de modifications non cassantes pour transf√©rer votre sch√©ma local vers votre base de donn√©es distante en toute s√©curit√©.

L'exemple suivant renomme une table `Comment` en `Feedback` :

<Steps>

1. Dans le fichier de configuration de votre base de donn√©es, ajoutez la propri√©t√© `deprecated: true` √† la table que vous voulez renommer :

    ```ts title="db/config.ts" ins={2}
    const Comment = defineTable({
      deprecated: true,
    	columns: {
    		author: column.text(),
    		body: column.text(),
  		}
    });
    ```

2. Ajoutez un nouveau sch√©ma de table (correspondant exactement aux propri√©t√©s de la table existante) avec le nouveau nom :

	  ```ts title="db/config.ts" ins={8-14}
    const Comment = defineTable({
        deprecated: true,
    	columns: {
    		author: column.text(),
    		body: column.text(),
  		}
    });

	  const Feedback = defineTable({
        columns: {
          author: column.text(),
          body: column.text(),
        }
    });
    ```
3. [Poussez vers votre base de donn√©es distante](#pousser-les-sch√©mas-de-table) avec `astro db push --remote`. Cela ajoutera la nouvelle table et marquera l'ancienne comme obsol√®te.
4. Mettez √† jour le code de votre projet local pour utiliser la nouvelle table au lieu de l'ancienne. Il se peut que vous deviez √©galement migrer des donn√©es vers la nouvelle table.
5. Une fois que vous √™tes s√ªr que l'ancienne table n'est plus utilis√©e dans votre projet, vous pouvez supprimer le sch√©ma de votre `config.ts` :
		```ts title="db/config.ts" del={1-7}
    const Comment = defineTable({
          deprecated: true,
    	  columns: {
    		  author: column.text(),
    		  body: column.text(),
  		  }
    });

	  const Feedback = defineTable({
          columns: {
            author: column.text(),
            body: column.text(),
          }
    });
    ```
6. Poussez √† nouveau vers votre base de donn√©es distante avec `astro db push --remote`. L'ancienne table sera supprim√©e, ne laissant que la nouvelle table renomm√©e.
</Steps>

### Pousser les donn√©es d'une table

Vous devrez peut-√™tre transf√©rer des donn√©es vers votre base de donn√©es distante pour l'amor√ßage ou les migrations de donn√©es. Vous pouvez cr√©er un fichier `.ts` avec le module `astro:db` pour √©crire des requ√™tes avec s√ªret√© du typage. Ensuite, ex√©cutez le fichier sur votre base de donn√©es distante √† l'aide de la commande `astro db execute <file-path> --remote` :

Les commentaires suivants peuvent √™tre initi√©s √† l'aide de la commande `astro db execute db/seed.ts --remote` :

```ts
// db/seed.ts
import { Comment } from 'astro:db';

export default async function () {
  await db.insert(Comment).values([
    { authorId: 1, body: "J'esp√®re que vous aimerez Astro DB !" },
    { authorId: 2, body: 'Profitez !' },
  ])
}
```

<ReadMore>

Voir la [r√©f√©rence CLI](/fr/guides/integrations-guide/db/#r√©f√©rence-cli-astro-db) pour une liste compl√®te des commandes.

</ReadMore>

## Construire des int√©grations Astro DB

Les [int√©grations Astro](/fr/reference/integrations-reference/) permettent d'√©tendre les projets des utilisateurs avec des tables Astro DB suppl√©mentaires et des donn√©es de d√©part.

Utilisez la m√©thode `extendDb()` dans le hook `astro:db:setup` pour enregistrer des fichiers de configuration et de donn√©es initiales (_seed_) Astro DB suppl√©mentaires.
L'aide `defineDbIntegration()` fournit le support TypeScript et l'auto-compl√©tion pour le crochet `astro:db:setup`.

```js {8-13}
// my-integration/index.ts
import { defineDbIntegration } from '@astrojs/db/utils';

export default function MyIntegration() {
  return defineDbIntegration({
    name: 'my-astro-db-powered-integration',
    hooks: {
      'astro:db:setup': ({ extendDb }) => {
        extendDb({
          configEntrypoint: '@astronaut/my-package/config',
          seedEntrypoint: '@astronaut/my-package/seed',
        });
      },
      // Autres crochets d'int√©gration...
    },
  });
}
```

Les fichiers de [configuration](#d√©finir-votre-base-de-donn√©es) et de [donn√©es initiales](#alimentez-votre-base-de-donn√©es-pour-le-d√©veloppement) des int√©grations suivent le m√™me format que leurs √©quivalents d√©finis par l'utilisateur.

### Op√©rations avec s√ªret√© du typage dans les int√©grations

Lorsque vous travaillez sur des int√©grations, il se peut que vous ne puissiez pas b√©n√©ficier des types de table g√©n√©r√©s par Astro et export√©s depuis `astro:db`.
Pour une s√©curit√© totale des types, utilisez l'utilitaire `asDrizzleTable()` pour cr√©er un objet de r√©f√©rence de table que vous pouvez utiliser pour les op√©rations de base de donn√©es.

Par exemple, dans le cas d'une int√©gration mettant en place la table de base de donn√©es `Pets` suivante :

```js
// my-integration/config.ts
import { defineDb, defineTable, column } from 'astro:db';

export const Pets = defineTable({
  columns: {
    name: column.text(),
    species: column.text(),
  },
});

export default defineDb({ tables: { Pets } });
```

Le fichier _seed_ (donn√©es initiales) peut importer `Pets` et utiliser `asDrizzleTable()` pour ins√©rer des lignes dans votre table avec v√©rification du type :

```js {2,7} /typeSafePets(?! )/
// my-integration/seed.ts
import { asDrizzleTable } from '@astrojs/db/utils';
import { db } from 'astro:db';
import { Pets } from './config';

export default async function() {
  const typeSafePets = asDrizzleTable('Pets', Pets);

  await db.insert(typeSafePets).values([
    { name: 'Palomita', species: 'cat' },
    { name: 'Pan', species: 'dog' },
  ]);
}
```

La valeur retourn√©e par `asDrizzleTable('Pets', Pets)` est √©quivalente √† `import { Pets } from 'astro:db'`, mais elle est disponible m√™me si la g√©n√©ration de type d'Astro ne peut pas fonctionner.
Vous pouvez l'utiliser dans tout code d'int√©gration qui doit interroger ou ins√©rer dans la base de donn√©es.




### Migrer depuis Astro Studio vers Turso

<Steps>

1. Dans le [tableau de bord du Studio](https://studio.astro.build/), acc√©dez au projet que vous souhaitez migrer. Dans l'onglet Param√®tres, utilisez le bouton ¬´ Exporter la base de donn√©es ¬ª pour t√©l√©charger une copie de votre base de donn√©es.
2. Suivez les instructions officielles pour [installer le CLI de Turso](https://docs.turso.tech/cli/installation) et [inscrivez-vous ou connectez-vous](https://docs.turso.tech/cli/authentication) √† votre compte Turso.
3. Cr√©ez une nouvelle base de donn√©es sur Turso en utilisant la commande `turso db create`.
   ```sh
   turso db create [database-name]
   ```
4. R√©cup√©rez l'URL de la base de donn√©es √† l'aide de Turso CLI et utilisez-la comme variable d'environnement `ASTRO_DB_REMOTE_URL`.
   ```sh
   turso db show [database-name]
   ```
   ```dotenv
   ASTRO_DB_REMOTE_URL=[your-database-url]
   ```
5. Cr√©ez un jeton pour acc√©der √† votre base de donn√©es et utilisez-le comme variable d'environnement `ASTRO_DB_APP_TOKEN`.
   ```sh
   turso db tokens create [database-name]
   ```
   ```dotenv
   ASTRO_DB_APP_TOKEN=[your-app-token]
   ```
6. Transf√©rez votre sch√©ma de base de donn√©es et vos m√©tadonn√©es vers la nouvelle base de donn√©es Turso.
   ```sh
   astro db push --remote
   ```
7. Importez l'export de la base de donn√©es de l‚Äô√©tape 1 dans votre nouvelle base de donn√©es Turso.
   ```sh
   turso db shell [database-name] < ./path/to/dump.sql
   ```
8. Une fois que vous avez confirm√© que votre projet se connecte √† la nouvelle base de donn√©es, vous pouvez supprimer le projet en toute s√©curit√© dans Astro Studio.

</Steps>
