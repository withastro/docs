---
type: integration
title: '@astrojs/cloudflare'
description: Apprendre √† utiliser l'adaptateur @astrojs/cloudflare pour d√©ployer votre projet Astro.
sidebar:
  label: Cloudflare
githubIntegrationURL: 'https://github.com/withastro/astro/tree/main/packages/integrations/cloudflare/'
category: adapter
i18nReady: true
---

import PackageManagerTabs from '~/components/tabs/PackageManagerTabs.astro'
import ReadMore from '~/components/ReadMore.astro';
import Since from '~/components/Since.astro';
import { Tabs, TabItem, Steps } from '@astrojs/starlight/components';


Cet adaptateur permet √† Astro de d√©ployer vos [routes et fonctionnalit√©s rendues √† la demande](/fr/guides/on-demand-rendering/) sur [Cloudflare](https://www.cloudflare.com/), y compris [les √Ælots de serveur](/fr/guides/server-islands/), les [actions](/fr/guides/actions/) et les [sessions](/fr/guides/sessions/).

Si vous utilisez Astro comme g√©n√©rateur de site statique, vous n'avez pas besoin d'adaptateur.

D√©couvrez comment d√©ployer votre site Astro dans notre [guide de d√©ploiement Cloudflare](/fr/guides/deploy/cloudflare/).

## Pourquoi Astro Cloudflare

La [plateforme de d√©veloppement](https://developers.cloudflare.com/) de Cloudflare vous permet de d√©velopper des applications full-stack avec acc√®s √† des ressources telles que le stockage et l'IA, le tout d√©ploy√© sur un r√©seau mondial. Cet adaptateur compile votre projet Astro pour le d√©ploiement via Cloudflare.


## Installation

Astro inclut une commande `astro add` pour automatiser l'installation des int√©grations officielles. Si vous pr√©f√©rez, vous pouvez [installer les int√©grations manuellement](#installation-manuelle) √† la place.

Ajoutez l'adaptateur Cloudflare pour activer le rendu du serveur dans votre projet Astro avec la commande `astro add`. Cela installera `@astrojs/cloudflare` et apportera les changements appropri√©s √† votre fichier `astro.config.mjs` en une seule √©tape.

<PackageManagerTabs>
  <Fragment slot="npm">
    ```sh
    npx astro add cloudflare
    ```
  </Fragment>
  <Fragment slot="pnpm">
    ```sh
    pnpm astro add cloudflare
    ```
  </Fragment>
  <Fragment slot="yarn">
    ```sh
    yarn astro add cloudflare
    ```
  </Fragment>
</PackageManagerTabs>

D√©sormais, vous pouvez activer [le rendu √† la demande par page](/fr/guides/on-demand-rendering/#activation-du-rendu-√†-la-demande) ou d√©finir la configuration de sortie de votre compilation sur `output: 'server'` pour [restituer toutes vos pages par d√©faut sur le serveur](/fr/guides/on-demand-rendering/#mode-server).

### Installation manuelle

Tout d'abord, ajoutez l'adaptateur `@astrojs/cloudflare` aux d√©pendances de votre projet en utilisant votre gestionnaire de paquets pr√©f√©r√©.

<PackageManagerTabs>
  <Fragment slot="npm">
    ```sh
    npm install @astrojs/cloudflare
    ```
  </Fragment>
  <Fragment slot="pnpm">
    ```sh
    pnpm add @astrojs/cloudflare
    ```
  </Fragment>
  <Fragment slot="yarn">
    ```sh
    yarn add @astrojs/cloudflare
    ```
  </Fragment>
</PackageManagerTabs>

Ensuite, ajoutez l'adaptateur √† votre fichier `astro.config.mjs`¬†:

```js title="astro.config.mjs" ins={2,5}
import { defineConfig } from 'astro/config';
import cloudflare from '@astrojs/cloudflare';

export default defineConfig({
  adapter: cloudflare(),
});
```

## Options

L'adaptateur Cloudflare accepte les options suivantes¬†:

### `cloudflareModules`

<p>
**Type¬†:** `boolean`<br />
**Par d√©faut¬†:** `true`
</p>

Active [les importations des modules `.wasm`, `.bin` et `.txt`](#importations-de-modules-cloudflare).

Cette fonctionnalit√© est activ√©e par d√©faut. Si vous souhaitez la d√©sactiver, d√©finissez `cloudflareModules` sur `false`.

### `imageService`

<p>
**Type :** `'passthrough' | 'cloudflare' | 'compile' | 'custom'`<br />
**Par d√©faut :** `'compile'`
</p>

D√©termine quel service d'image est utilis√© par l'adaptateur. L'adaptateur utilisera par d√©faut le mode `compile` si un service d'image incompatible est configur√©. Sinon, il utilisera le service d'image configur√© globalement :

* **`cloudflare`¬†:** Utilise le service de [redimensionnement d'image de Cloudflare](https://developers.cloudflare.com/images/image-resizing/).
* **`passthrough`¬†:** Utilise le service existant [`noop`](/fr/guides/images/#configurer-le-service-no-op-passthrough).
* **`compile`¬†:** Utilise le service par d√©faut d'Astro (sharp), mais seulement sur les routes pr√©-rendues au moment de la compilation. Pour les pages rendues √† la demande, toutes les fonctionnalit√©s de `astro:assets` sont d√©sactiv√©es.
* **`custom`¬†:** Utilise toujours le service d'image configur√© dans les [options d'images](/fr/reference/configuration-reference/#options-dimages). **Cette option ne v√©rifiera pas si le service d'image configur√© fonctionne dans l'environnemment d'ex√©cution `workerd` de Cloudflare.**

```js title="astro.config.mjs" ins={6}
import { defineConfig } from "astro/config";
import cloudflare from '@astrojs/cloudflare';

export default defineConfig({
  adapter: cloudflare({
     imageService: 'cloudflare'
  }),
})
```

### `platformProxy`

D√©termine si et comment l'environnemment d'ex√©cution Cloudflare est ajout√© √† `astro dev`. Il contient des proxys vers les liaisons `workerd` locales et des √©mulations de valeurs sp√©cifiques √† Cloudflare, permettant l'√©mulation de l'environnemment d'ex√©cution dans le processus de d√©veloppement Node.js. En savoir plus sur l'[environnemment d'ex√©cution Cloudflare](#environnement-dex√©cution-cloudflare).

:::note
Les proxys fournis par ce syst√®me constituent une √©mulation au mieux de la production r√©elle. Bien qu'ils soient con√ßus pour √™tre aussi proches que possible de la r√©alit√©, il peut y avoir de l√©g√®res diff√©rences et incoh√©rences entre les deux.
:::

#### `platformProxy.enabled`
<p>
**Type :** `boolean`<br />
**Par d√©faut :** `true`
</p>

D√©termine s'il faut activer l'environnement d'ex√©cution Cloudflare en mode d√©veloppement.

#### `platformProxy.configPath`
<p>
**Type :** `string`<br />
**Par d√©faut :** `undefined`
</p>

D√©finit le chemin d'acc√®s au fichier de configuration Wrangler. Si aucune valeur n'est d√©finie, il recherche un fichier `wrangler.toml`, `wrangler.json` ou `wrangler.jsonc` √† la racine du projet.

#### `platformProxy.environment`
<p>
**Type :** `string`<br />
**Par d√©faut :** `undefined`
</p>

D√©finit l'[environnement Cloudflare](https://developers.cloudflare.com/workers/wrangler/environments/) √† utiliser. Vous devez s√©lectionner un environnement d√©fini dans le fichier de configuration Wrangler, sinon une erreur se produit.

#### `platformProxy.persist`
<p>
**Type :** `boolean | { path: string }`<br />
**Par d√©faut :** `true`
</p>

D√©finit si et o√π enregistrer les donn√©es de liaison localement sur le syst√®me de fichiers.

- Si d√©finie sur `true`, les donn√©es de liaison sont stock√©es dans `.wrangler/state/v3/`. Ce param√®tre est identique √† celui par d√©faut de Wrangler.
- Si d√©finie sur `false`, les donn√©es de liaison ne sont pas stock√©es dans le syst√®me de fichiers.
- Si d√©finie avec `{ path: string }`, les donn√©es de liaison sont stock√©es dans le chemin sp√©cifi√©.

:::note
L'option `--persist-to` de `wrangler` ajoute un sous-r√©pertoire appel√© `v3` sous le capot tandis que la propri√©t√© `persist` de `@astrojs/cloudflare` ne le fait pas. Par exemple, pour r√©utiliser le m√™me emplacement qu'en lan√ßant `wrangler dev --persist-to ./mon-dossier`, vous devez sp√©cifier : `persist: { path: "./mon-dossier/v3" }`.
:::

La configuration suivante montre un exemple d'activation de l'environnement d'ex√©cution Cloudflare lors de l'ex√©cution du serveur de d√©veloppement, ainsi que l'utilisation d'un fichier de configuration `wrangler.json`. Elle sp√©cifie √©galement un emplacement personnalis√© pour la persistance des donn√©es dans le syst√®me de fichiers :


```js
import cloudflare from '@astrojs/cloudflare';
import { defineConfig } from 'astro/config';

export default defineConfig({
	adapter: cloudflare({
		platformProxy: {
			enabled: true,
			configPath: 'wrangler.json',
			persist: {
				path: './.cache/wrangler/v3'
			},
		},
	}),
});
```
### `routes.extend`

Avec Cloudflare Workers, cette option n'est pas applicable. Consultez la section [routage sur Cloudflare Workers](#routage-sur-cloudflare-workers) pour plus d'informations.

Avec Cloudflare Pages, cette option vous permet d'ajouter ou d'exclure des motifs personnalis√©s (par exemple `/fonts/*`) au fichier g√©n√©r√© `_routes.json` qui d√©termine quelles routes sont g√©n√©r√©es √† la demande. Cela peut √™tre utile si vous avez besoin d'ajouter des mod√®les de route qui ne peuvent pas √™tre g√©n√©r√©s automatiquement, ou d'exclure des routes pr√©-rendues.

Plus d'informations sur les mod√®les de route personnalis√©s sont disponibles dans la [documentation sur le routage de Cloudflare](https://developers.cloudflare.com/pages/functions/routing/#functions-invocation-routes). Les routes sp√©cifi√©es ne sont pas automatiquement d√©dupliqu√©es et seront ajout√©es telles quelles aux routes existantes.

#### `routes.extend.include`

<p>
**Type :** `{ pattern: string }[]`<br />
**Par d√©faut :** `undefined`
</p>

Configure des routes suppl√©mentaires √† g√©n√©rer √† la demande par l'adaptateur Cloudflare dans le tableau `routes.extend.include`.

#### `routes.extend.exclude`

<p>
**Type :** `{ pattern: string }[]`<br />
**Par d√©faut :** `undefined`
</p>

Configure les routes √† exclure du rendu √† la demande dans le tableau `routes.extend.exclude`. Ces routes seront, √† la place, pr√©-rendues et servies de mani√®re statique, et n'invoqueront pas la fonction serveur. De plus, vous pouvez utiliser cette option pour servir n'importe quel fichier statique (images, polices, css, js, html, txt, json, etc.) directement sans acheminer la requ√™te via la fonction serveur.

```js title="astro.config.mjs"
export default defineConfig({
  adapter: cloudflare({
    routes: {
      extend: {
        include: [{ pattern: '/static' }], // Achemine une page pr√©-rendue vers la fonction serveur pour un rendu √† la demande
        exclude: [{ pattern: '/pagefind/*' }], // Utilise la recherche pagefind de Starlight, qui est g√©n√©r√©e statiquement au moment de la compilation.
      }
    },
  }),
});
```

### `sessionKVBindingName`
<p>
**Type¬†:** `string`<br />
**Par d√©faut¬†:** `SESSION`
<Since v="5.6.0" />
</p>

L'option `sessionKVBindingName` vous permet de sp√©cifier le nom de la liaison KV utilis√©e pour le stockage de session. Par d√©faut, celui-ci est d√©fini sur `SESSION`, mais vous pouvez le modifier pour qu'il corresponde √† votre propre nom de liaison KV. Consultez [Sessions](#sessions) pour plus d'informations.

```js title="astro.config.mjs" "MY_SESSION_BINDING"
export default defineConfig({
  adapter: cloudflare({
    sessionKVBindingName: 'MY_SESSION_BINDING',
  }),
});
```

### `workerEntryPoint`
<p>

**Type¬†:** `{ path: string | URL, namedExports: string[] }`<br />
**Par d√©faut¬†:** `{ path: '@astrojs/cloudflare/entrypoints/server.js', namedExports: [] }`<br />
<Since v="12.6.0" pkg="@astrojs/cloudflare"/>
</p>


Un objet de configuration pour sp√©cifier le [point d'entr√©e (`workerEntryPoint`)](https://developers.cloudflare.com/workers/runtime-apis/bindings/service-bindings/rpc/) pour votre Cloudflare Worker lorsque vous utilisez la commande `astro build`.

It allows you to optionally specify both a custom file `path` and `namedExports`:
Il vous permet de sp√©cifier √©ventuellement √† la fois le chemin d'un fichier personnalis√© (`path`) et le nom des exportations (`namedExports`)¬†:

```js title="astro.config.mjs"
import cloudflare from '@astrojs/cloudflare';
import { defineConfig } from 'astro/config';

export default defineConfig({
	adapter: cloudflare({
		workerEntryPoint: {
			path: 'src/worker.ts',
			namedExports: ['MyDurableObject']
		}
	}),
});
```

#### `workerEntryPoint.path`

<p>

**Type¬†:** `string`<br />
**Par d√©faut¬†:** `@astrojs/cloudflare/entrypoints/server.js`
<Since v="12.6.0" pkg="@astrojs/cloudflare" />
</p>

Le chemin vers le fichier d'entr√©e. Celui-ci devrait √™tre un chemin relatif √† partir de la racine de votre projet Astro.

Par d√©faut, l'adaptateur utilise un fichier d'entr√©e g√©n√©rique, qui ne prend en charge que le gestionnaire `fetch`.

Pour prendre en charge d'autres gestionnaires d'invocation Cloudflare (https://developers.cloudflare.com/workers/observability/logs/workers-logs/#invocation-logs), vous pouvez cr√©er un fichier personnalis√© comme point d'entr√©e. Ceci est utile pour utiliser des fonctionnalit√©s n√©cessitant d'autres gestionnaires (par exemple, les objets durables, les files d'attente Cloudflare ou les invocations planifi√©es).

#### `workerEntryPoint.namedExports` 

<p>

**Type¬†:** `[]`<br />
**Par d√©faut¬†:** `[]`
<Since v="12.6.0" pkg="@astrojs/cloudflare" />
</p>

Un tableau d‚Äôexportations nomm√©es √† utiliser pour le fichier d‚Äôentr√©e.

Fournissez tous les noms des exportations suppl√©mentaires d√©finies dans votre [fichier d'entr√©e personnalis√©](#cr√©ation-dun-fichier-dentr√©e-cloudflare-worker-personnalis√©) (par exemple `DurableObject`). Si elles ne sont pas fournies, seules les exportations par d√©faut seront incluses.

#### Cr√©ation d'un fichier d'entr√©e Cloudflare Worker personnalis√©

Le fichier d'entr√©e personnalis√© doit exporter la fonction `createExports()` avec une exportation par d√©faut (`default`) incluant tous les gestionnaires dont vous avez besoin.

L'exemple de fichier d'entr√©e suivant enregistre un objet durable et un gestionnaire de file d'attente¬†:

```ts title="src/worker.ts"
import type { SSRManifest } from 'astro';
import { App } from 'astro/app';
import { handle } from '@astrojs/cloudflare/handler'
import { DurableObject } from 'cloudflare:workers';

class MyDurableObject extends DurableObject<Env> {
  constructor(ctx: DurableObjectState, env: Env) {
    super(ctx, env)
  }
}

export function createExports(manifest: SSRManifest) {
	const app = new App(manifest);
	return {
		default: {
			async fetch(request, env, ctx) {
				await env.MY_QUEUE.send("log");
				return handle(manifest, app, request, env, ctx);
			},
			async queue(batch, _env) {
				let messages = JSON.stringify(batch.messages);
				console.log(`consomm√© depuis notre file d'attente : ${messages}`);
			}
		} satisfies ExportedHandler<Env>,
		MyDurableObject: MyDurableObject,
	}
}
```

## Environnement d'ex√©cution Cloudflare

### Utilisation

L'environnement d'ex√©cution Cloudflare vous donne acc√®s aux variables d'environnement et aux liaisons aux ressources Cloudflare.
L'environnement d'ex√©cution Cloudflare utilise les liaisons trouv√©es dans le fichier de configuration `wrangler.toml`/`wrangler.json`.

Vous pouvez acc√©der aux liaisons depuis `Astro.locals.runtime`¬†:

```astro title="src/pages/index.astro"
---
const { env } = Astro.locals.runtime;
---
```
Vous pouvez acc√©der √† l'environnement d'ex√©cution √† partir des points de terminaison de l'API via `context.locals`¬†:

```js title="src/pages/api/someFile.js"
export function GET(context) {
  const runtime = context.locals.runtime;

  return new Response('Un corps de r√©ponse');
}
```

Voir la [liste de toutes les liaisons prises en charge](https://developers.cloudflare.com/workers/wrangler/api/#supported-bindings) dans la documentation de Cloudflare.


### Variables d'environnement et secrets

L'environnement d'ex√©cution Cloudflare traite les variables d'environnement comme un type de liaison.

Par exemple, vous pouvez d√©finir une [variable d‚Äôenvironnement](https://developers.cloudflare.com/workers/configuration/environment-variables/#add-environment-variables-via-wrangler) dans `wrangler.json` comme suit¬†:

```json title="wrangler.json"
{
  "vars" : {
    "MY_VARIABLE": "test"
  }
}
```

Les secrets sont un type particulier de variable d'environnement qui vous permet d'attacher des valeurs textuelles chiffr√©es √† votre Worker. Ils doivent √™tre d√©finis diff√©remment pour garantir qu'ils ne soient pas visibles apr√®s leur d√©finition.

Pour d√©finir des `secrets`, ajoutez-les via la [CLI de Wrangler](https://developers.cloudflare.com/workers/wrangler/) plut√¥t que dans votre fichier de configuration Wrangler.

```bash
npx wrangler secret put <KEY>
```

Pour d√©finir des secrets pour le d√©veloppement local, vous devez √©galement ajouter un fichier `.dev.vars` √† la racine du projet Astro¬†:

```ini title=".dev.vars"
DB_PASSWORD=monMotDePasse
```

Vous pouvez ensuite acc√©der aux variables d'environnement, y compris les secrets, √† partir de l'objet `env` disponible depuis `Astro.locals.runtime`¬†:

```astro title="src/pages/index.astro"
---
const { env } = Astro.locals.runtime;
const myVariable = env.MY_VARIABLE;
const secret = env.DB_PASSWORD;
---
```

Les variables d'environnement et les secrets Cloudflare sont compatibles avec [l'API `astro:env`](/fr/guides/environment-variables/#variables-denvironnement-avec-s√ªret√©-du-typage).

### D√©finition de types

`wrangler` fournit une commande `types` pour g√©n√©rer des types TypeScript pour les liaisons. Cela vous permet de d√©finir des types pour `locals` sans avoir √† les saisir manuellement. R√©f√©rez-vous √† la [documentation de Cloudflare](https://developers.cloudflare.com/workers/wrangler/commands/#types) pour plus d'informations.

Chaque fois que vous modifiez vos fichiers de configuration (par exemple `wrangler.toml`, `.dev.vars`), vous devez lancer `wrangler types`.

:::note
Vous pouvez cr√©er un script pnpm pour lancer `wrangler types` automatiquement avant d'autres commandes.

```json title="package.json"
{
  "scripts": {
    "dev": "wrangler types && astro dev",
    "start": "wrangler types && astro dev",
    "build": "wrangler types && astro check && astro build",
    "preview": "wrangler types && astro preview",
    "astro": "astro"
  }
}
```
:::

Vous pouvez d√©finir un type pour l'objet `runtime` en utilisant `Runtime` :

```ts title="src/env.d.ts"
type Runtime = import('@astrojs/cloudflare').Runtime<Env>;

declare namespace App {
  interface Locals extends Runtime {
    otherLocals: {
      test: string;
    };
  }
}
```

## Plate-forme Cloudflare

### En-t√™tes

Vous pouvez attacher des [en-t√™tes personnalis√©s](https://developers.cloudflare.com/pages/platform/headers/) √† vos r√©ponses en ajoutant un fichier `_headers` dans le dossier `public/` de votre projet Astro. Ce fichier sera copi√© dans le r√©pertoire de sortie de la compilation.

Cette fonctionnalit√© est disponible sur Cloudflare Workers et Pages.

### Ressources
Les ressources cr√©√©es par Astro sont toutes nomm√©es avec un hachage et peuvent donc se voir attribuer de longs en-t√™tes de cache. Par d√©faut, Astro sur Cloudflare ajoutera un tel en-t√™te pour ces fichiers.

### Redirections

Vous pouvez d√©clarer des [redirections personnalis√©es](https://developers.cloudflare.com/pages/platform/redirects/) pour rediriger les requ√™tes vers une URL diff√©rente. Pour ce faire, ajoutez un fichier `_redirects` dans le dossier `public/` de votre projet Astro. Ce fichier sera copi√© dans votre r√©pertoire de sortie de compilation.

Cette fonctionnalit√© est disponible sur Cloudflare Workers et Pages.

### Routes
#### Routage sur Cloudflare Workers

Le routage des ressources statiques est bas√© sur la structure des fichiers dans le r√©pertoire de compilation (par exemple, `./dist`). Si aucune correspondance n'est trouv√©e, le Worker sera utilis√© pour le rendu √† la demande. En savoir plus sur [le routage des ressources statiques avec Cloudflare Workers](https://developers.cloudflare.com/workers/static-assets/routing/).

Contrairement √† [Cloudflare Pages](#routage-sur-cloudflare-pages), avec Workers, vous n'avez pas besoin d'un fichier `_routes.json`.

Actuellement, l'adaptateur Cloudflare g√©n√®re syst√©matiquement ce fichier. Pour contourner ce probl√®me, cr√©ez un fichier `.assetsignore` dans votre dossier `public/` et ajoutez-y les lignes suivantes¬†:
  ```txt title="public/.assetsignore"
  _worker.js
  _routes.json
  ```

#### Routage sur Cloudflare Pages

Pour Cloudflare Pages, [le routage](https://developers.cloudflare.com/pages/platform/functions/routing/#functions-invocation-routes) utilise un fichier `_routes.json` pour d√©terminer les requ√™tes achemin√©es vers la fonction serveur et celles servies comme ressources statiques. Par d√©faut, un fichier `_routes.json` sera automatiquement g√©n√©r√© pour votre projet en fonction de ses fichiers et de sa configuration.

Vous pouvez [sp√©cifier des mod√®les de routage suppl√©mentaires √† suivre](#routesextend) dans la configuration de votre adaptateur ou cr√©er votre propre fichier `_routes.json` personnalis√© pour remplacer compl√®tement la g√©n√©ration automatique.


La cr√©ation d'un fichier `public/_routes.json` personnalis√© annulera la g√©n√©ration automatique. Consultez [la documentation de Cloudflare sur la cr√©ation d'un fichier `_routes.json` personnalis√©](https://developers.cloudflare.com/pages/platform/functions/routing/#create-a-_routesjson-file) pour plus de d√©tails.

## Sessions

L'[API Sessions](/fr/guides/sessions/) d'Astro vous permet de stocker facilement les donn√©es utilisateur entre chaque requ√™te. Ceci peut √™tre utilis√© pour des √©l√©ments tels que les donn√©es et pr√©f√©rences utilisateur, les paniers d'achat et les identifiants d'authentification. Contrairement au stockage des cookies, la taille des donn√©es est illimit√©e et elles peuvent √™tre restaur√©es sur diff√©rents appareils. 

Astro configure automatiquement [Workers KV](https://developers.cloudflare.com/kv/) pour le stockage de session lors de l'utilisation de l'adaptateur Cloudflare. Avant d'utiliser des sessions, vous devez cr√©er un espace de noms KV pour stocker les donn√©es et configurer une liaison KV dans votre fichier de configuration Wrangler. Par d√©faut, Astro s'attend √† ce que la liaison KV s'appelle `SESSION`, mais vous pouvez choisir un autre nom si vous le souhaitez en d√©finissant l'option [`sessionKVBindingName`](#sessionkvbindingname) dans la configuration de l'adaptateur.

<Steps>

1. Cr√©ez un espace de noms KV √† l'aide de la CLI de Wrangler et notez l'ID du nouvel espace de noms¬†:

   ```sh
   npx wrangler kv namespace create "SESSION"
   ```

2. D√©clarez l'espace de noms KV dans votre configuration Wrangler, en d√©finissant l'ID de l'espace de noms sur celui renvoy√© par la commande pr√©c√©dente¬†:

    <Tabs>
      <TabItem label="wrangler.json">
        ```json title="wrangler.json" "<KV_NAMESPACE_ID>"
        {
          "kv_namespaces": [
            {
              "binding": "SESSION",
              "id": "<KV_NAMESPACE_ID>"
            }
          ]
        }
        ```
      </TabItem>
      <TabItem label="wrangler.toml">
        ```toml title="wrangler.toml" "<KV_NAMESPACE_ID>"
        kv_namespaces = [
          { binding = "SESSION", id = "<KV_NAMESPACE_ID>" }
        ]
        ```
      </TabItem>
    </Tabs>

3. Vous pouvez ensuite utiliser des sessions dans votre code serveur¬†:

    ```astro title="src/components/CartButton.astro" "Astro.session?.get('cart')"
    ---
    export const prerender = false;
    const cart = await Astro.session?.get('cart');
    ---

    <a href="/checkout">üõí {cart?.length ?? 0} articles</a>
    ```

</Steps>

:::note
Les √©critures dans Cloudflare KV sont [√©ventuellement coh√©rentes](https://developers.cloudflare.com/kv/concepts/how-kv-works/#consistency) entre les r√©gions. Cela signifie que les modifications sont imm√©diatement disponibles au sein d'une m√™me r√©gion, mais leur propagation mondiale peut prendre jusqu'√† 60 secondes. Cela n'affectera pas la plupart des utilisateurs, car ils sont peu susceptibles de changer de r√©gion entre les requ√™tes. Cependant, cela peut √™tre un facteur √† prendre en compte dans certains cas d'utilisation, comme les utilisateurs VPN.
:::


## Importations de modules Cloudflare

L'environnement d'ex√©cution `workerd` de Cloudflare prend en charge les importations de certains [types de modules non standard](https://developers.cloudflare.com/workers/wrangler/bundling/#including-non-javascript-modules). La plupart des types de fichiers suppl√©mentaires sont √©galement disponibles dans Astro¬†:

- `.wasm` ou `.wasm?module` : exporte un [`WebAssembly.Module`](https://developer.mozilla.org/en-US/docs/WebAssembly/JavaScript_interface/Module) qui peut ensuite √™tre instanci√©.
- `.bin` : exporte un [`ArrayBuffer`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer) du contenu binaire brut du fichier
- `.txt` : exporte une cha√Æne de caract√®res du contenu du fichier

Tous les types de modules exportent une seule valeur par d√©faut. Les modules peuvent √™tre import√©s √† partir de pages rendues c√¥t√© serveur ou de pages pr√©-rendues pour la g√©n√©ration de sites statiques.

Voici un exemple d'importation d'un module Wasm qui r√©pond aux requ√™tes en additionnant les param√®tres num√©riques de la requ√™te.

```js title="pages/add/[a]/[b].js"
// Importer le module WebAssembly
import mod from '../util/add.wasm';

// Instancier d'abord pour l'utiliser
const addModule: any = new WebAssembly.Instance(mod);

export async function GET(context) {
  const a = Number.parseInt(context.params.a);
  const b = Number.parseInt(context.params.b);
  return new Response(`${addModule.exports.add(a, b)}`);
}
```

Bien que cet exemple soit trivial, Wasm peut √™tre utilis√© pour acc√©l√©rer des op√©rations de calcul intensif qui n'impliquent pas d'E/S importantes, comme l'int√©gration d'une biblioth√®que de traitement d'images, ou l'int√©gration d'une petite base de donn√©es pr√©-index√©e pour la recherche sur un ensemble de donn√©es en lecture seule.

## Compatibilit√© Node.js

Cloudflare ne prend pas en charge les API de l'environnement d'ex√©cution Node.js. Avec un peu de configuration, Cloudflare peut prendre en charge un sous-ensemble de ces API. Vous pouvez trouver les API de l'environnement d'ex√©cution Node.js prises en charge dans la [documentation de Cloudflare](https://developers.cloudflare.com/workers/runtime-apis/nodejs).

Pour utiliser ces API, votre page ou point de terminaison doit √™tre rendu c√¥t√© serveur (et non pr√©-rendu) et doit utiliser la syntaxe d'importation `import {} from 'node:*'`.

```js title="pages/api/endpoint.js"
export const prerender = false;
import { Buffer } from 'node:buffer';
```

Vous devrez √©galement modifier la configuration `vite` dans votre configuration Astro pour autoriser la syntaxe d'importation `node:*` :

```js title="astro.config.mjs" ins={6-10}
import {defineConfig} from "astro/config";
import cloudflare from '@astrojs/cloudflare';

export default defineConfig({
  adapter: cloudflare({}),
  vite: {
		ssr: {
			external: ['node:buffer'],
		},
	},
})
```

En plus de cela, vous devrez suivre la documentation de Cloudflare sur la fa√ßon d'activer la prise en charge. Pour des conseils d√©taill√©s, veuillez vous r√©f√©rer √† la [documentation Cloudflare sur l'activation de la compatibilit√© Node.js](https://developers.cloudflare.com/workers/runtime-apis/nodejs/).

:::note[Implications de la compatibilit√© des paquets]
Si un projet importe un paquet sur le serveur qui utilise les API de l'environnement d'ex√©cution Node.js, cela peut entra√Æner des probl√®mes lors du d√©ploiement sur Cloudflare. Ce probl√®me survient avec les paquets qui n'utilisent pas la syntaxe d'importation `node:*`. Il est recommand√© de contacter les auteurs du paquet pour d√©terminer s'il prend en charge la syntaxe d'importation ci-dessus. Si ce n'est pas le cas, vous devrez peut-√™tre utiliser un autre paquet.
:::

## Aper√ßu avec Wrangler

Pour utiliser [`wrangler`](https://developers.cloudflare.com/workers/wrangler/) afin d'ex√©cuter votre application localement, mettez √† jour le script de pr√©visualisation :

Pour Workers¬†:

```json title="package.json"
"preview": "wrangler dev ./dist"
```

Pour Pages¬†:

```json title="package.json"
"preview": "wrangler pages dev ./dist"
```

D√©velopper avec [`wrangler`](https://developers.cloudflare.com/workers/wrangler/) vous donne acc√®s aux [liaisons Cloudflare](https://developers.cloudflare.com/pages/platform/functions/bindings), aux [variables d'environnement](https://developers.cloudflare.com/pages/platform/functions/bindings/#environment-variables), et √† [l'objet cf](https://developers.cloudflare.com/workers/runtime-apis/request/#incomingrequestcfproperties). Faire fonctionner le rechargement √† chaud (Hot Reloading) du serveur de d√©veloppement d'Astro avec Wrangler peut n√©cessiter une configuration personnalis√©e. Voir les [exemples de la communaut√©](https://github.com/withastro/roadmap/discussions/590).

### Messages d'erreur significatifs

Actuellement, les erreurs lors de l'ex√©cution de votre application dans Wrangler ne sont pas tr√®s utiles, en raison de la minification de votre code. Pour un meilleur d√©bogage, vous pouvez ajouter le param√®tre `vite.build.minify = false` √† votre fichier `astro.config.mjs`.

```js title="astro.config.mjs" ins={3-7}
export default defineConfig({
  adapter: cloudflare(),
  output: 'server',
  vite: {
    build: {
      minify: false,
    },
  },
});
```

[astro-integration]: /fr/guides/integrations-guide/
