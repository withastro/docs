---
title: 'Astro DB'
description: Scopri come utilizzare Astro DB, un database SQL completamente gestito progettato esclusivamente per Astro.
githubIntegrationURL: 'https://github.com/withastro/astro/tree/main/packages/db/'
i18nReady: true
---
import { FileTree } from '@astrojs/starlight/components';
import PackageManagerTabs from '~/components/tabs/PackageManagerTabs.astro';
import ReadMore from '~/components/ReadMore.astro';
import StudioHeading from '~/components/StudioHeading.astro';

Astro DB è un database SQL completamente gestito progettato esclusivamente per Astro. Sviluppa localmente o connettiti a un database ospitato gestito sulla nostra piattaforma [Astro Studio](/it/recipes/studio/).

## Installazione

Aggiungi Astro DB a un nuovo o esistente progetto Astro (richiede `astro@4.5` o successivo) con l'integrazione [`@astrojs/db`](/it/guides/integrations-guide/db/) (`v0.8.0` o successivo). Astro include un comando integrato `astro add` per automatizzare questo processo di configurazione per te.

<PackageManagerTabs>
  <Fragment slot="npm">
  ```sh
  npx astro add db
  ```
  </Fragment>
  <Fragment slot="pnpm">
  ```sh
  pnpm astro add db
  ```
  </Fragment>
  <Fragment slot="yarn">
  ```sh
  yarn astro add db
  ```
  </Fragment>
</PackageManagerTabs>

Se preferisci, puoi [installare `@astrojs/db` manualmente](/it/guides/integrations-guide/db/#installazione-manuale) invece.

## Definisci il tuo database

Astro DB è una soluzione completa per configurare, sviluppare e interrogare i tuoi dati. Un database locale viene creato ogni volta che esegui `astro dev`, utilizzando LibSQL per gestire i tuoi dati senza la necessità di Docker o di una connessione di rete.

Installare `@astrojs/db` con il comando `astro add` creerà un file `db/config.ts` nel tuo progetto dove definirai le tabelle del tuo database:

```ts title="db/config.ts"
import { defineDb } from 'astro:db';

export default defineDb({
  tables: { },
})
```

### Tabelle

I dati in Astro DB sono memorizzati utilizzando tabelle SQL. Le tabelle strutturano i tuoi dati in righe e colonne, dove le colonne impongono il tipo di ogni valore di riga.

Quando definisci una tabella, Astro genererà un'interfaccia TypeScript per interrogare quella tabella dal tuo progetto. Il risultato è un supporto completo di TypeScript quando accedi ai tuoi dati con il completamento automatico delle proprietà e type-checking.

Per configurare una tabella del database, importa e utilizza le utility `defineTable()` e `column` da `astro:db`.

Questo esempio configura una tabella `Comment` con colonne di testo obbligatorie per `author` e `body`. Quindi, rendila disponibile al tuo progetto attraverso l'esportazione `defineDb()`.

```ts title="db/config.ts" "Comment"
import { defineDb, defineTable, column } from 'astro:db';

const Comment = defineTable({
  columns: {
    author: column.text(),
    body: column.text(),
  }
})

export default defineDb({
  tables: { Comment },
})
```

<ReadMore>Vedi il [riferimento alla configurazione delle tabelle](/it/guides/integrations-guide/db/#riferimento-alla-configurazione-delle-tabelle) per un riferimento completo delle opzioni delle tabelle.</ReadMore>

### Colonne

Astro DB supporta i seguenti tipi di colonne:

```ts title="db/config.ts" "column.text()" "column.number()" "column.boolean()" "column.date()" "column.json()"
import { defineTable, column } from 'astro:db';

const Comment = defineTable({
  columns: {
    // Una stringa di testo.
    author: column.text(),
    // Un valore intero.
    likes: column.number(),
    // Un valore vero o falso.
    flagged: column.boolean(),
    // Valori di data/ora interrogati come oggetti Date JavaScript.
    published: column.date(),
    // Un oggetto JSON non tipizzato.
    metadata: column.json(),
  }
});
```

<ReadMore>Consulta il [riferimento delle colonne delle tabelle](/it/guides/integrations-guide/db/#riferimento-alla-configurazione-delle-tabelle) per ulteriori dettagli.</ReadMore>

### Riferimenti alle Tabelle

Le relazioni tra tabelle sono un modello comune nella progettazione dei database. Ad esempio, una tabella `Blog` può essere strettamente correlata ad altre tabelle di `Comment`, `Author` e `Category`.

Puoi definire queste tabelle di relazioni e salvarle nel tuo schema di database utilizzando **colonne di riferimento**. Per stabilire una relazione, avrai bisogno di:

- Una **colonna identificativa** sulla tabella di riferimento. Solitamente si tratta di una colonna `id` con la proprietà `primaryKey`.
- Una colonna sulla tabella base per **memorizzare l'`id` di riferimento**. Questo utilizza la proprietà `references` per stabilire una relazione.

Questo esempio mostra la colonna `authorId` di una tabella `Comment` che fa riferimento alla colonna `id` di una tabella `Author`.

```ts title="db/config.ts" {3, 10}
const Author = defineTable({
  columns: {
    id: column.number({ primaryKey: true }),
    name: column.text(),
  }
});

const Comment = defineTable({
  columns: {
    authorId: column.number({ references: () => Author.columns.id }),
    content: column.text(),
  }
});
```

## Popola il tuo database

In fase di sviluppo, Astro utilizzerà la tua configurazione DB per generare tipi locali in base ai tuoi schemi. Questi verranno generati nuovamente ogni volta che il server di sviluppo viene avviato e ti permetteranno di interrogare e lavorare con la forma dei tuoi dati con sicurezza dei tipi e autocompletamento.

Per popolare dati di sviluppo per test e debug nel tuo progetto Astro, crea un file `db/seed.ts`. Importa sia l'oggetto `db` che qualsiasi tabella configurata da `astro:db`. Usa la funzione `db.insert()` per fornire un array di oggetti di dati di righe di tabella.

L'esempio seguente definisce due righe di dati di sviluppo per una tabella `Comment`:

```ts title="db/seed.ts"
import { db, Comment } from 'astro:db';

export default async function() {
  await db.insert(Comment).values([
    { authorId: 1, body: 'Spero ti piaccia Astro DB!' },
    { authorId: 2, body: 'Divertiti!'},
  ])
}
```

Il tuo server di sviluppo riavvierà automaticamente il tuo database ogni volta che questo file cambia, rigenerando i tuoi tipi e popolando i tuoi dati di sviluppo da `seed.ts`.

## Interroga il tuo database

Puoi interrogare il tuo database da qualsiasi [pagina Astro](/it/basics/astro-pages/#pagine-astro) o [endpoint](/it/guides/endpoints/) nel tuo progetto utilizzando l'ORM `db` fornito e il costruttore di query.

### Drizzle ORM

```
import { db } from 'astro:db';
```

Astro DB include un client [Drizzle ORM](https://orm.drizzle.team/) integrato. Non è necessaria alcuna configurazione o impostazione manuale per utilizzare il client. Il client `db` di Astro DB è automaticamente configurato per comunicare con il tuo database (locale o remoto) quando esegui Astro. Utilizza la tua esatta definizione dello schema del database per query SQL type-safe con errori TypeScript quando fai riferimento a una colonna o tabella che non esiste.


### Select 

L'esempio seguente seleziona tutte le righe di una tabella `Comment`. Questo restituisce l'intero array di dati di sviluppo popolati da `db/seed.ts` che è quindi disponibile per l'uso nel tuo template di pagina:

```astro title="src/pages/index.astro"
---
import { db, Comment } from 'astro:db';

const comments = await db.select().from(Comment);
---

<h2>Commenti</h2>

{
  comments.map(({ author, body }) => (
    <article>
      <p>Autore: {author}</p>
      <p>{body}</p>
    </article>
  ))
}
```

<ReadMore>Vedi il [riferimento all'API `select()` di Drizzle](https://orm.drizzle.team/docs/select) per una panoramica completa.</ReadMore>

### Insert

Per accettare input dell'utente, come gestire richieste di form e inserire dati nel tuo database ospitato remoto, configura il tuo progetto Astro per [la rendering on-demand](/it/basics/rendering-modes/#pagine-renderizzate-on-demand) e [aggiungi un adattatore SSR](/it/guides/server-side-rendering/#official-adapters) per il tuo ambiente di distribuzione.

Questo esempio inserisce una riga in una tabella `Comment` in base a una richiesta POST di un form analizzata:

```astro
---
// src/pages/index.astro
import { db, Comment } from 'astro:db';

if (Astro.request.method === 'POST') {
  // analizza i dati del form
  const formData = await Astro.request.formData();
  const author = formData.get('author');
  const content = formData.get('content');
  if (typeof author === 'string' && typeof content === 'string') {
    // inserisci i dati del form nella tabella Comment
    await db.insert(Comment).values({ author, content });
  }
}

// renderizza la nuova lista di commenti ad ogni richiesta
const comments = await db.select().from(Comment);
---

<form method="POST" style="display: grid">
	<label for="author">Autore</label>
	<input id="author" name="author" />

	<label for="content">Contenuto</label>
	<textarea id="content" name="content"></textarea>

	<button type="submit">Invia</button>
</form>

<!--renderizza `comments`-->
```

Puoi anche interrogare il tuo database da un endpoint API. Questo esempio elimina una riga da una tabella `Comment` tramite il parametro `id`:

```ts
// src/pages/api/comments/[id].ts
import type { APIRoute } from "astro";
import { db, Comment, eq } from 'astro:db';

export const DELETE: APIRoute = async (ctx) => {
  await db.delete(Comment).where(eq(Comment.id, ctx.params.id ));
  return new Response(null, { status: 204 });
}
```

<ReadMore>

Vedi il [riferimento all'API `insert()` di Drizzle](https://orm.drizzle.team/docs/insert) per una panoramica completa.

</ReadMore>

### Filtraggio

Per interrogare i risultati delle tabelle per una proprietà specifica, usa [le opzioni Drizzle per selezioni parziali](https://orm.drizzle.team/docs/select#selezione-parziale). Ad esempio, aggiungi [una chiamata `.where()`](https://orm.drizzle.team/docs/select#filtraggio) alla tua query `select()` e passa il confronto che vuoi fare.

L'esempio seguente interroga tutte le righe in una tabella `Comment` che contengono la frase "Astro DB". Usa [l'operatore `like()`](https://orm.drizzle.team/docs/operators#like) per verificare se una frase è presente all'interno del `body`:


```astro title="src/pages/index.astro"
---
import { db, Comment, like } from 'astro:db';

const comments = await db.select().from(Comment).where(
    like(Comment.body, '%Astro DB%')
);
---
```

### Utilità Drizzle

Tutte le utilità Drizzle per costruire query sono esposte dal modulo `astro:db`. Questo include:

- [Operatori di filtro](https://orm.drizzle.team/docs/operators) come `eq()` e `gt()`
- [Helper di aggregazione](https://orm.drizzle.team/docs/select#aggregations-helpers) come `count()`
- [L'helper `sql`](https://orm.drizzle.team/docs/sql) per scrivere query SQL grezze

```ts
import { eq, gt, count, sql } from 'astro:db';
```

### Relazioni

Puoi interrogare dati correlati da più tabelle utilizzando un join SQL. Per creare una query di join, estendi la tua dichiarazione `db.select()` con un operatore di join. Ogni funzione accetta una tabella con cui unirsi e una condizione per abbinare le righe tra le due tabelle.

Questo esempio utilizza una funzione `innerJoin()` per unire gli autori dei `Comment` con le loro informazioni `Author` correlate in base alla colonna `authorId`. Questo restituisce un array di oggetti con ogni riga `Author` e `Comment` come proprietà di primo livello:

```astro title="src/pages/index.astro"
---
import { db, eq, Comment, Author } from 'astro:db';

const comments = await db.select()
  .from(Comment)
  .innerJoin(Author, eq(Comment.authorId, Author.id));
---

<h2>Commenti</h2>

{
  comments.map(({ Author, Comment }) => (
    <article>
      <p>Autore: {Author.name}</p>
      <p>{Comment.body}</p>
    </article>
  ))
}
```

<ReadMore>

Vedi il [riferimento join di Drizzle](https://orm.drizzle.team/docs/joins#join-types) per tutti gli operatori di join disponibili e le opzioni di configurazione.

</ReadMore>

### Transazioni Batch

Tutte le query al database remoto vengono effettuate come una richiesta di rete. Potresti aver bisogno di "raggruppare" le query insieme in una singola transazione quando effettui un gran numero di query, o per avere rollback automatici se una query fallisce.

Questo esempio inserisce più righe in una singola richiesta utilizzando il metodo `db.batch()`:

```ts
// db/seed.ts
import { db, Author, Comment } from 'astro:db';

export default async function () {
  const queries = [];
  // Inserisci 100 commenti di esempio nel tuo database remoto
  // con una singola richiesta di rete.
  for (let i = 0; i < 100; i++) {
    queries.push(db.insert(Comment).values({ body: `Test comment ${i}` }));
  }
  await db.batch(queries);
}
```

<ReadMore>

Vedi i [documenti `db.batch()` di Drizzle](https://orm.drizzle.team/docs/batch-api) per maggiori dettagli.

</ReadMore>

<StudioHeading>
## Astro Studio
</StudioHeading>

Astro DB può [connettersi alla piattaforma Astro Studio](/it/recipes/studio/) per aggiungere rapidamente un database ospitato al tuo progetto. Puoi visualizzare, gestire e distribuire nuovi database ospitati direttamente dalla dashboard di Astro Studio.

Per creare un nuovo progetto, puoi utilizzare un [template già pronto](https://studio.astro.build) o visitare la [guida di Astro Studio](/it/recipes/studio/#crea-un-nuovo-progetto-studio).

<StudioHeading>
### Pubblicazione degli schemi delle tabelle
</StudioHeading>


Il tuo schema delle tabelle cambierà nel tempo man mano che il tuo progetto cresce. Puoi testare in sicurezza le modifiche alla configurazione localmente e spingerle al tuo database Studio quando effettui il deploy.

Quando [crei un progetto Studio dalla dashboard](#astro-studio), avrai l'opzione di creare un'azione CI di GitHub. Questo migrerà automaticamente le modifiche allo schema quando si fonde con il ramo principale del tuo repository.

Puoi anche spingere le modifiche allo schema tramite la CLI usando il comando `astro db push`:

<PackageManagerTabs>
  <Fragment slot="npm">
  ```sh
  npm run astro db push
  ```
  </Fragment>
  <Fragment slot="pnpm">
  ```sh
  pnpm astro db push
  ```
  </Fragment>
  <Fragment slot="yarn">
  ```sh
  yarn astro db push
  ```
  </Fragment>
</PackageManagerTabs>

Questo comando verificherà che le modifiche possano essere effettuate senza perdita di dati e guiderà sulle modifiche allo schema consigliate per risolvere i conflitti. Se una modifica allo schema di rottura _deve_ essere effettuata, aggiungi il flag `--force-reset` per resettare tutti i dati di produzione.

<StudioHeading>
### Pubblicazione dei dati
</StudioHeading>

Potresti aver bisogno di spingere dati al tuo database Studio per seeding o migrazioni di dati. Puoi scrivere un file `.ts` con il modulo `astro:db` per scrivere query type-safe. Poi, esegui il file contro il tuo database Studio usando il comando `astro db execute <file-path> --remote`:

I seguenti Commenti possono essere inseriti utilizzando il comando `astro db execute db/seed.ts --remote`:

```ts
// db/seed.ts
import { Comment } from 'astro:db';

export default async function () {
  await db.insert(Comment).values([
    { authorId: 1, body: 'Spero ti piaccia Astro DB!' },
    { authorId: 2, body: 'Divertiti!' },
  ])
}
```

<ReadMore>

Vedi il [riferimento CLI](/it/guides/integrations-guide/db/#riferimento-per-la-cli-di-Astro-db) per un elenco completo dei comandi.

</ReadMore>

<StudioHeading>
### Collegamento ad Astro Studio
</StudioHeading>

Per impostazione predefinita, Astro utilizzerà un file di database locale ogni volta che esegui i comandi `dev` o `build`. Le tabelle vengono ricreate da zero ogni volta che viene eseguito un comando e i dati di seed di sviluppo verranno inseriti.

Per collegarti al tuo database ospitato Studio, puoi aggiungere il flag `--remote`. Usa questo flag per i deploy di produzione per avere accesso sia in lettura che in scrittura al tuo database Studio. Questo ti permetterà di [accettare e persistere i dati degli utenti](#insert).

```bash
# Costruisci con una connessione remota
astro build --remote

# Sviluppa con una connessione remota
astro dev --remote
```

:::caution

Fai attenzione usando `--remote` in sviluppo. Questo collegherà a un database di produzione live, e tutti gli inserimenti, aggiornamenti o cancellazioni verranno persistiti.

:::

Per utilizzare una connessione remota, avrai bisogno di un token dell'app per autenticarti con Studio. Visita la dashboard di Studio per le istruzioni sulla creazione e configurazione del token.

<ReadMore>

Quando sei pronto per il deploy, consulta la nostra [guida al Deploy con una Connessione Studio](/it/recipes/studio/#distribuire-con-una-connessione-studio).

</ReadMore>

## Costruzione di integrazioni Astro DB

[Le integrazioni Astro](/it/reference/integrations-reference/) possono estendere i progetti degli utenti con tabelle Astro DB aggiuntive e dati di seed.

Usa il metodo `extendDb()` nell'hook `astro:db:setup` per registrare ulteriori configurazioni Astro DB e file di seed.
L'helper `defineDbIntegration()` fornisce supporto TypeScript e autocompletamento per l'hook `astro:db:setup`.

```js {8-13}
// my-integration/index.ts
import { defineDbIntegration } from '@astrojs/db/utils';

export default function MyIntegration() {
  return defineDbIntegration({
    name: 'my-astro-db-powered-integration',
    hooks: {
      'astro:db:setup': ({ extendDb }) => {
        extendDb({
          configEntrypoint: '@astronaut/my-package/config',
          seedEntrypoint: '@astronaut/my-package/seed',
        });
      },
      // Altri hook di integrazione...
    },
  });
}
```

I file di [configurazione](#definisci-il-tuo-database) e [seed](#popola-il-tuo-database) delle integrazioni seguono lo stesso formato dei loro equivalenti definiti dall'utente.

### Operazioni tipizzate nelle integrazioni

Lavorando sulle integrazioni, potresti non essere in grado di beneficiare dei tipi di tabella generati da Astro esportati da `astro:db`.
Per la piena sicurezza dei tipi, usa l'utilità `asDrizzleTable()` per creare un oggetto di riferimento della tabella che puoi usare per le operazioni sul database.

Ad esempio, data un'integrazione che configura la seguente tabella del database `Pets`:

```js
// my-integration/config.ts
import { defineDb, defineTable, column } from 'astro:db';

export const Pets = defineTable({
  columns: {
    name: column.text(),
    species: column.text(),
  },
});

export default defineDb({ tables: { Pets } });
```

Il file seed può importare `Pets` e usare `asDrizzleTable()` per inserire righe nella tua tabella con il controllo dei tipi:

```js {2,7} /typeSafePets(?! )/
// my-integration/seed.ts
import { asDrizzleTable } from '@astrojs/db/utils';
import { db } from 'astro:db';
import { Pets } from './config';

export default async function() {
  const typeSafePets = asDrizzleTable('Pets', Pets);

  await db.insert(typeSafePets).values([
    { name: 'Palomita', species: 'cat' },
    { name: 'Pan', species: 'dog' },
  ]);
}
```

Il valore restituito da `asDrizzleTable('Pets', Pets)` è equivalente a `import { Pets } from 'astro:db'`, ma è disponibile anche quando la generazione dei tipi di Astro non può essere eseguita.
Puoi usarlo in qualsiasi codice di integrazione che necessita di interrogare o inserire nel database.
