---
title: å®éªŒæ€§ sessions
sidebar:
  label: Sessions
i18nReady: true
---

import Since from '~/components/Since.astro';
import ReadMore from '~/components/ReadMore.astro';

<p>

**ç±»å‹ï¼š** `boolean`<br />
**é»˜è®¤å€¼ï¼š** `false`<br />

<Since v="5.1.0" />
</p>

ä¼šè¯ï¼ˆsessionï¼‰æ˜¯ç”¨äºå­˜å‚¨ [æŒ‰éœ€æ¸²æŸ“é¡µé¢](/zh-cn/guides/on-demand-rendering/) åœ¨è¯·æ±‚é—´çš„ç”¨æˆ·çŠ¶æ€ã€‚

è¯¥å®éªŒæ€§åŠŸèƒ½å…è®¸ä½ å­˜å‚¨å’Œè¯»å–è¯¸å¦‚ç™»å½•çŠ¶æ€ã€è´­ç‰©è½¦å†…å®¹ã€æˆ–è€…æ˜¯å…¶ä»–ç”¨æˆ·ç‰¹å®šæ•°æ®ï¼š

```astro title="src/components/CartButton.astro" {3}
---
export const prerender = false; // é€‰ç”¨ 'server' è¾“å‡ºæ—¶æ— éœ€é…ç½®
const cart = await Astro.session.get('cart');
---

<a href="/checkout">ğŸ›’ {cart?.length ?? 0} items</a>
```

ä¼šè¯ä¾èµ–äºä¸€ä¸ª [å¯é…ç½®çš„ä¼šè¯ `driver`](#å¯ç”¨å®éªŒæ€§-sessions) æ¥å°†æ•°æ®å­˜å‚¨åœ¨ `session` å¯¹è±¡ä¸Šã€‚ä¸€ä¸ª [ä¼šè¯ cookie](#sessioncookie) å­˜å‚¨ä¸€ä¸ªè¯†åˆ«ä¼šè¯ IDã€‚

[`session` å¯¹è±¡](#ä¼šè¯-api) å…è®¸ä½ å’Œå­˜å‚¨çš„ç”¨æˆ·çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼šæ·»åŠ ç‰©å“è‡³è´­ç‰©è½¦ï¼‰å’Œä¼šè¯ IDï¼ˆä¾‹å¦‚ï¼šå½“é€€å‡ºç™»å½•æ—¶åˆ é™¤ä¼šè¯ IDï¼‰è¿›è¡Œäº¤äº’ã€‚

## å¯ç”¨å®éªŒæ€§ sessions

è¦å¯ç”¨ä¼šè¯ï¼Œè¯·å°† `experimental.session` æ ‡å¿—è®¾ç½®ä¸º `true`ã€‚ä¼šè¯åªä¼šåœ¨æŒ‰éœ€æ¸²æŸ“çš„é¡µé¢ä¸Šå·¥ä½œï¼Œæ‰€ä»¥ä½ éœ€è¦ [å®‰è£…é€‚é…å™¨](/zh-cn/guides/on-demand-rendering/#æ·»åŠ é€‚é…å™¨) ä»¥æ”¯æŒæŒ‰éœ€æ¸²æŸ“ï¼Œå¹¶ç¡®ä¿æ¯ä¸ªä½¿ç”¨ä¼šè¯çš„é¡µé¢å·²ç»è®¾ç½®ä¸º `prerender: false`ï¼Œæˆ–æ˜¯åœ¨ Astro é…ç½®ä¸­å°† `output` é€‰é¡¹è®¾ç½®ä¸º `server`ã€‚

```js title="astro.config.mjs" ins={6}
  {
    adapter: node({
      mode: "standalone",
    }),
    experimental: {
      session: true,
    },
  }
```

ä¼šè¯éœ€è¦ä¸€ä¸ªå­˜å‚¨é©±åŠ¨æ¥å­˜å‚¨ä¼šè¯æ•°æ®ã€‚Node å’Œ Netlify é€‚é…å™¨ä¼šè‡ªåŠ¨ä¸ºä½ é…ç½®ä¸€ä¸ªé»˜è®¤çš„é©±åŠ¨ï¼Œä½†å…¶ä»–çš„é€‚é…å™¨ç›®å‰ä»éœ€è¦ä½  [æ‰‹åŠ¨æŒ‡å®šé©±åŠ¨](#é…ç½®ä¼šè¯é©±åŠ¨)ã€‚ä½ å¯ä»¥ä½¿ç”¨ [unstorage ä¸Šä»»ä½•æ”¯æŒçš„é©±åŠ¨](https://unstorage.unjs.io/drivers/)ã€‚

### é…ç½®ä¼šè¯é©±åŠ¨

å¦‚æœä½ ç›®å‰æ­£åœ¨ä½¿ç”¨çš„é€‚é…å™¨å¹¶æ²¡æœ‰é»˜è®¤é©±åŠ¨ï¼Œåˆæˆ–è€…ä½ æƒ³é€‰æ‹©ä¸€ä¸ªä¸åŒçš„é©±åŠ¨ï¼Œé‚£ä¹ˆä½ å¯ä»¥ä½¿ç”¨ `session` é…ç½®é€‰é¡¹æ¥å®Œæˆé…ç½®ï¼š

```js title="astro.config.mjs" ins={4}
  {
    adapter: vercel(),
    session: {
      driver: "upstash",
    },
    experimental: {
      session: true,
    },
  }
```

ä½¿ç”¨ä¸ä½ çš„æ‰˜ç®¡å¹³å°æä¾›çš„å­˜å‚¨åŠŸèƒ½ç›¸å¯¹åº”çš„ unstorage `driver` åç§°æ¥é…ç½® `session.driver`ï¼Œä¾‹å¦‚ [Cloudflare KV é©±åŠ¨](https://unstorage.unjs.io/drivers/cloudflare) æˆ–æ˜¯ [Deno KV é©±åŠ¨](https://unstorage.unjs.io/drivers/deno)ã€‚ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨è¯¸å¦‚ [Upstash](https://unstorage.unjs.io/drivers/upstash) æˆ–æ˜¯ [Redis](https://unstorage.unjs.io/drivers/redis) è¿™æ ·è·¨å¹³å°çš„é©±åŠ¨ã€‚

:::note
æŸäº›é©±åŠ¨å¯èƒ½ä¼šéœ€è¦å®‰è£…é¢å¤–çš„åŒ…ã€‚ä¾‹å¦‚ Upstash éœ€è¦å®‰è£… `@upstash/redis` åŒ…ã€‚æŸäº›é©±åŠ¨ç¨‹åºå¯èƒ½è¿˜éœ€è¦è®¾ç½®ç¯å¢ƒå˜é‡æˆ–å‡­æ®ã€‚

<ReadMore>æœ‰å…³æ¯é¡¹é©±åŠ¨çš„æ›´å¤šä¿¡æ¯ï¼ŒåŒ…æ‹¬å…¶ `driver` åç§°ã€é™„åŠ ä¾èµ–é¡¹ã€ä½¿ç”¨æ–¹æ³•ç­‰ï¼Œè¯·å‚é˜… [unstorage é©±åŠ¨æ–‡æ¡£](https://unstorage.unjs.io/drivers)ã€‚</ReadMore>
:::

### é©±åŠ¨é€‰é¡¹

ä½ è¿˜å¯ä»¥å°† `session.options` å•ç‹¬ä»¥å¯¹è±¡çš„å½¢å¼å°†ä»»æ„çš„å¯ç”¨é€‰é¡¹ä¼ å…¥ unstorage é©±åŠ¨ã€‚è¯·å‚é˜…ä½ é€‰å®šé©±åŠ¨çš„æ–‡æ¡£ä»¥è·å–å¯ç”¨é€‰é¡¹ã€‚

ä¸‹é¢çš„ç¤ºä¾‹è®¾ç½®äº†ä¸€ä¸ª `base` å‰ç¼€ï¼ˆ`"sessions"`ï¼‰ï¼Œç”¨äºå‡çº§ Upstash ä¸­çš„æ‰€æœ‰é”®ï¼š

```js title="astro.config.mjs" ins={5-7}
  {
    adapter: vercel(),
    session: {
      driver: "upstash",
      options: {
        base: "sessions",
      },
    },
    experimental: {
      session: true,
    },
  }
```

### å…¶ä»–ä¼šè¯é€‰é¡¹

ä½ å¯ä»¥åœ¨ `session` å¯¹è±¡ä¸­ä¸ºä¼šè¯é…ç½®é¢å¤–é€‰é¡¹ã€‚

#### `session.cookie`

<p>

**ç±»å‹ï¼š** `string` | `object`<br />
**é»˜è®¤å€¼ï¼š** `astro-session`<br />

</p>

ç”¨äºé…ç½®ä¼šè¯ cookie çš„é€‰é¡¹ã€‚ç”Ÿæˆä¼šè¯æ—¶ï¼Œå°†åœ¨å“åº”ä¸­è®¾ç½®æ­¤ cookieã€‚cookie ä¸­æ²¡æœ‰å®é™…çš„ç”¨æˆ·æ•°æ®å­˜å‚¨â€”â€”åªæœ‰ç”¨äºè¯†åˆ«ç”¨æˆ·ä¼šè¯çš„ IDã€‚`session.cookie` é€‰é¡¹å¯ç”¨äºä¸ºæ­¤ cookie è®¾ç½®é€‰é¡¹ã€‚ä½ å¯ä»¥æä¾›ä¸€ä¸ª `string`ï¼Œè¯¥å­—ç¬¦ä¸²å°†ç”¨ä½œ cookie çš„åç§°ï¼Œä¹Ÿå¯ä»¥æä¾›ä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡å¯ç”¨äºé…ç½®å…¶ä»–é¢å¤–é€‰é¡¹ï¼š

```js title="astro.config.mjs" {4} ins={6-9}
  {
    session: {
      // å¦‚æœè®¾ç½®ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œåˆ™ä¼šå°†å…¶ç”¨ä½œ cookie çš„åç§°
      // cookie: "my-session-id",
      // å¦‚æœè®¾ç½®ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œåˆ™å…è®¸é…ç½®é«˜çº§é€‰é¡¹
      cookie: {
        name: "my-session-id"
        sameSite: "Strict",
      },
    }
  }
```

#### `session.ttl`

<p>

**ç±»å‹ï¼š** `number`<br />
**é»˜è®¤å€¼ï¼š** `undefined`<br />

</p>

ä¸€ä¸ªå¯é€‰çš„é»˜è®¤é€‰é¡¹ï¼Œç”¨äºé…ç½®ä¼šè¯å€¼ç›´åˆ°è¿‡æœŸçš„ç”Ÿå­˜æ—¶é—´ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šè¯å€¼ä¼šä¸€ç›´å­˜ç»­ç›´åˆ°å®ƒä»¬è¢«åˆ é™¤æˆ–æ˜¯ä¼šè¯è¢«é”€æ¯ï¼Œå¹¶ä¸”ç”±äºç‰¹å®šçš„æ—¶é—´å·²ç»è¿‡å»ï¼Œå› æ­¤å®ƒä»¬ä¹Ÿä¸ä¼šè‡ªåŠ¨è¿‡æœŸã€‚é€šè¿‡è®¾ç½® `session.ttl` èƒ½ä¸ºä½ çš„ä¼šè¯å€¼æ·»åŠ ä¸€ä¸ªé»˜è®¤çš„è¿‡æœŸæ—¶é—´ã€‚å°† `ttl` é€‰é¡¹ä¼ é€’ç»™ [`session.set()`](#sessionset) å°†è¦†ç›–è¯¥å•ä¸ªæ¡ç›®çš„å…¨å±€é»˜è®¤å€¼ã€‚

```js title="astro.config.mjs" {3}
  {
    session: {
      ttl: 60 * 60, // 1 ä¸ªå°æ—¶
    }
  }
```

:::note
ä¸ºä¼šè¯å€¼è®¾ç½® `ttl` ä¸ä¼šåœ¨æ—¶é—´é™åˆ¶ä¼ å…¥åè‡ªåŠ¨ä»å­˜å‚¨ä¸­å°†å…¶åˆ é™¤ã€‚

å­˜å‚¨ä¸­çš„å€¼åªä¼šåœ¨ `ttl` æ—¶é—´è¿‡æœŸåå°è¯•è®¿é—®å®ƒä»¬æ—¶ï¼Œæ‰ä¼šè¢«åˆ é™¤ã€‚è€Œæ­¤æ—¶ï¼Œä¼šè¯å€¼å°†ä¼šä¸º undefinedï¼Œè€Œç›´åˆ°è¿™æ—¶ä¼šè¯å€¼æ‰ä¼šè¢«åˆ é™¤ã€‚

éƒ¨åˆ†é©±åŠ¨ç¨‹åºåŒæ ·æ”¯æŒ `ttl` é€‰é¡¹ï¼Œè¯¥é€‰é¡¹å°†åœ¨æŒ‡å®šæ—¶é—´åè‡ªåŠ¨åˆ é™¤ä¼šè¯ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…ä½ é€‰å®šé©±åŠ¨çš„æ–‡æ¡£ã€‚
:::

## ä½¿ç”¨ä¼šè¯

é…ç½®å¥½é©±åŠ¨åï¼Œä½ å°±å¯ä»¥ä½¿ç”¨ `session` å¯¹è±¡ä¸ä¼šè¯è¿›è¡Œäº¤äº’äº†ã€‚è¯¥å¯¹è±¡å¯ä½œä¸º `Astro.session` ä» Astro ç»„ä»¶å’Œé¡µé¢ä¸­ä»¥åŠ API ç«¯ç‚¹ã€ä¸­é—´ä»¶å’Œ action ä¸­çš„ `context` å¯¹è±¡ä¸Šè¢«è¯»å–åˆ°ã€‚æ‰€æœ‰æƒ…å†µä¸‹çš„ API éƒ½æ˜¯ç›¸åŒçš„ã€‚

ä¼šè¯å°†åœ¨é¦–æ¬¡ä½¿ç”¨æ—¶è‡ªåŠ¨ç”Ÿæˆï¼Œä¼šè¯ä¹Ÿå¯ä»¥éšæ—¶ä½¿ç”¨ [`Astro.session.regenerate()`](#sessionregenerate) é‡æ–°ç”Ÿæˆï¼Œæˆ–ä½¿ç”¨ [`Astro.session.destroy()`](#sessiondestroy) é”€æ¯ã€‚

åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ åªéœ€ä½¿ç”¨ [`Astro.session.get()`](#sessionget) å’Œ [`Astro.session.set()`](#sessionset)ã€‚æœ‰å…³å…¶ä»–å¯ç”¨æ–¹æ³•ï¼Œè¯·å‚é˜… [API éƒ¨åˆ†](#ä¼šè¯-api)ã€‚

### Astro ç»„ä»¶å’Œé¡µé¢

åœ¨ `.astro` ç»„ä»¶å’Œé¡µé¢ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡å…¨å±€ `Astro` å¯¹è±¡è¯»å–åˆ°ä¼šè¯å¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œè¦æ˜¾ç¤ºè´­ç‰©è½¦ä¸­çš„å•†å“æ•°é‡ï¼š

```astro title="src/components/CartButton.astro" "Astro.session"
---
export const prerender = false; // é€‰ç”¨ 'server' è¾“å‡ºæ—¶æ— éœ€é…ç½®
const cart = await Astro.session.get('cart');
---

<a href="/checkout">ğŸ›’ {cart?.length ?? 0} items</a>
```

### API ç«¯ç‚¹

åœ¨ API ç«¯ç‚¹ä¸­ï¼Œä¼šè¯å¯¹è±¡åœ¨ `context` å¯¹è±¡ä¸­å¯ç”¨ã€‚ä¾‹å¦‚ï¼Œè¦å‘è´­ç‰©è½¦ä¸­æ·»åŠ ä¸€ä»¶å•†å“ï¼š

```ts title="src/pages/api/addToCart.ts" "context.session"
import type { APIContext } from 'astro';

export async function POST(req: Request, context: APIContext) {
  const cart = await context.session.get('cart');
  cart.push(req.body.item);
  await context.session.set('cart', cart);
  return Response.json(cart);
}
```

### Actions

åœ¨ action ä¸­ï¼Œä¼šè¯å¯¹è±¡åœ¨ `context` å¯¹è±¡ä¸­å¯ç”¨ã€‚ä¾‹å¦‚ï¼Œè¦å‘è´­ç‰©è½¦ä¸­æ·»åŠ ä¸€ä»¶å•†å“ï¼š

```ts title="src/actions/addToCart.ts" "context.session"
import { defineAction } from 'astro:actions';
import { z } from 'astro:schema';

export const server = {
  addToCart: defineAction({
    input: z.object({ productId: z.string() }),
    handler: async (input, context) => {
      const cart = await context.session.get('cart');
      cart.push(input.productId);
      await context.session.set('cart', cart);
      return cart;
    },
  }),
};
```

### ä¸­é—´ä»¶

:::note
edge middleware ç›®å‰æš‚ä¸æ”¯æŒä¼šè¯ã€‚
:::

åœ¨ä¸­é—´ä»¶ä¸­ï¼Œä¼šè¯å¯¹è±¡åœ¨ `context` å¯¹è±¡ä¸­å¯ç”¨ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¼šè¯ä¸­è®¾ç½®æœ€åè®¿é—®çš„æ—¶é—´ï¼š

```ts title="src/middleware.ts" "context.session"
import { defineMiddleware } from 'astro:middleware';

export const onRequest = defineMiddleware(async (context, next) => {
  context.session.set('lastVisit', new Date());
  return next();
});
```

### ä¼šè¯æ•°æ®ç±»å‹

é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šè¯æ•°æ®çš„ç±»å‹æ˜¯æœªè¢«å®šä¹‰çš„ï¼Œä½ å¯ä»¥å°†ä»»æ„æ•°æ®å­˜å‚¨åœ¨ä»»ä½• key ä¸­ã€‚ä½¿ç”¨ [devalue](https://github.com/Rich-Harris/devalue) å¯¹å€¼è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œè¯¥åº“ä¸ content layer å’Œ action ä½¿ç”¨çš„åº“ç›¸åŒã€‚è¿™æ„å‘³ç€æ”¯æŒçš„ç±»å‹æ˜¯ç›¸åŒçš„ï¼ŒåŒ…æ‹¬å­—ç¬¦ä¸²ã€æ•°å­—ã€`Date`ã€`Map`ã€`Set`ã€`URL`ã€æ•°ç»„å’Œç®€å•å¯¹è±¡ã€‚

ä½ å¯ä»¥é€šè¿‡åˆ›å»º `src/env.d.ts` æ–‡ä»¶å¹¶ä¸º `App.SessionData` æ·»åŠ ç±»å‹ï¼Œæ¥é€‰æ‹©æ€§åœ°ä¸ºä½ çš„ä¼šè¯æ•°æ®å®šä¹‰ TypeScript ç±»å‹ï¼š

```ts title="src/env.d.ts"
declare namespace App {
  interface SessionData {
    user: {
      id: string;
      name: string;
    };
    cart: string[];
  }
}
```

è¿™å°†ä½¿ä½ å¯ä»¥åœ¨ç¼–è¾‘å™¨ä¸­è®¿é—®ä¼šè¯æ•°æ®æ—¶ï¼Œä½¿ç”¨ç±»å‹æ£€æŸ¥å’Œè‡ªåŠ¨è¡¥å…¨ï¼š

```ts title="src/components/CartButton.astro"
---
const cart = await Astro.session.get('cart');
// const cart: string[] | undefined

const something = await Astro.session.get('something');
// const something: any

Astro.session.set('user', { id: 1, name: 'Houston' });
// Error: Argument of type '{ id: number; name: string }' is not assignable to parameter of type '{ id: string; name: string; }'.
---
```

:::caution
è¿™ä»…ç”¨äºç±»å‹æ£€æŸ¥ï¼Œä¸ä¼šå½±å“ä¼šè¯çš„è¿è¡Œæ—¶è¡Œä¸ºã€‚å¦‚æœä½ åœ¨ç”¨æˆ·ä½¿ç”¨ä¼šè¯æ¥å­˜å‚¨æ•°æ®æ—¶æ›´æ”¹äº†ç±»å‹ï¼Œè¯·æ ¼å¤–å°å¿ƒï¼Œå› ä¸ºè¿™å¯èƒ½ä¼šå¯¼è‡´è¿è¡Œæ—¶é”™è¯¯ã€‚
:::

## ä¼šè¯ API

ä¼šè¯å°†åœ¨é¦–æ¬¡è®¿é—®æ—¶è‡ªåŠ¨åˆ›å»ºã€‚ä¼šè¯å¯¹è±¡åœ¨æ‰€æœ‰ Astro ä¸Šä¸‹æ–‡ä¸­éƒ½å¯ç”¨ï¼ŒåŒ…æ‹¬ç»„ä»¶ã€action å’Œ API ç«¯ç‚¹ã€‚åœ¨ç»„ä»¶ä¸­ï¼Œå®ƒæ˜¯é€šè¿‡å…¨å±€ `Astro` å¯¹è±¡æ¥è¯»å–åˆ°çš„ï¼Œåœ¨ action å’Œ API ç«¯ç‚¹ä¸­ï¼Œå®ƒåœ¨ `context` å¯¹è±¡ä¸­å¯ç”¨ã€‚æ‰€æœ‰æƒ…å†µä¸‹çš„ API éƒ½æ˜¯ç›¸åŒçš„ã€‚

### `session.get()` 

<p>

**ç±»å‹ï¼š** `(key: string) => Promise<any>`

</p>

è¿”å›ä¼šè¯ä¸­ç»™å®šé”®çš„å€¼ã€‚å¦‚æœè¯¥é”®ä¸å­˜åœ¨ï¼Œåˆ™è¿”å› `undefined`ã€‚

### `session.set()`

<p>

**ç±»å‹ï¼š** `(key: string, value: any, options?: { ttl: number }) => void`

</p>

è®¾ç½®ä¼šè¯ä¸­ç»™å®šé”®çš„å€¼ã€‚è¯¥å€¼å¯ä»¥æ˜¯ä»»ä½•å¯åºåˆ—åŒ–ç±»å‹ã€‚è¯¥æ–¹æ³•æ˜¯åŒæ­¥çš„ï¼Œè¯¥å€¼å¯ç«‹å³ç”¨äºæ£€ç´¢ï¼Œä½†æ˜¯ç›´åˆ°è¯·æ±‚ç»“æŸä¹‹å‰ï¼Œè¯¥æ–¹æ³•æ‰èƒ½ä¿å­˜åˆ°åç«¯ã€‚

### `session.regenerate()`

<p>

**ç±»å‹ï¼š** `() => void`

</p>

é‡æ–°ç”Ÿæˆä¼šè¯ IDã€‚æœ€ä½³å®è·µæ˜¯åœ¨ç”¨æˆ·ç™»å½•æˆ–å‡çº§æƒé™æ—¶è°ƒç”¨æ­¤æ–¹æ³•ï¼Œä»¥é˜²æ­¢ä¼šè¯å›ºå®šæ”»å‡»ã€‚

### `session.destroy()`

<p>

**ç±»å‹ï¼š** `() => void`

</p>

é”€æ¯ä¼šè¯ï¼Œä»åç«¯åˆ é™¤ cookie å’Œå¯¹è±¡ã€‚å½“ç”¨æˆ·é€€å‡ºç™»å½•æˆ–ä¼šè¯æ— æ•ˆæ—¶åº”è°ƒç”¨æ­¤æ–¹æ³•ã€‚

## å»¶ä¼¸é˜…è¯»

æœ‰å…³æ­¤å®éªŒæ€§ API çš„å®Œæ•´è¯¦ç»†ä¿¡æ¯å’Œåé¦ˆï¼Œè¯·å‚é˜… [ä¼šè¯ RFC](https://github.com/withastro/roadmap/blob/sessions/proposals/0054-sessions.md)ã€‚
