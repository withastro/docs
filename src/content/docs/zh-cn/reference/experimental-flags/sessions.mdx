---
title: å®éªŒæ€§ sessions
sidebar:
  label: Sessions
i18nReady: true
---

import Since from '~/components/Since.astro';
import ReadMore from '~/components/ReadMore.astro';

<p>

**ç±»å‹ï¼š** `SessionConfig`<br />
**é»˜è®¤å€¼ï¼š** `undefined`<br />

<Since v="5.1.0" />
</p>

ä¼šè¯ï¼ˆsessionï¼‰æ˜¯ç”¨äºå­˜å‚¨ [æŒ‰éœ€æ¸²æŸ“é¡µé¢](/zh-cn/guides/on-demand-rendering/) åœ¨è¯·æ±‚é—´çš„ç”¨æˆ·çŠ¶æ€ã€‚

è¯¥å®éªŒæ€§åŠŸèƒ½å…è®¸ä½ å­˜å‚¨å’Œè¯»å–è¯¸å¦‚ç™»å½•çŠ¶æ€ã€è´­ç‰©è½¦å†…å®¹ã€æˆ–è€…æ˜¯å…¶ä»–ç”¨æˆ·ç‰¹å®šæ•°æ®ï¼š

```astro title="src/components/CartButton.astro" {3}
---
export const prerender = false; // åœ¨ 'server' æ¨¡å¼ä¸‹ä¸éœ€è¦
const cart = await Astro.session.get('cart');
---

<a href="/checkout">ğŸ›’ {cart?.length ?? 0} items</a>
```

ä¼šè¯ä¾èµ–äºä¸€ä¸ª [å¯é…ç½®çš„ä¼šè¯ `driver`](#å¯ç”¨å®éªŒæ€§-sessions) æ¥å°†æ•°æ®å­˜å‚¨åœ¨ `session` å¯¹è±¡ä¸Šã€‚ä¸€ä¸ª [ä¼šè¯ cookie](#cookies) å­˜å‚¨ä¸€ä¸ªè¯†åˆ«ä¼šè¯ IDã€‚

[`session` å¯¹è±¡](#ä¼šè¯-api) å…è®¸ä½ å’Œå­˜å‚¨çš„ç”¨æˆ·çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼šæ·»åŠ ç‰©å“è‡³è´­ç‰©è½¦ï¼‰å’Œä¼šè¯ IDï¼ˆä¾‹å¦‚ï¼šå½“é€€å‡ºç™»å½•æ—¶åˆ é™¤ä¼šè¯ IDï¼‰è¿›è¡Œäº¤äº’ã€‚

## å¯ç”¨å®éªŒæ€§ sessions

ç›®å‰ä½äº `experimental.sessions` çš„æ—©æœŸç‰ˆæœ¬ä¸­ï¼ŒAstro çš„å®˜æ–¹æœåŠ¡å™¨é€‚é…å™¨è¿˜å°šæœªæ›´æ–°ä»¥æä¾›åŸºäºå¹³å°é»˜è®¤å­˜å‚¨åŠŸèƒ½çš„é»˜è®¤ä¼šè¯é©±åŠ¨ã€‚åœ¨è¿™äº›é©±åŠ¨å†…ç½®ä¹‹å‰ï¼Œé™¤äº† [æ·»åŠ é€‚é…å™¨](/zh-cn/guides/on-demand-rendering/#æ·»åŠ é€‚é…å™¨) ä¹‹å¤–ï¼Œä½ è¿˜å¿…é¡»åœ¨ `experimental.sessions` é…ç½®å¯¹è±¡ä¸­è‡ªå·±æŒ‡å®š `driver`ã€‚

æ¥ä¸‹æ¥çš„éƒ¨åˆ†å±•ç¤ºäº†æ¯ä¸ªé€‚é…å™¨çš„æ¨èé©±åŠ¨ã€‚ï¼ˆè¿™äº›é©±åŠ¨å°†åœ¨æ­¤åŠŸèƒ½çš„ç¨³å®šç‰ˆæœ¬ä¸­è‡ªåŠ¨ä¸ºä½ é…ç½®ã€‚ï¼‰æˆ–è€…ï¼Œä½ ä¹Ÿå¯ä»¥æŒ‡å®š [unstorage ä¸Šä»»ä½•æ”¯æŒçš„é©±åŠ¨](https://unstorage.unjs.io/drivers/) ã€‚

### ä½¿ç”¨ Node é€‚é…å™¨æ¥é…ç½®ä¼šè¯

Node é€‚é…å™¨ä¸ [æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨](https://unstorage.unjs.io/drivers/fs) ç›¸å…¼å®¹ã€‚è¯·æ³¨æ„ï¼Œè¯¥æ–¹å¼æ— æ³•åœ¨æ— æœåŠ¡å™¨ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œå› ä¸ºå®ƒä»¬æ²¡æœ‰å…±äº«æ–‡ä»¶ç³»ç»Ÿã€‚

```js title="astro.config.mjs" ins={6}
	{
    adapter: node({ mode: 'standalone' }),
		experimental: {
      session: {
        // å¿…éœ€ï¼šunstorage ä¸Šçš„é©±åŠ¨åç§°
        driver: "fs",
      },
    },
	}
```

### ä¸ºå…¶ä»–é€‚é…å™¨é…ç½®ä¼šè¯é©±åŠ¨

é€‰æ‹©ä¸ä½ çš„æ‰˜ç®¡å¹³å°æä¾›çš„å­˜å‚¨åŠŸèƒ½ç›¸å¯¹åº”çš„ [unstorage `driver` åç§°](https://unstorage.unjs.io/drivers/)ï¼Œä¾‹å¦‚ [Netlify Blobs é©±åŠ¨ï¼ˆ`netlify-blobs`ï¼‰](https://unstorage.unjs.io/drivers/netlify)ã€[Cloudflare KV é©±åŠ¨ï¼ˆ`cloudflare-kv-binding`ï¼‰](https://unstorage.unjs.io/drivers/cloudflare) æˆ– [Deno KV é©±åŠ¨ç¨‹åºï¼ˆ`deno-kv`ï¼‰](https://unstorage.unjs.io/drivers/deno)ã€‚ä½ è¿˜å¯ä»¥ä½¿ç”¨è·¨å¹³å°é©±åŠ¨ï¼Œä¾‹å¦‚ [Upstash](https://unstorage.unjs.io/drivers/upstash) æˆ– [Redis](https://unstorage.unjs.io/drivers/redis)ã€‚

:::note
æŸäº›é©±åŠ¨å¯èƒ½ä¼šéœ€è¦å®‰è£…é¢å¤–çš„åŒ…ã€‚ä¾‹å¦‚ `netlify-blobs` é©±åŠ¨éœ€è¦å®‰è£… `@netlify/blobs` åŒ…ï¼Œè€Œ Upstash éœ€è¦å®‰è£… `@upstash/redis` åŒ…ã€‚æŸäº›é©±åŠ¨ç¨‹åºå¯èƒ½è¿˜éœ€è¦è®¾ç½®ç¯å¢ƒå˜é‡æˆ–å‡­æ®ã€‚

<ReadMore>æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [unstorage é©±åŠ¨æ–‡æ¡£](https://unstorage.unjs.io/drivers)ã€‚</ReadMore>
:::

### é©±åŠ¨é€‰é¡¹

ä½ è¿˜å¯ä»¥å°† `session.options` å•ç‹¬ä»¥å¯¹è±¡çš„å½¢å¼å°†ä»»æ„çš„å¯ç”¨é€‰é¡¹ä¼ å…¥ unstorageã€‚ä»¥ä¸‹ç¤ºä¾‹é…ç½®äº† [Netlify Blobs](https://unstorage.unjs.io/drivers/netlify) é©±åŠ¨ï¼ŒåŒæ—¶è¿˜æä¾›äº† `name` å¹¶æŒ‡å®šä¸º `consistency` æ¨¡å¼ï¼š

```js title="astro.config.mjs" ins={7-11}
  {
    adapter: netlify(),
    experimental: {
      session: {
        // unstorage é©±åŠ¨çš„åç§°éµå¾ªçƒ¤ä¸²å‘½åæ³•
        driver: "netlify-blobs",
        options: {
          name: 'astro-sessions',
          // ä¼šè¯éœ€è¦å¼ºä¸€è‡´æ€§
          consistency: 'strong',
        }
      },
    },
  }
```

## ä½¿ç”¨ä¼šè¯

é…ç½®å¥½é©±åŠ¨åï¼Œä½ å°±å¯ä»¥ä½¿ç”¨ `session` å¯¹è±¡ä¸ä¼šè¯è¿›è¡Œäº¤äº’äº†ã€‚è¯¥å¯¹è±¡å¯ä½œä¸º `Astro.session` ä» Astro ç»„ä»¶å’Œé¡µé¢ä¸­ä»¥åŠ API ç«¯ç‚¹ã€ä¸­é—´ä»¶å’Œ action ä¸­çš„ `context` å¯¹è±¡ä¸Šè¢«è¯»å–åˆ°ã€‚æ‰€æœ‰æƒ…å†µä¸‹çš„ API éƒ½æ˜¯ç›¸åŒçš„ã€‚

åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ åªéœ€ä½¿ç”¨ [`Astro.session.get()`](#sessionget) å’Œ [`Astro.session.set()`](#sessionset)ã€‚æœ‰å…³å…¶ä»–å¯ç”¨æ–¹æ³•ï¼Œè¯·å‚é˜… [API éƒ¨åˆ†](#ä¼šè¯-api)ã€‚

### Astro ç»„ä»¶å’Œé¡µé¢

åœ¨ `.astro` ç»„ä»¶å’Œé¡µé¢ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡å…¨å±€ `Astro` å¯¹è±¡è¯»å–åˆ°ä¼šè¯å¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œè¦æ˜¾ç¤ºè´­ç‰©è½¦ä¸­çš„å•†å“æ•°é‡ï¼š

```astro title="src/components/CartButton.astro" "Astro.session"
---
export const prerender = false; // åœ¨ 'server' æ¨¡å¼ä¸‹ä¸éœ€è¦
const cart = await Astro.session.get('cart');
---

<a href="/checkout">ğŸ›’ {cart?.length ?? 0} items</a>
```

### API ç«¯ç‚¹

åœ¨ API ç«¯ç‚¹ä¸­ï¼Œä¼šè¯å¯¹è±¡åœ¨ `context` å¯¹è±¡ä¸­å¯ç”¨ã€‚ä¾‹å¦‚ï¼Œè¦å‘è´­ç‰©è½¦ä¸­æ·»åŠ ä¸€ä»¶å•†å“ï¼š

```ts title="src/pages/api/addToCart.ts" "context.session"
import type { APIContext } from "astro";

export async function POST(req: Request, context: APIContext) {
  const cart = await context.session.get("cart");
  cart.push(req.body.item);
  await context.session.set("cart", cart);
  return Response.json(cart);
}
```

### Actions

åœ¨ action ä¸­ï¼Œä¼šè¯å¯¹è±¡åœ¨ `context` å¯¹è±¡ä¸­å¯ç”¨ã€‚ä¾‹å¦‚ï¼Œè¦å‘è´­ç‰©è½¦ä¸­æ·»åŠ ä¸€ä»¶å•†å“ï¼š

```ts title="src/actions/addToCart.ts" "context.session"
import { defineAction } from "astro:actions";
import { z } from "astro:schema";

export const server = {
  addToCart: defineAction({
    input: z.object({ productId: z.string() }),
    handler: async (input, context) => {
      const cart = await context.session.get("cart");
      cart.push(input.productId);
      await context.session.set("cart", cart);
      return cart;
    },
  }),
};
```

### ä¸­é—´ä»¶

:::note
edge middleware ç›®å‰æš‚ä¸æ”¯æŒä¼šè¯ã€‚
:::

åœ¨ä¸­é—´ä»¶ä¸­ï¼Œä¼šè¯å¯¹è±¡åœ¨ `context` å¯¹è±¡ä¸­å¯ç”¨ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¼šè¯ä¸­è®¾ç½®æœ€åè®¿é—®çš„æ—¶é—´ï¼š

```ts title="src/middleware.ts" "context.session"
import { defineMiddleware } from 'astro:middleware';

export const onRequest = defineMiddleware(async (context, next) => {
  context.session.set('lastVisit', new Date());
  return next();
});
```

## Cookies

é¦–æ¬¡è®¿é—®æ—¶ä¼šç”Ÿæˆä¼šè¯ï¼Œå¹¶åœ¨å“åº”ä¸­è®¾ç½®ä¸€ä¸ªä¼šè¯ ID cookieã€‚Cookie ä¸­ä¸å­˜å‚¨å®é™…çš„ç”¨æˆ·æ•°æ®ï¼Œä»…å­˜å‚¨ç”¨äºè¯†åˆ«ç”¨æˆ·ä¼šè¯çš„ IDã€‚ä¼šè¯å¯ä»¥éšæ—¶ä½¿ç”¨ [`Astro.session.regenerate()`](#sessionregenerate) é‡æ–°ç”Ÿæˆï¼Œæˆ–ä½¿ç”¨ [`Astro.session.destroy()`](#sessiondestroy) é”€æ¯ã€‚

### `session.cookie`

<p>

**ç±»å‹ï¼š** `string` | `object`<br />
**é»˜è®¤å€¼ï¼š** `undefined`<br />

</p>

ä¸€ä¸ªç”¨äºè®¾ç½® cookie é€‰é¡¹çš„å¯é€‰å±æ€§ã€‚å¯ä»¥é€šè¿‡æä¾›ä¸€ä¸ªå­—ç¬¦ä¸²æ¥è‡ªåŠ¨è®¾ç½® `cookie.name` å±æ€§ã€‚è¦é…ç½®å…¶ä»–é€‰é¡¹ï¼Œè¯·æä¾›ä¸€ä¸ªå¯¹è±¡ã€‚

```js title="astro.config.mjs" {5} ins={7-10}
  {
    experimental: {
      session: {
        // å¦‚æœè®¾ç½®ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œåˆ™ä¼šå°†å…¶ç”¨ä½œ cookie name
        // cookie: "my-session-id",
        // å¦‚æœè®¾ç½®ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œåˆ™å…è®¸é…ç½®é«˜çº§é€‰é¡¹
        cookie: {
          name: "my-session-id"
          sameSite: "Strict",
        },
      }
    }
  }
```

## ä¼šè¯ API

ä¼šè¯å¯¹è±¡åœ¨æ‰€æœ‰ Astro ä¸Šä¸‹æ–‡ä¸­éƒ½å¯ç”¨ï¼ŒåŒ…æ‹¬ç»„ä»¶ã€action å’Œ API ç«¯ç‚¹ã€‚åœ¨ç»„ä»¶ä¸­ï¼Œå®ƒæ˜¯é€šè¿‡å…¨å±€ `Astro` å¯¹è±¡æ¥è¯»å–åˆ°çš„ï¼Œåœ¨ action å’Œ API ç«¯ç‚¹ä¸­ï¼Œå®ƒåœ¨ `context` å¯¹è±¡ä¸­å¯ç”¨ã€‚æ‰€æœ‰æƒ…å†µä¸‹çš„ API éƒ½æ˜¯ç›¸åŒçš„ã€‚

ä½¿ç”¨ [devalue](https://github.com/Rich-Harris/devalue) å¯¹å€¼è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œè¯¥åº“ä¸ content layer å’Œ action ä½¿ç”¨çš„åº“ç›¸åŒã€‚è¿™æ„å‘³ç€æ”¯æŒçš„ç±»å‹æ˜¯ç›¸åŒçš„ï¼ŒåŒ…æ‹¬å­—ç¬¦ä¸²ã€æ•°å­—ã€`Date`ã€`Map`ã€`Set`ã€`URL`ã€æ•°ç»„å’Œç®€å•å¯¹è±¡ã€‚

### `session.get()` 

<p>

**ç±»å‹ï¼š** `(key: string) => Promise<any>`
</p>

è¿”å›ä¼šè¯ä¸­ç»™å®šé”®çš„å€¼ã€‚å¦‚æœè¯¥é”®ä¸å­˜åœ¨ï¼Œåˆ™è¿”å› `undefined`ã€‚

### `session.set()`

<p>

**ç±»å‹ï¼š** `(key: string, value: any, options?: { ttl: number }) => void`
</p>

è®¾ç½®ä¼šè¯ä¸­ç»™å®šé”®çš„å€¼ã€‚è¯¥å€¼å¯ä»¥æ˜¯ä»»ä½•å¯åºåˆ—åŒ–ç±»å‹ã€‚

### `session.regenerate()`

<p>

**ç±»å‹ï¼š** `() => void`
</p>

é‡æ–°ç”Ÿæˆä¼šè¯ IDã€‚æœ€ä½³å®è·µæ˜¯åœ¨ç”¨æˆ·ç™»å½•æˆ–å‡çº§æƒé™æ—¶è°ƒç”¨æ­¤æ–¹æ³•ï¼Œä»¥é˜²æ­¢ä¼šè¯å›ºå®šæ”»å‡»ã€‚

### `session.destroy()`

<p>

**ç±»å‹ï¼š** `() => void`
</p>

é”€æ¯ä¼šè¯ï¼Œä»åç«¯åˆ é™¤ cookie å’Œå¯¹è±¡ã€‚å½“ç”¨æˆ·é€€å‡ºç™»å½•æˆ–ä¼šè¯æ— æ•ˆæ—¶åº”è°ƒç”¨æ­¤æ–¹æ³•ã€‚

## å»¶ä¼¸é˜…è¯»

æœ‰å…³æ­¤å®éªŒæ€§ API çš„å®Œæ•´è¯¦ç»†ä¿¡æ¯å’Œåé¦ˆï¼Œè¯·å‚é˜… [ä¼šè¯ RFC](https://github.com/withastro/roadmap/blob/sessions/proposals/0054-sessions.md)ã€‚
