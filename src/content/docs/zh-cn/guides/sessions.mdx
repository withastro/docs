---
title: Sessions
description: å…±äº«æŒ‰éœ€æ¸²æŸ“é¡µé¢åœ¨è¯·æ±‚é—´çš„æ•°æ®ã€‚
i18nReady: true
---

import Since from '~/components/Since.astro';
import ReadMore from '~/components/ReadMore.astro';

<p>
<Since v="5.7.0" />
</p>

ä¼šè¯ï¼ˆsessionï¼‰æ˜¯ç”¨äºå­˜å‚¨ [æŒ‰éœ€æ¸²æŸ“é¡µé¢](/zh-cn/guides/on-demand-rendering/) åœ¨è¯·æ±‚é—´çš„æ•°æ®ã€‚

ä¸åŒäº [`cookies`](/zh-cn/guides/on-demand-rendering/#cookies)ï¼Œå› ä¸ºä¼šè¯å­˜å‚¨åœ¨æœåŠ¡ç«¯ï¼Œæ‰€ä»¥å¯¹äºå­˜å‚¨æ›´å¤§ä½“ç§¯çš„æ•°æ®æˆ–æ˜¯å®‰å…¨é—®é¢˜ï¼Œä½ éƒ½æ— éœ€æ‹…å¿§ã€‚ä¼šè¯å­˜å‚¨é€‚ç”¨äºç”¨æˆ·ä¿¡æ¯ã€è´­ç‰©è½¦å†…å®¹ä»¥åŠè¡¨å•çŠ¶æ€ï¼Œä¸”æ— éœ€å®¢æˆ·ç«¯ JavaScriptï¼š

```astro title="src/components/CartButton.astro" {3}
---
export const prerender = false; // Not needed with 'server' output
const cart = await Astro.session?.get('cart');
---
<a href="/checkout">ğŸ›’ {cart?.length ?? 0} items</a>
```

## é…ç½®ä¼šè¯

ä¼šè¯éœ€è¦ä¸€ä¸ªå­˜å‚¨é©±åŠ¨æ¥å°†ä¼šè¯æ•°æ®ä¿å­˜èµ·æ¥ã€‚[Node](/zh-cn/guides/integrations-guide/node/#sessions)ã€[Cloudflare](/zh-cn/guides/integrations-guide/cloudflare/#sessions) å’Œ [Netlify](/zh-cn/guides/integrations-guide/netlify/#sessions) é€‚é…å™¨éƒ½ä¼šä¸ºä½ è‡ªåŠ¨é…ç½®é»˜è®¤çš„é©±åŠ¨ï¼Œä½†æ˜¯å…¶ä»–çš„é€‚é…å™¨ç›®å‰éœ€è¦ä½  [æ‰‹åŠ¨æŒ‡å®šé©±åŠ¨](/zh-cn/reference/configuration-reference/#sessiondriver)

```js title="astro.config.mjs" ins={4}
  {
    adapter: vercel(),
    session: {
      driver: "redis",
    },
  }
```

<ReadMore>
è¯·å‚é˜… [`session` é…ç½®é€‰é¡¹](/zh-cn/reference/configuration-reference/#session-é€‰é¡¹)ï¼Œä»¥è·å–å…³äºè®¾ç½®å­˜å‚¨é©±åŠ¨å’Œå…¶ä»–å¯é…ç½®é¡¹çš„æ›´å¤šä¿¡æ¯ã€‚
</ReadMore>

## ä½¿ç”¨ä¼šè¯æ•°æ®

[`session` å¯¹è±¡](/zh-cn/reference/api-reference/#session) å…è®¸ä½ ä¸å­˜å‚¨çš„ç”¨æˆ·çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼Œå‘è´­ç‰©è½¦ä¸­æ·»åŠ å•†å“ï¼‰å’Œä¼šè¯ IDï¼ˆä¾‹å¦‚ï¼Œå½“é€€å‡ºç™»å½•æ—¶ï¼Œåˆ é™¤ä¼šè¯ ID cookieï¼‰è¿›è¡Œäº¤äº’ã€‚è¯¥å¯¹è±¡å¯ä»¥åœ¨ä½ çš„ Astro ç»„ä»¶ä¸­ä½œä¸º `Astro.session` è¢«è®¿é—®åˆ°ï¼Œè€Œåœ¨é¡µé¢çš„ API ç«¯ç‚¹ã€ä¸­é—´ä»¶å’Œ action ä¸­ï¼Œåˆ™ä½œä¸º `context.session` å¯¹è±¡è¢«è®¿é—®ã€‚

ä¼šè¯å°†åœ¨é¦–æ¬¡ä½¿ç”¨æ—¶è‡ªåŠ¨ç”Ÿæˆï¼Œä¼šè¯ä¹Ÿå¯ä»¥éšæ—¶ä½¿ç”¨ [`Astro.session.regenerate()`](/zh-cn/reference/api-reference/#regenerate) é‡æ–°ç”Ÿæˆï¼Œæˆ–ä½¿ç”¨ [`Astro.session.destroy()`](/zh-cn/reference/api-reference/#destroy) é”€æ¯ã€‚

åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåªéœ€ä½¿ç”¨ [`Astro.session.get()`](/zh-cn/reference/api-reference/#get) å’Œ [`Astro.session.set()`](/zh-cn/reference/api-reference/#set) å³å¯ã€‚

<ReadMore>
æœ‰å…³æ›´å¤šç»†èŠ‚ï¼Œè¯·å‚é˜… [ä¼šè¯çš„ API éƒ¨åˆ†](/zh-cn/reference/api-reference/#session)ã€‚
</ReadMore>

### Astro ç»„ä»¶å’Œé¡µé¢

åœ¨ `.astro` ç»„ä»¶å’Œé¡µé¢ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡å…¨å±€çš„ `Astro` å¯¹è±¡æ¥è®¿é—®ä¼šè¯å¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œæ˜¾ç¤ºè´­ç‰©è½¦ä¸­çš„å•†å“æ•°é‡ï¼š

```astro title="src/components/CartButton.astro" "Astro.session"
---
export const prerender = false; // æ— éœ€ä½¿ç”¨ 'server' è¾“å‡º
const cart = await Astro.session?.get('cart');
---
<a href="/checkout">ğŸ›’ {cart?.length ?? 0} items</a>
```

### API ç«¯ç‚¹

åœ¨ API ç«¯ç‚¹ä¸­ï¼Œä¼šè¯å¯¹è±¡åœ¨ `context` å¯¹è±¡ä¸­å¯ç”¨ã€‚ä¾‹å¦‚ï¼Œå‘è´­ç‰©è½¦ä¸­æ·»åŠ ä¸€ä¸ªå•†å“ï¼š

```ts title="src/pages/api/addToCart.ts" "context.session"
export async function POST(context: APIContext) {
  const cart = await context.session?.get('cart') || [];
	const data = await context.request.json<{ item: string }>();
  if(!data?.item) {
    return new Response('Item is required', { status: 400 });
  }
  cart.push(data.item);
  await context.session?.set('cart', cart);
  return Response.json(cart);
}
```

### Actions

åœ¨ action ä¸­ï¼Œä¼šè¯å¯¹è±¡åœ¨ `context` å¯¹è±¡ä¸­å¯ç”¨ã€‚ä¾‹å¦‚ï¼Œå‘è´­ç‰©è½¦ä¸­æ·»åŠ ä¸€ä¸ªå•†å“ï¼š

```ts title="src/actions/addToCart.ts" "context.session"
import { defineAction } from 'astro:actions';
import { z } from 'astro:schema';

export const server = {
  addToCart: defineAction({
    input: z.object({ productId: z.string() }),
    handler: async (input, context) => {
      const cart = await context.session?.get('cart');
      cart.push(input.productId);
      await context.session?.set('cart', cart);
      return cart;
    },
  }),
};
```

### ä¸­é—´ä»¶

:::note
è¾¹ç¼˜ä¸­é—´ä»¶ï¼ˆedge middlewareï¼‰ç›®å‰æš‚ä¸æ”¯æŒä¼šè¯åŠŸèƒ½ã€‚
:::

åœ¨ä¸­é—´ä»¶ä¸­ï¼Œä¼šè¯å¯¹è±¡åœ¨ `context` å¯¹è±¡ä¸­å¯ç”¨ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¼šè¯ä¸­è®¾ç½®æœ€åè®¿é—®çš„æ—¶é—´ï¼š

```ts title="src/middleware.ts" "context.session"
import { defineMiddleware } from 'astro:middleware';

export const onRequest = defineMiddleware(async (context, next) => {
  context.session?.set('lastVisit', new Date());
  return next();
});
```

## ä¼šè¯æ•°æ®ç±»å‹

é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šè¯æ•°æ®çš„ç±»å‹æ˜¯æœªè¢«å®šä¹‰çš„ï¼Œä½ å¯ä»¥å°†ä»»æ„æ•°æ®å­˜å‚¨åœ¨ä»»ä½• key ä¸­ã€‚ä½¿ç”¨ [devalue](https://github.com/Rich-Harris/devalue) å¯¹å€¼è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œè¯¥åº“ä¸ content layer å’Œ action æ‰€ä½¿ç”¨çš„åº“ç›¸åŒã€‚è¿™æ„å‘³ç€æ”¯æŒçš„ç±»å‹æ˜¯ç›¸åŒçš„ï¼ŒåŒ…æ‹¬å­—ç¬¦ä¸²ã€æ•°å­—ã€`Date`ã€`Map`ã€`Set`ã€`URL`ã€æ•°ç»„å’Œç®€å•å¯¹è±¡ã€‚

ä½ å¯ä»¥é€šè¿‡åˆ›å»º `src/env.d.ts` æ–‡ä»¶å¹¶ä¸º `App.SessionData` æ·»åŠ ç±»å‹ï¼Œæ¥é€‰æ‹©æ€§åœ°ä¸ºä½ çš„ä¼šè¯æ•°æ®å®šä¹‰ TypeScript ç±»å‹ï¼š

```ts title="src/env.d.ts"
declare namespace App {
  interface SessionData {
    user: {
      id: string;
      name: string;
    };
    cart: string[];
  }
}
```

è¿™å°†ä½¿ä½ å¯ä»¥åœ¨ç¼–è¾‘å™¨ä¸­è®¿é—®ä¼šè¯æ•°æ®æ—¶ï¼Œä½¿ç”¨ç±»å‹æ£€æŸ¥å’Œè‡ªåŠ¨è¡¥å…¨ï¼š

```ts title="src/components/CartButton.astro"
---
const cart = await Astro.session?.get('cart');
// const cart: string[] | undefined

const something = await Astro.session?.get('something');
// const something: any

Astro.session?.set('user', { id: 1, name: 'Houston' });
// Error: Argument of type '{ id: number; name: string }' is not assignable to parameter of type '{ id: string; name: string; }'.
---
```

:::caution
è¿™ä»…ç”¨äºç±»å‹æ£€æŸ¥ï¼Œä¸ä¼šå½±å“ä¼šè¯çš„è¿è¡Œæ—¶è¡Œä¸ºã€‚å¦‚æœä½ åœ¨ç”¨æˆ·ä½¿ç”¨ä¼šè¯æ¥å­˜å‚¨æ•°æ®æ—¶æ›´æ”¹äº†ç±»å‹ï¼Œè¯·æ ¼å¤–å°å¿ƒï¼Œå› ä¸ºè¿™å¯èƒ½ä¼šå¯¼è‡´è¿è¡Œæ—¶é”™è¯¯ã€‚
:::
