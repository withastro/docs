---
type: integration
title: '@astrojs/cloudflare'
description: äº†è§£å¦‚ä½•ä½¿ç”¨ @astrojs/cloudflare é€‚é…å™¨æ¥éƒ¨ç½²ä½ çš„ Astro é¡¹ç›®ã€‚
sidebar:
  label: Cloudflare
githubIntegrationURL: 'https://github.com/withastro/astro/tree/main/packages/integrations/cloudflare/'
category: adapter
i18nReady: true
---

import PackageManagerTabs from '~/components/tabs/PackageManagerTabs.astro'
import ReadMore from '~/components/ReadMore.astro';
import Since from '~/components/Since.astro';
import { Tabs, TabItem, Steps } from '@astrojs/starlight/components';

æ­¤é€‚é…å™¨å…è®¸ Astro å°†ä½ çš„ [æŒ‰éœ€æ¸²æŸ“è·¯ç”±åŠå…¶åŠŸèƒ½](/zh-cn/guides/on-demand-rendering/)éƒ¨ç½²åˆ° [Cloudflare](https://www.cloudflare.com/)ï¼ŒåŒ…æ‹¬ [æœåŠ¡å™¨ç¾¤å²›](/zh-cn/guides/server-islands/)ï¼Œ[actions](/zh-cn/guides/actions/) ä»¥åŠ [sessions](/zh-cn/guides/sessions/)ã€‚

å¦‚æœä½ åªæ˜¯å°† Astro ä½œä¸ºé™æ€çš„ç«™ç‚¹æ„å»ºå™¨ï¼Œåˆ™ä¸éœ€è¦é€‚é…å™¨ã€‚

åœ¨æˆ‘ä»¬çš„ [Cloudflare Pages éƒ¨ç½²æŒ‡å—](/zh-cn/guides/deploy/cloudflare/) ä¸­äº†è§£å¦‚ä½•éƒ¨ç½² Astro ç«™ç‚¹ã€‚

## ä¸ºä»€ä¹ˆé€‰æ‹© Astro Cloudflare

Cloudflare çš„ [å¼€å‘è€…å¹³å°](https://developers.cloudflare.com/) ä¸ºç”¨æˆ·æä¾›å­˜å‚¨ã€AI ç­‰èµ„æºæ”¯æŒï¼ŒåŠ©åŠ›å¼€å‘å…¨æ ˆåº”ç”¨ï¼Œå¹¶éƒ¨ç½²è‡³å…¨çƒè¾¹ç¼˜ç½‘ç»œã€‚æ­¤é€‚é…å™¨ä¸“ä¸º Astro é¡¹ç›®è®¾è®¡ï¼Œå¯å°†å…¶æ„å»ºä¸ºç¬¦åˆ Cloudflare éƒ¨ç½²è¦æ±‚çš„æ ¼å¼ã€‚

## å®‰è£…

Astro åŒ…å«äº†ä¸€ä¸ª `astro add` å‘½ä»¤ï¼Œç”¨äºè‡ªåŠ¨è®¾ç½®å®˜æ–¹é›†æˆã€‚å¦‚æœä½ æ„¿æ„ï¼Œå¯ä»¥æ”¹ä¸º [æ‰‹åŠ¨å®‰è£…é›†æˆ](#æ‰‹åŠ¨å®‰è£…)ã€‚

åœ¨ä½ çš„ Astro é¡¹ç›®ä¸­ä½¿ç”¨ `astro add` å‘½ä»¤æ·»åŠ  Cloudflare é€‚é…å™¨ï¼Œä»¥å¯ç”¨æœåŠ¡å™¨ç«¯æ¸²æŸ“ã€‚è¿™å°†å®‰è£… `@astrojs/cloudflare` å¹¶ä¸€æ­¥åˆ°ä½åœ°å¯¹ä½ çš„ `astro.config.mjs` æ–‡ä»¶è¿›è¡Œç›¸åº”çš„æ›´æ”¹ã€‚

<PackageManagerTabs>
  <Fragment slot="npm">
  ```sh
  npx astro add cloudflare
  ```
  </Fragment>
  <Fragment slot="pnpm">
  ```sh
  pnpm astro add cloudflare
  ```
  </Fragment>
  <Fragment slot="yarn">
  ```sh
  yarn astro add cloudflare
  ```
  </Fragment>
</PackageManagerTabs>

ç°åœ¨ï¼Œä½ å¯ä»¥å¯ç”¨ [å¯¹æ¯ä¸ªé¡µé¢çš„æŒ‰éœ€æ¸²æŸ“](/zh-cn/guides/on-demand-rendering/#å¯ç”¨æŒ‰éœ€æ¸²æŸ“)ï¼Œæˆ–è€…å°†ä½ çš„æ„å»ºè¾“å‡ºé…ç½®è®¾ç½®ä¸º `output: 'server'` ä»è€Œ [é»˜è®¤å¯¹æ‰€æœ‰é¡µé¢éƒ½è¿›è¡ŒæœåŠ¡å™¨ç«¯æ¸²æŸ“](/zh-cn/guides/on-demand-rendering/#server-æ¨¡å¼)ã€‚

### æ‰‹åŠ¨å®‰è£…

é¦–å…ˆï¼Œä½¿ç”¨åˆé€‚çš„åŒ…ç®¡ç†å™¨å°† `@astrojs/cloudflare` é€‚é…å™¨æ·»åŠ åˆ°é¡¹ç›®çš„ä¾èµ–é¡¹ä¸­ã€‚

<PackageManagerTabs>
  <Fragment slot="npm">
  ```sh
  npm install @astrojs/cloudflare
  ```
  </Fragment>
  <Fragment slot="pnpm">
  ```sh
  pnpm add @astrojs/cloudflare
  ```
  </Fragment>
  <Fragment slot="yarn">
  ```sh
  yarn add @astrojs/cloudflare
  ```
  </Fragment>
</PackageManagerTabs>

ç„¶åï¼Œå°†é€‚é…å™¨æ·»åŠ åˆ° `astro.config.mjs` æ–‡ä»¶ä¸­ï¼š

```js title="astro.config.mjs" ins={2,5}
import { defineConfig } from 'astro/config';
import cloudflare from '@astrojs/cloudflare';

export default defineConfig({
  adapter: cloudflare(),
});
```

## é€‰é¡¹

Cloudflare é€‚é…å™¨æ¥å—ä»¥ä¸‹é€‰é¡¹ï¼š

### `cloudflareModules`

<p>
**ç±»å‹ï¼š** `boolean`<br />
**é»˜è®¤å€¼ï¼š** `true`
</p>

å¯ç”¨å¯¹ [`.wasm`ã€`.bin` ä»¥åŠ `.txt` æ¨¡å—çš„å¯¼å…¥](#cloudflare-æ¨¡å—å¯¼å…¥)ã€‚

è¯¥åŠŸèƒ½é»˜è®¤å¯ç”¨ã€‚å¦‚æœä½ æƒ³ç¦ç”¨å®ƒï¼Œè®¾ç½® `cloudflareModules` ä¸º `false`ã€‚

### `imageService`

<p>
**ç±»å‹ï¼š** `'passthrough' | 'cloudflare' | 'compile' | 'custom'`<br />
**é»˜è®¤å€¼ï¼š** `'compile'`
</p>

ç¡®å®šé€‚é…å™¨ä½¿ç”¨å“ªä¸ªå›¾åƒæœåŠ¡ã€‚å½“é…ç½®äº†ä¸å…¼å®¹çš„å›¾åƒæœåŠ¡æ—¶ï¼Œé€‚é…å™¨å°†é»˜è®¤ä½¿ç”¨ `compile` æ¨¡å¼ã€‚å¦åˆ™ï¼Œå®ƒå°†ä½¿ç”¨å…¨å±€é…ç½®çš„å›¾åƒæœåŠ¡ï¼š

* **`cloudflare`ï¼š** ä½¿ç”¨ [Cloudflare å›¾åƒè°ƒæ•´](https://developers.cloudflare.com/images/image-resizing/) æœåŠ¡ã€‚
* **`passthrough`ï¼š** ä½¿ç”¨ç°æœ‰çš„ [`noop`](/zh-cn/guides/images/#é…ç½®-no-op-é€ä¼ æœåŠ¡) æœåŠ¡ã€‚
* **`compile`ï¼š** ä½¿ç”¨ Astro çš„é»˜è®¤æœåŠ¡ï¼ˆsharpï¼‰ï¼Œä½†ä»…åœ¨æ„å»ºæ—¶å¯¹é¢„æ¸²æŸ“çš„è·¯ç”±æœ‰æ•ˆã€‚å¯¹æŒ‰éœ€æ¸²æŸ“çš„é¡µé¢ï¼Œæ‰€æœ‰ `astro:assets` åŠŸèƒ½éƒ½å°†è¢«ç¦ç”¨ã€‚
* **`custom`ï¼š** æ€»æ˜¯ä½¿ç”¨åœ¨ [Image é€‰é¡¹](/zh-cn/reference/configuration-reference/#image-é€‰é¡¹) ä¸­é…ç½®çš„å›¾åƒæœåŠ¡ã€‚**æ­¤é€‰é¡¹ä¸ä¼šæ£€æŸ¥é…ç½®çš„å›¾åƒæœåŠ¡æ˜¯å¦åœ¨ Cloudflare çš„ `workerd` è¿è¡Œæ—¶ä¸­å·¥ä½œã€‚**

```js title="astro.config.mjs" ins={6}
import { defineConfig } from "astro/config";
import cloudflare from '@astrojs/cloudflare';

export default defineConfig({
  adapter: cloudflare({
     imageService: 'cloudflare'
  }),
})
```

### `platformProxy`

å†³å®šæ˜¯å¦ä»¥åŠå¦‚ä½•å°† Cloudflare è¿è¡Œæ—¶æ·»åŠ åˆ° `astro dev` ä¸­ã€‚å®ƒåŒ…å«å¯¹æœ¬åœ° `workerd` ç»‘å®šå’Œ Cloudflare ç‰¹å®šå€¼çš„ä»£ç†å’Œæ¨¡æ‹Ÿï¼Œå…è®¸åœ¨ Node.js å¼€å‘è¿‡ç¨‹ä¸­æ¨¡æ‹Ÿè¿è¡Œæ—¶ã€‚é˜…è¯»æ›´å¤šå…³äº [Cloudflare è¿è¡Œæ—¶](#cloudflare-è¿è¡Œæ—¶) çš„ä¿¡æ¯ã€‚

:::note
æ­¤å¤„æä¾›çš„ä»£ç†å°½æœ€å¤§åŠªåŠ›æ¨¡æ‹ŸçœŸå®ç”Ÿäº§ç¯å¢ƒã€‚è™½ç„¶å®ƒä»¬æ—¨åœ¨å°½å¯èƒ½æ¥è¿‘çœŸå®æƒ…å†µï¼Œä½†ä¸¤è€…ä¹‹é—´å¯èƒ½å­˜åœ¨è½»å¾®çš„å·®å¼‚å’Œä¸ä¸€è‡´ã€‚
:::

#### `platformProxy.enabled`
<p>
**ç±»å‹ï¼š** `boolean`<br />
**é»˜è®¤å€¼ï¼š** `true`
</p>

ç”¨äºå†³å®šæ˜¯å¦åœ¨å¼€å‘æ¨¡å¼ä¸‹å¯ç”¨ Cloudflare è¿è¡Œæ—¶ã€‚

#### platformProxy.configPath
<p>
**ç±»å‹ï¼š** `string`<br />
**é»˜è®¤å€¼ï¼š** ``undefined``
</p>

ç”¨äºå®šä¹‰ Wrangler é…ç½®æ–‡ä»¶çš„è·¯å¾„ã€‚å¦‚æœè¯¥é¡¹ç•™ç©ºï¼Œé‚£ä¹ˆå®ƒä¼šåœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹å¯»æ‰¾ `wrangler.toml`ã€`wrangler.json` å’Œ `wrangler.jsonc`ã€‚

#### `platformProxy.environment`
<p>
**ç±»å‹ï¼š** `string`<br />
**é»˜è®¤å€¼ï¼š** `undefined`
</p>

ç”¨äºè®¾ç½®ä½¿ç”¨çš„ [Cloudflare ç¯å¢ƒ](https://developers.cloudflare.com/workers/wrangler/environments/)ã€‚ä½ å¿…é¡»åœ¨ Wrangler é…ç½®æ–‡ä»¶ä¸­é€‰æ‹©ä¸€é¡¹ç¯å¢ƒï¼Œå¦åˆ™å°†ä¼šå¼•å‘é”™è¯¯ã€‚

#### `platformProxy.persist`

<p>
**ç±»å‹ï¼š** `boolean | { path: string }`<br />
**é»˜è®¤å€¼ï¼š** `true`
</p>

ç”¨äºè®¾ç½®æ˜¯å¦åœ¨æœ¬åœ°å­˜å‚¨ç»‘å®šæ•°æ®ï¼Œä»¥åŠå°†ç»‘å®šæ•°æ®å­˜å‚¨åœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä½•å¤„ã€‚

- å¦‚æœè®¾ç½®ä¸º `true`ï¼Œç»‘å®šæ•°æ®ä¼šè¢«å­˜å‚¨åœ¨ `.wrangler/state/v3/`ã€‚è¯¥ä½ç½®ä¸ wrangler çš„é»˜è®¤è®¾ç½®ç›¸åŒã€‚
- å¦‚æœè®¾ç½®ä¸º `false`ï¼Œç»‘å®šæ•°æ®å°†ä¸ä¼šè¢«å­˜å‚¨åœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚
- å¦‚æœè®¾ç½®ä¸º `{ path: string }`ï¼Œç»‘å®šæ•°æ®å°†ä¼šå­˜å‚¨åœ¨æŒ‡å®šçš„è·¯å¾„ä¸‹ã€‚

:::note
`wrangler` çš„ `--persist-to` é€‰é¡¹ä¼šåœ¨åº•å±‚æ·»åŠ ä¸€ä¸ªåä¸º `v3` çš„å­ç›®å½•ï¼Œè€Œ `@astrojs/cloudflare` çš„ `persist` å±æ€§åˆ™ä¸ä¼šã€‚ä¾‹å¦‚ï¼Œè¦é‡ç”¨ä¸è¿è¡Œ `wrangler dev --persist-to ./my-directory` ç›¸åŒçš„ä½ç½®ï¼Œä½ å¿…é¡»æŒ‡å®šï¼š`persist: { path: "./my-directory/v3" }`ã€‚
:::

ä»¥ä¸‹é…ç½®å±•ç¤ºäº†åœ¨è¿è¡Œå¼€å‘æœåŠ¡å™¨æ—¶å¯ç”¨ Cloudflare è¿è¡Œæ—¶çš„ç¤ºä¾‹ï¼Œä»¥åŠä½¿ç”¨ `wrangler.json` é…ç½®æ–‡ä»¶ã€‚å®ƒè¿˜æŒ‡å®šäº†ä¸€ä¸ªè‡ªå®šä¹‰ä½ç½®ï¼Œç”¨äºå°†æ•°æ®æŒä¹…åŒ–åˆ°æ–‡ä»¶ç³»ç»Ÿä¸­ï¼š

```js
import cloudflare from '@astrojs/cloudflare';
import { defineConfig } from 'astro/config';
export default defineConfig({
  adapter: cloudflare({
		platformProxy: {
			enabled: true,
			configPath: 'wrangler.json',
			persist: {
				path: './.cache/wrangler/v3'
			},
		},
	}),
});
```

### `routes.extend`

åœ¨ Cloudflare Workers ä¸­ï¼Œè¯¥é€‰é¡¹ä¸é€‚ç”¨ã€‚è¯·å‚è€ƒ [Cloudflare Workers è·¯ç”±](#cloudflare-workers-è·¯ç”±) ä»¥è·å–æ›´å¤šä¿¡æ¯ã€‚

åœ¨ Cloudflare Pages ä¸­ï¼Œæ­¤é€‰é¡¹å…è®¸ä½ æ·»åŠ æˆ–æ’é™¤è‡ªå®šä¹‰æ¨¡å¼ï¼ˆä¾‹å¦‚ `/fonts/*`ï¼‰åˆ°ç”Ÿæˆçš„ `_routes.json` æ–‡ä»¶ä¸­ï¼Œè¯¥æ–‡ä»¶å†³å®šäº†å“ªäº›è·¯ç”±æ˜¯æŒ‰éœ€ç”Ÿæˆçš„ã€‚å¦‚æœä½ éœ€è¦æ·»åŠ æ— æ³•è‡ªåŠ¨ç”Ÿæˆçš„è·¯ç”±æ¨¡å¼ï¼Œæˆ–æ’é™¤é¢„æ¸²æŸ“çš„è·¯ç”±ï¼Œè¿™ä¼šå¾ˆæœ‰ç”¨ã€‚

å…³äºè‡ªå®šä¹‰è·¯ç”±æ¨¡å¼çš„æ›´å¤šä¿¡æ¯ï¼Œå¯ä»¥åœ¨ [Cloudflare çš„è·¯ç”±æ–‡æ¡£](https://developers.cloudflare.com/pages/functions/routing/#functions-invocation-routes)ä¸­æ‰¾åˆ°ã€‚æŒ‡å®šçš„ä»»ä½•è·¯ç”±éƒ½ä¸ä¼šè‡ªåŠ¨å»é‡ï¼Œå°†ä¼šæŒ‰åŸæ ·æ·»åŠ åˆ°ç°æœ‰è·¯ç”±ä¸­ã€‚

#### `routes.extend.include`

<p>
**ç±»å‹ï¼š** `{ pattern: string }[]`<br />
**é»˜è®¤å€¼ï¼š** `undefined`
</p>

åœ¨ `routes.extend.include` æ•°ç»„ä¸­é…ç½® Cloudflare é€‚é…å™¨æŒ‰éœ€ç”Ÿæˆçš„å…¶ä»–è·¯ç”±ã€‚

#### `routes.extend.exclude`

<p>
**ç±»å‹ï¼š** `{ pattern: string }[]`<br />
**é»˜è®¤å€¼ï¼š** `undefined`
</p>

åœ¨ `routes.extend.exclude` æ•°ç»„ä¸­é…ç½®è¦ä»æŒ‰éœ€æ¸²æŸ“ä¸­æ’é™¤çš„è·¯ç”±ã€‚è¿™äº›è·¯ç”±å°†é¢„å…ˆæ¸²æŸ“å¹¶ä»¥é™æ€æ–¹å¼æä¾›ï¼Œè€Œä¸ä¼šè°ƒç”¨æœåŠ¡ç«¯å‡½æ•°ã€‚æ­¤å¤–ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨è¿™ä¸ªé€‰é¡¹ç›´æ¥æä¾›ä»»ä½•é™æ€èµ„æºï¼ˆä¾‹å¦‚ï¼šå›¾ç‰‡ã€å­—ä½“ã€cssã€jsã€htmlã€txtã€json ç­‰ï¼‰æ–‡ä»¶ï¼Œæ— éœ€é€šè¿‡æœåŠ¡ç«¯å‡½æ•°è·¯ç”±è¯·æ±‚ã€‚

```js title="astro.config.mjs"

export default defineConfig({
  adapter: cloudflare({
    routes: {
      extend: {
        include: [{ pattern: '/static' }], // å°†é¢„æ¸²æŸ“çš„é¡µé¢è·¯ç”±åˆ°æœåŠ¡ç«¯å‡½æ•°ä»¥å®ç°æŒ‰éœ€æ¸²æŸ“
        exclude: [{ pattern: '/pagefind/*' }], // ä½¿ç”¨ Starlight çš„ pagefind æœç´¢ï¼Œè¯¥æœç´¢åœ¨æ„å»ºæ—¶é™æ€ç”Ÿæˆ
      }
    },
  }),
});
```

### `sessionKVBindingName`

<p>
**ç±»å‹ï¼š** `string`<br />
**é»˜è®¤å€¼ï¼š** `SESSION`
<Since v="5.6.0" />
</p>

`sessionKVBindingName` é€‰é¡¹å…è®¸ä½ æŒ‡å®šç”¨äºä¼šè¯å­˜å‚¨çš„ KV ç»‘å®šçš„åç§°ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥é€‰é¡¹ä¼šè¢«è®¾ç½®ä¸º `SESSION`ï¼Œä½†ä½ èƒ½å¤Ÿå°†å…¶æ”¹å˜ä¸ºåŒ¹é…ä½ ä¸ªäºº KV ç»‘å®šçš„åç§°ã€‚æ›´å¤šå†…å®¹è¯·å‚é˜… [Sessions](#sessions)ã€‚

```js title="astro.config.mjs" "MY_SESSION_BINDING"
export default defineConfig({
  adapter: cloudflare({
    sessionKVBindingName: 'MY_SESSION_BINDING',
  }),
});
```

### `workerEntryPoint`

<p>
**ç±»å‹ï¼š** `{ path: string | URL, namedExports: string[] }`<br />
**é»˜è®¤å€¼ï¼š** `{ path: '@astrojs/cloudflare/entrypoints/server.js', namedExports: [] }`<br />
<Since v="12.6.0" pkg="@astrojs/cloudflare"/>
</p>

è¯¥é…ç½®å¯¹è±¡å…è®¸ä½ åœ¨ä½¿ç”¨ `astro build` å‘½ä»¤æ—¶ä¸º Cloudflare Worker æŒ‡å®š [workerEntryPoint](https://developers.cloudflare.com/workers/runtime-apis/bindings/service-bindings/rpc/)ã€‚

ä½ å¯ä»¥é€‰æ‹©æ€§åœ°æŒ‡å®šè‡ªå®šä¹‰æ–‡ä»¶çš„ `path` å’Œ `namedExports`ï¼š

```js title="astro.config.mjs"
import cloudflare from '@astrojs/cloudflare';
import { defineConfig } from 'astro/config';

export default defineConfig({
  adapter: cloudflare({
    workerEntryPoint: {
      path: 'src/worker.ts',
      namedExports: ['MyDurableObject']
    }
  }),
});
```

#### `workerEntryPoint.path`

<p>
**ç±»å‹ï¼š** `string`<br />
**é»˜è®¤å€¼ï¼š** `@astrojs/cloudflare/entrypoints/server.js`
<Since v="12.6.0" pkg="@astrojs/cloudflare" />
</p>

å…¥å£æ–‡ä»¶çš„è·¯å¾„ã€‚åº”ä¸º Astro é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ç›¸å¯¹è·¯å¾„ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œé€‚é…å™¨ä¼šä½¿ç”¨ä¸€ä¸ªé€šç”¨å…¥å£æ–‡ä»¶ï¼Œä»…æ”¯æŒ `fetch` å¤„ç†å™¨ã€‚

å¦‚éœ€æ”¯æŒå…¶ä»– [Cloudflare è°ƒç”¨å¤„ç†å™¨](https://developers.cloudflare.com/workers/observability/logs/workers-logs/#invocation-logs)ï¼Œå¯åˆ›å»ºè‡ªå®šä¹‰å…¥å£æ–‡ä»¶ã€‚è¿™å¯¹äºéœ€è¦ Durable Objectsã€Cloudflare Queuesã€Scheduled Invocations ç­‰åŠŸèƒ½æ—¶éå¸¸æœ‰ç”¨ã€‚

#### `workerEntryPoint.namedExports`

<p>
**ç±»å‹ï¼š** `[]`<br />
**é»˜è®¤å€¼ï¼š** `[]`
<Since v="12.6.0" pkg="@astrojs/cloudflare" />
</p>

ä¸ºå…¥å£æ–‡ä»¶æä¾›é¢å¤–çš„å‘½åå¯¼å‡ºã€‚

å¦‚æœ‰[è‡ªå®šä¹‰å…¥å£æ–‡ä»¶](#åˆ›å»ºè‡ªå®šä¹‰-cloudflare-worker-å…¥å£æ–‡ä»¶)ï¼ˆå¦‚ DurableObjectï¼‰ï¼Œå¯åœ¨æ­¤å¤„æŒ‡å®šå‘½åå¯¼å‡ºã€‚è‹¥æœªæŒ‡å®šï¼Œä»…åŒ…å«é»˜è®¤å¯¼å‡ºã€‚

#### åˆ›å»ºè‡ªå®šä¹‰ Cloudflare Worker å…¥å£æ–‡ä»¶

è‡ªå®šä¹‰å…¥å£æ–‡ä»¶å¿…é¡»å¯¼å‡º `createExports()` å‡½æ•°ï¼Œå¹¶é€šè¿‡ `default` å¯¼å‡ºåŒ…å«æ‰€æœ‰æ‰€éœ€å¤„ç†å™¨ã€‚

ä»¥ä¸‹ç¤ºä¾‹æ³¨å†Œäº† Durable Object å’Œé˜Ÿåˆ—å¤„ç†å™¨ï¼š

```ts title="src/worker.ts"
import type { SSRManifest } from 'astro';
import { App } from 'astro/app';
import { handle } from '@astrojs/cloudflare/handler'
import { DurableObject } from 'cloudflare:workers';

class MyDurableObject extends DurableObject<Env> {
  constructor(ctx: DurableObjectState, env: Env) {
    super(ctx, env)
  }
}

export function createExports(manifest: SSRManifest) {
  const app = new App(manifest);
  return {
    default: {
      async fetch(request, env, ctx) {
        await env.MY_QUEUE.send("log");
        return handle(manifest, app, request, env, ctx);
      },
      async queue(batch, _env) {
        let messages = JSON.stringify(batch.messages);
        console.log(`consumed from our queue: ${messages}`);
      }
    } satisfies ExportedHandler<Env>,
    MyDurableObject: MyDurableObject,
  }
}
```

## Cloudflare è¿è¡Œæ—¶

### ç”¨ä¾‹

Cloudflare è¿è¡Œæ—¶å…è®¸ä½ è®¿é—®ç¯å¢ƒå˜é‡å¹¶ç»‘å®š Cloudflare èµ„æºã€‚

Cloudflare è¿è¡Œæ—¶ä½¿ç”¨åœ¨ `wrangler.toml`/`wrangler.json` é…ç½®æ–‡ä»¶ä¸­æ‰¾åˆ°çš„ç»‘å®šã€‚

ä½ å¯ä»¥ä» `Astro.locals.runtime` ä¸­è®¿é—®ç»‘å®šï¼š

```astro title="src/pages/index.astro"
---
const { env } = Astro.locals.runtime;
---
```

ä½ ä¹Ÿå¯ä»¥é€šè¿‡ `context.locals` ä» API ç«¯ç‚¹è®¿é—®è¿è¡Œæ—¶ï¼š

```js title="src/pages/api/someFile.js"
export function GET(context) {
  const runtime = context.locals.runtime;
  return new Response('Some body');
}
```

è¯·æŸ¥çœ‹ Cloudflare æ–‡æ¡£ä¸­çš„ [æ‰€æœ‰æ”¯æŒçš„ç»‘å®šåˆ—è¡¨](https://developers.cloudflare.com/workers/wrangler/api/#supported-bindings)ã€‚

### ç¯å¢ƒå˜é‡ä¸ç§å¯†ç¯å¢ƒå˜é‡

CloudFlare è¿è¡Œæ—¶å°†ç¯å¢ƒå˜é‡è§†ä¸ºä¸€ç§ç»‘å®šã€‚

ä¾‹å¦‚ï¼Œä½ å¯ä»¥åœ¨ `wrangler.json` ä¸­å¯¹ [ç¯å¢ƒå˜é‡](https://developers.cloudflare.com/workers/configuration/environment-variables/#add-environment-variables-via-wrangler) è¿›è¡Œå¦‚ä¸‹å®šä¹‰ï¼š

```json title="wrangler.json"
{
  "vars" : {
    "MY_VARIABLE": "test"
  }
}
```

ç§å¯†ç¯å¢ƒå˜é‡ï¼ˆSecretsï¼‰æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„ç¯å¢ƒå˜é‡ï¼Œå®ƒå…è®¸ä½ å°†åŠ å¯†çš„æ–‡æœ¬å€¼é™„åŠ è‡³ Cloudflare Workerã€‚ä¸ºç¡®ä¿è®¾ç½®åå…¶å†…å®¹ä¸å¯è§ï¼Œç§å¯†ç¯å¢ƒå˜é‡éœ€é€šè¿‡ä¸“ç”¨æ–¹å¼å®šä¹‰ã€‚

è¦å®šä¹‰ `secrets`ï¼Œè¯·é€šè¿‡ [Wrangler CLI](https://developers.cloudflare.com/workers/wrangler/) æ¥å®Œæˆæ·»åŠ ï¼Œè€Œä¸æ˜¯åœ¨ Wrangler é…ç½®æ–‡ä»¶ä¸­æ·»åŠ ã€‚

```bash
npx wrangler secret put <KEY>
```

è¦ä¸ºæœ¬åœ°å¼€å‘è®¾ç½®ç§å¯†ç¯å¢ƒå˜é‡ï¼Œä½ è¿˜éœ€è¦åœ¨ Astro é¡¹ç›®æ ¹ç›®å½•ä¸­æ·»åŠ ä¸€ä¸ª `.dev.vars` æ–‡ä»¶ï¼š

```ini title=".dev.vars"
DB_PASSWORD=myPassword
```

æ¥ä¸‹æ¥ä½ å°±å¯ä»¥è®¿é—®ç¯å¢ƒå˜é‡ï¼ŒåŒ…æ‹¬ç§å¯†ç¯å¢ƒå˜é‡äº†ï¼Œå®ƒä»¬å¯ä»¥åœ¨ `Astro.locals.runtime` çš„ `env` å¯¹è±¡ä¸­è¢«æ‰¾åˆ°ï¼š

```astro title="src/pages/index.astro"
---
const { env } = Astro.locals.runtime;
const myVariable = env.MY_VARIABLE;
---
```

Cloudflare çš„ç¯å¢ƒå˜é‡å’Œç§å¯†ç¯å¢ƒå˜é‡ä¸ [`astro:env` API](/zh-cn/guides/environment-variables/#ç±»å‹å®‰å…¨çš„ç¯å¢ƒå˜é‡) ç›¸å…¼å®¹ã€‚

### ç±»å‹å®šä¹‰

`wrangler` æä¾›äº†ä¸€ä¸ª `types` å‘½ä»¤æ¥ä¸ºç»‘å®šç”Ÿæˆ TypeScript ç±»å‹ã€‚è¿™å…è®¸ä½ å¯¹æœ¬åœ°å˜é‡è¿›è¡Œç±»å‹å®šä¹‰ï¼Œè€Œæ— éœ€æ‰‹åŠ¨è¾“å…¥å®ƒä»¬ã€‚æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ [Cloudflare æ–‡æ¡£](https://developers.cloudflare.com/workers/wrangler/commands/#types)ã€‚

æ¯æ¬¡æ›´æ”¹é…ç½®æ–‡ä»¶ï¼ˆä¾‹å¦‚ `wrangler.toml`ã€`.dev.vars`ï¼‰æ—¶ï¼Œä½ éœ€è¦è¿è¡Œ `wrangler types`ã€‚

:::note
ä½ å¯ä»¥åˆ›å»ºä¸€ä¸ª pnpm è„šæœ¬æ¥è‡ªåŠ¨åœ¨å…¶ä»–å‘½ä»¤ä¹‹å‰è¿è¡Œ `wrangler types`ã€‚

```json title="package.json"
{
  "scripts": {
    "dev": "wrangler types && astro dev",
    "start": "wrangler types && astro dev",
    "build": "wrangler types && astro check && astro build",
    "preview": "wrangler types && astro preview",
    "astro": "astro"
  }
}
```
:::

ä½ å¯ä»¥ä½¿ç”¨ `Runtime` [æ‰©å±•å…¨å±€ç±»å‹](/zh-cn/guides/typescript/#æ‰©å±•å…¨å±€ç±»å‹) æ¥ä¸º `runtime` å¯¹è±¡æ·»åŠ ç±»å‹ï¼š

```ts title="src/env.d.ts"
type Runtime = import('@astrojs/cloudflare').Runtime<Env>;

declare namespace App {
  interface Locals extends Runtime {
    otherLocals: {
      test: string;
    };
  }
}
```

## Cloudflare å¹³å°

### æ ‡å¤´

ä½ å¯ä»¥é€šè¿‡åœ¨ Astro é¡¹ç›®çš„ `public/` æ–‡ä»¶å¤¹ä¸­æ·»åŠ ä¸€ä¸ª `_headers` æ–‡ä»¶æ¥é™„åŠ  [è‡ªå®šä¹‰æ ‡å¤´](https://developers.cloudflare.com/pages/platform/headers/) åˆ°ä½ çš„å“åº”ä¸­ï¼Œè¯¥æ–‡ä»¶å°†è¢«å¤åˆ¶åˆ°æ„å»ºè¾“å‡ºç›®å½•ä¸­ã€‚

è¯¥æ–¹æ³•ä¹Ÿå¯ä»¥ç”¨äº Cloudflare Workers å’Œ Cloudflare Pages ä¸­ã€‚

### èµ„æº

ç”± Astro æ„å»ºçš„æ‰€æœ‰èµ„æºéƒ½ä»¥å“ˆå¸Œå‘½åï¼Œå› æ­¤å¯ä»¥ä¸ºå®ƒä»¬æ·»åŠ é•¿æœŸç¼“å­˜æ ‡å¤´ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒCloudflare ä¸Šçš„ Astro ä¼šä¸ºè¿™äº›æ–‡ä»¶æ·»åŠ è¿™æ ·çš„å¤´ã€‚

### é‡å®šå‘

ä½ å¯ä»¥å£°æ˜ä¸€ä¸ª [è‡ªå®šä¹‰é‡å®šå‘](https://developers.cloudflare.com/pages/platform/redirects/) ä»è€Œå°†è¯·æ±‚é‡å®šå‘åˆ°ä¸åŒçš„ URLã€‚ä¸ºæ­¤ï¼Œè¯·åœ¨ Astro é¡¹ç›®çš„ `public/` æ–‡ä»¶å¤¹ä¸­æ·»åŠ ä¸€ä¸ª `_redirects` æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†è¢«å¤åˆ¶åˆ°æ„å»ºè¾“å‡ºç›®å½•ã€‚

è¯¥æ–¹æ³•ä¹Ÿå¯ä»¥ç”¨äº Cloudflare Workers å’Œ Cloudflare Pages ä¸­ã€‚

### è·¯ç”±

#### Cloudflare Workers è·¯ç”±

é™æ€èµ„æºçš„è·¯ç”±æ˜¯åŸºäºæ„å»ºç›®å½•ï¼ˆä¾‹å¦‚ `./dist`ï¼‰çš„æ–‡ä»¶ç»“æ„çš„ã€‚å¦‚æœä¸åŒ¹é…ï¼Œå°†ä¼šå›é€€è‡³æŒ‰éœ€æ¸²æŸ“çš„ Workerã€‚æ›´å¤šå†…å®¹è¯¦è§ [Cloudflare Workers é™æ€èµ„æºè·¯ç”±](https://developers.cloudflare.com/workers/static-assets/routing/)ã€‚

ä¸åŒäº [Cloudflare Pages](#cloudflare-pages-è·¯ç”±)ï¼Œä½¿ç”¨ Workers æ—¶ï¼Œæ— éœ€ `_routes.json` æ–‡ä»¶ã€‚

ç›®å‰ï¼ŒCloudflare é€‚é…å™¨å§‹ç»ˆä¼šç”Ÿæˆè¯¥æ–‡ä»¶ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯åœ¨ä½ çš„ `public/` æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ª `.assetsignore` æ–‡ä»¶ï¼Œå¹¶å‘å…¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š
  ```txt title="public/.assetsignore"
  _worker.js
  _routes.json
  ```

#### Cloudflare Pages è·¯ç”±

åœ¨ Cloudflare Pages ä¸­ï¼Œ[è·¯ç”±è§„åˆ™](https://developers.cloudflare.com/pages/platform/functions/routing/#functions-invocation-routes) é€šè¿‡ `_routes.json` æ–‡ä»¶å®šä¹‰ï¼Œç”¨äºå†³å®šå“ªäº›è¯·æ±‚åº”è·¯ç”±è‡³æœåŠ¡ç«¯å‡½æ•°ï¼ˆServer Functionï¼‰å¤„ç†ï¼Œå“ªäº›åº”ä½œä¸ºé™æ€èµ„æºç›´æ¥è¿”å›ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œç³»ç»Ÿä¼šæ ¹æ®é¡¹ç›®æ–‡ä»¶ç»“æ„åŠé…ç½®è‡ªåŠ¨ç”Ÿæˆæ­¤æ–‡ä»¶ã€‚

ä½ å¯ä»¥é€šè¿‡åœ¨é€‚é…å™¨é…ç½®æ–‡ä»¶ä¸­ [æŒ‡å®šé¢å¤–çš„è·¯ç”±è§„åˆ™](#routesextend)ï¼Œæˆ–åˆ›å»ºè‡ªå®šä¹‰çš„ `_routes.json` æ–‡ä»¶æ¥è¦†ç›–è‡ªåŠ¨ç”Ÿæˆçš„ç»“æœã€‚

åˆ›å»ºè‡ªå®šä¹‰çš„ `public/_routes.json` å°†è¦†ç›–è¿™ç§è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶ã€‚å‚é˜… [Cloudflare å…³äºåˆ›å»ºè‡ªå®šä¹‰ `_routes.json` çš„æ–‡æ¡£](https://developers.cloudflare.com/pages/platform/functions/routing/#create-a-_routesjson-file) äº†è§£æ›´å¤šç»†èŠ‚ã€‚

## Sessions

Astro [Session API](/zh-cn/guides/sessions/) å…è®¸ä½ åœ¨è¯·æ±‚é—´ï¼Œè½»æ¾åœ°å­˜å‚¨ç”¨æˆ·æ•°æ®ã€‚è¯¥åŠŸèƒ½å¯ç”¨äºç”¨æˆ·æ•°æ®å’Œåå¥½é€‰é¡¹ï¼Œè´­ç‰©è½¦å†…å®¹ï¼Œèµ„æ ¼é‰´æƒã€‚ä¸åŒäº cookie å­˜å‚¨ï¼Œè¿™é‡Œä¸å­˜åœ¨å¯¹æ•°æ®å¤§å°çš„é™åˆ¶ï¼Œå¹¶ä¸”å¯ä»¥å°†å…¶å­˜å‚¨åœ¨ä¸åŒçš„è®¾å¤‡ä¸Šã€‚

å½“ä½¿ç”¨ Cloudflare é€‚é…å™¨æ—¶ï¼ŒAstro ä¼šè‡ªåŠ¨é…ç½®ç”¨äºä¼šè¯ï¼ˆsessionï¼‰å­˜å‚¨çš„ [Workers KV](https://developers.cloudflare.com/kv/)ã€‚ä½†åœ¨ä½¿ç”¨ä¼šè¯å‰ï¼Œä½ è¿˜éœ€è¦åˆ›å»ºä¸€ä¸ª KV å‘½åç©ºé—´æ¥å­˜å‚¨æ•°æ®å¹¶åœ¨ä½ çš„ Wrangler é…ç½®æ–‡ä»¶ä¸­å¯¹ KV ç»‘å®šè¿›è¡Œé…ç½®ã€‚é»˜è®¤ç»‘å®šåéœ€ä¸º `SESSION`ï¼Œè‹¥éœ€è‡ªå®šä¹‰åç§°ï¼Œè¯·é€šè¿‡é€‚é…å™¨é…ç½®æ–‡ä»¶ä¸­çš„ [`sessionKVBindingName`](#sessionkvbindingname) é€‰é¡¹æ¥æŒ‡å®šã€‚

<Steps>

1. ä½¿ç”¨ Wrangler CLI åˆ›å»ºä¸€ä¸ª KV å‘½åç©ºé—´å¹¶è®°å½•ä¸‹æ–°å‘½åç©ºé—´çš„ IDï¼š

   ```sh
   npx wrangler kv namespace create "SESSION"
   ```

2. åœ¨ä½ çš„ Wrangler é…ç½®æ–‡ä»¶ä¸­ï¼Œå£°æ˜ KV å‘½åç©ºé—´ï¼ŒID æ˜¯è¿è¡Œä¸Šä¸€ä¸ªå‘½ä»¤æ—¶æ‰€è¿”å›çš„å†…å®¹ï¼š

    <Tabs>
      <TabItem label="wrangler.json">
        ```json title="wrangler.json" "<KV_NAMESPACE_ID>"
        {
          "kv_namespaces": [
            {
              "binding": "SESSION",
              "id": "<KV_NAMESPACE_ID>"
            }
          ]
        }
        ```
      </TabItem>
      <TabItem label="wrangler.toml">
        ```toml title="wrangler.toml" "<KV_NAMESPACE_ID>"
        kv_namespaces = [
          { binding = "SESSION", id = "<KV_NAMESPACE_ID>" }
        ]
        ```
      </TabItem>
    </Tabs>

3. æ¥ä¸‹æ¥ä½ å°±å¯ä»¥åœ¨ä½ çš„æœåŠ¡å™¨ä»£ç ä¸­ä½¿ç”¨ä¼šè¯äº†ï¼š

    ```astro title="src/components/CartButton.astro" "Astro.session?.get('cart')"
    ---
    export const prerender = false;
    const cart = await Astro.session?.get('cart');
    ---
    <a href="/checkout">ğŸ›’ {cart?.length ?? 0} items</a>
    ```

</Steps>

:::note
å¯¹ Cloudflare KV çš„å†™å…¥æ“ä½œåœ¨è·¨åŒºåŸŸæ—¶éµå¾ª [æœ€ç»ˆä¸€è‡´æ€§åŸåˆ™](https://developers.cloudflare.com/kv/concepts/how-kv-works/#consistency)ã€‚è¿™æ„å‘³ç€ï¼šåœ¨åŒä¸€åŒºåŸŸå†…ï¼Œæ•°æ®å˜æ›´ä¼šç«‹å³ç”Ÿæ•ˆï¼Œè€Œè·¨åŒºåŸŸåŒæ­¥çš„å˜æ›´å¯èƒ½éœ€è¦æœ€å¤š 60 ç§’æ‰èƒ½å®Œæˆå…¨çƒèŠ‚ç‚¹åŒæ­¥ã€‚è¿™å¯¹å¤§å¤šæ•°ç”¨æˆ·æ¥è¯´æ˜¯æ— æ„Ÿçš„ï¼Œå› ä¸ºå¸¸è§„ç”¨æˆ·ä¸ä¼šåœ¨è¿ç»­è¯·æ±‚é—´åˆ‡æ¢åœ°ç†åŒºåŸŸï¼Œä½†æ˜¯ä»æœ‰éƒ¨åˆ†ç”¨ä¾‹ä¼šå—å½±å“ï¼Œä¾‹å¦‚é‚£äº› VPN ç”¨æˆ·ã€‚
:::

## Cloudflare æ¨¡å—å¯¼å…¥

Cloudflare `workerd` è¿è¡Œæ—¶æ”¯æŒå¯¼å…¥ä¸€äº› [éæ ‡å‡†æ¨¡å—ç±»å‹](https://developers.cloudflare.com/workers/wrangler/bundling/#including-non-javascript-modules)ã€‚å¤§å¤šæ•°é¢å¤–çš„æ–‡ä»¶ç±»å‹åœ¨ Astro ä¸­ä¹Ÿæ˜¯å¯ç”¨çš„ï¼š

- `.wasm` æˆ– `.wasm?module`ï¼šå¯¼å‡ºä¸€ä¸ªå¯ä»¥å®ä¾‹åŒ–çš„ [`WebAssembly.Module`](https://developer.mozilla.org/zh-CN/docs/WebAssembly/JavaScript_interface/Module)
- `.bin`ï¼šå¯¼å‡ºæ–‡ä»¶çš„åŸå§‹äºŒè¿›åˆ¶å†…å®¹ï¼Œç±»å‹ä¸º [`ArrayBuffer`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer)
- `.txt`ï¼šå¯¼å‡ºæ–‡ä»¶å†…å®¹çš„å­—ç¬¦ä¸²å½¢å¼

æ‰€æœ‰æ¨¡å—ç±»å‹éƒ½å¯¼å‡ºä¸€ä¸ªé»˜è®¤å€¼ã€‚æ¨¡å—æ—¢å¯ä»¥ä»æœåŠ¡å™¨ç«¯æ¸²æŸ“çš„é¡µé¢å¯¼å…¥ï¼Œä¹Ÿå¯ä»¥ä»é¢„æ¸²æŸ“çš„é¡µé¢å¯¼å…¥ï¼Œä»¥ç”Ÿæˆé™æ€ç«™ç‚¹ã€‚

ä»¥ä¸‹æ˜¯å¯¼å…¥ä¸€ä¸ª Wasm æ¨¡å—çš„ç¤ºä¾‹ï¼Œè¯¥æ¨¡å—é€šè¿‡å°†è¯·æ±‚çš„æ•°å­—å‚æ•°ç›¸åŠ æ¥å“åº”è¯·æ±‚ï¼š

```js title="pages/add/[a]/[b].js"
// å¯¼å…¥ WebAssembly æ¨¡å—
import mod from '../util/add.wasm?module';

// å…ˆå®ä¾‹åŒ–æ‰èƒ½ä½¿ç”¨
const addModule: any = new WebAssembly.Instance(mod);

export async function GET(context) {
  const a = Number.parseInt(context.params.a);
  const b = Number.parseInt(context.params.b);
  return new Response(`${addModule.exports.add(a, b)}`);
}
```

è™½ç„¶è¿™ä¸ªä¾‹å­å¾ˆç®€å•ï¼Œä½†æ˜¯ Wasm å¯ä»¥ç”¨æ¥åŠ é€Ÿåœ¨ä¸æ¶‰åŠå¤§é‡ I/O çš„æƒ…å†µä¸‹çš„è®¡ç®—å¯†é›†å‹æ“ä½œï¼Œæ¯”å¦‚åµŒå…¥å›¾åƒå¤„ç†åº“ï¼Œæˆ–åµŒå…¥å°å‹é¢„ç´¢å¼•æ•°æ®åº“ä»¥åœ¨åªè¯»æ•°æ®é›†ä¸Šè¿›è¡Œæœç´¢ã€‚

## Node.js å…¼å®¹æ€§

é»˜è®¤æƒ…å†µä¸‹ï¼ŒCloudflare ä¸æ”¯æŒ Node.js è¿è¡Œæ—¶ APIã€‚ä½†é€šè¿‡ä¸€äº›é…ç½®ï¼ŒCloudflare å¯ä»¥æ”¯æŒ Node.js è¿è¡Œæ—¶ API çš„ä¸€ä¸ªå­é›†ã€‚ä½ å¯ä»¥åœ¨ Cloudflare çš„[æ–‡æ¡£](https://developers.cloudflare.com/workers/runtime-apis/nodejs)ä¸­æ‰¾åˆ°æ”¯æŒçš„ Node.js è¿è¡Œæ—¶ APIã€‚

å¦‚æœè¦ä½¿ç”¨è¿™äº› APIï¼Œä½ çš„é¡µé¢æˆ–ç«¯ç‚¹å¿…é¡»æ˜¯æœåŠ¡å™¨æ¸²æŸ“çš„ï¼ˆè€Œä¸æ˜¯é¢„æ¸²æŸ“çš„ï¼‰ï¼Œå¹¶ä½¿ç”¨ `import {} from 'node:*'` å¯¼å…¥è¯­æ³•ã€‚

```js title="pages/api/endpoint.js"
export const prerender = false;
import { Buffer } from 'node:buffer';
```

ä½ è¿˜éœ€è¦ä¿®æ”¹ä½ çš„ Astro é…ç½®ä¸­çš„ `vite` é…ç½®ï¼Œä»¥å…è®¸ä½¿ç”¨ `node:*` å¯¼å…¥è¯­æ³•ï¼š

```js title="astro.config.mjs" ins={6-10}
import { defineConfig } from "astro/config";
import cloudflare from '@astrojs/cloudflare';

export default defineConfig({
  adapter: cloudflare({}),
  vite: {
		ssr: {
			external: ['node:buffer'],
		},
	},
})
```

æ­¤å¤–ï¼Œä½ è¿˜éœ€è¦éµå¾ª Cloudflare çš„æ–‡æ¡£æ¥å¯ç”¨æ”¯æŒã€‚å…·ä½“æŒ‡å¯¼ï¼Œè¯·å‚è€ƒ [Cloudflare å…³äºå¯ç”¨ Node.js å…¼å®¹æ€§çš„æ–‡æ¡£](https://developers.cloudflare.com/workers/runtime-apis/nodejs/)ã€‚

:::note[åŒ…å…¼å®¹æ€§çš„å½±å“]
å¦‚æœä¸€ä¸ªé¡¹ç›®å°†ä¸€ä¸ªåŒ…å¯¼å…¥åˆ°æœåŠ¡å™¨ä¸­ï¼Œè€Œè¯¥åŒ…ä½¿ç”¨äº† Node.js è¿è¡Œæ—¶ APIï¼Œè¿™åœ¨éƒ¨ç½²åˆ° Cloudflare æ—¶å¯èƒ½ä¼šå¼•èµ·é—®é¢˜ã€‚è¿™ä¸ªé—®é¢˜å‡ºç°åœ¨ä¸ä½¿ç”¨ `node:*` å¯¼å…¥è¯­æ³•çš„åŒ…ä¸Šã€‚å»ºè®®ä½ è”ç³»åŒ…çš„ä½œè€…ï¼Œä»¥ç¡®å®šè¯¥åŒ…æ˜¯å¦æ”¯æŒä¸Šè¿°å¯¼å…¥è¯­æ³•ã€‚å¦‚æœè¯¥åŒ…ä¸æ”¯æŒè¿™ç§è¯­æ³•ï¼Œä½ å¯èƒ½éœ€è¦ä½¿ç”¨å¦ä¸€ä¸ªåŒ…ã€‚
:::

## ä½¿ç”¨ Wrangler é¢„è§ˆ

ä¸ºäº†ä½¿ç”¨ [`wrangler`](https://developers.cloudflare.com/workers/wrangler/) åœ¨æœ¬åœ°è¿è¡Œä½ çš„åº”ç”¨ç¨‹åºï¼Œè¯·æ›´æ–°é¢„è§ˆè„šæœ¬ï¼š

å¯¹äº Workersï¼š

```json title="package.json"
"preview": "wrangler dev ./dist"
```

å¯¹äº Pagesï¼š

```json title="package.json"
"preview": "wrangler pages dev ./dist"
```

ä½¿ç”¨ [`wrangler`](https://developers.cloudflare.com/workers/wrangler/) éƒ¨ç½²èƒ½è®©ä½ è®¿é—® [Cloudflare ç»‘å®š](https://developers.cloudflare.com/pages/platform/functions/bindings)ã€[ç¯å¢ƒå˜é‡](https://developers.cloudflare.com/pages/platform/functions/bindings/#environment-variables) å’Œ [cf å¯¹è±¡](https://developers.cloudflare.com/workers/runtime-apis/request/#incomingrequestcfproperties)ã€‚è¦è®©çƒ­é‡è½½æˆ– Astro å¼€å‘æœåŠ¡å™¨ä¸ Wrangler å·¥ä½œï¼Œå¯èƒ½éœ€è¦è¿›è¡Œè‡ªå®šä¹‰è®¾ç½®ã€‚è¯·å‚é˜… [ç¤¾åŒºç¤ºä¾‹](https://github.com/withastro/roadmap/discussions/590)ã€‚

### æœ‰æ„ä¹‰çš„é”™è¯¯æ¶ˆæ¯

ç›®å‰ï¼Œåœ¨ Wrangler ä¸­è¿è¡Œåº”ç”¨ç¨‹åºæ—¶ç”±äºä»£ç è¢«å‹ç¼©ï¼Œé”™è¯¯æ¶ˆæ¯å¹¶ä¸æ˜¯å¾ˆæœ‰ç”¨ã€‚ä¸ºäº†æ›´å¥½åœ°è¿›è¡Œè°ƒè¯•ï¼Œä½ å¯ä»¥å°† `vite.build.minify = false` æ·»åŠ åˆ°ä½ çš„ `astro.config.js` æ–‡ä»¶ä¸­ã€‚

```js title="astro.config.mjs" ins={3-7}
export default defineConfig({
  adapter: cloudflare(),
  vite: {
    build: {
      minify: false,
    },
  },
});
```

[astro-integration]: /zh-cn/guides/integrations-guide/
